<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 🔄 Cache Buster - Force Reload -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Monopoly Game v3.2 (Bigger Board + End Turn)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media (max-width: 900px) {
            /* ...existing mobile styles... */
            #mobile-controls-bar {
                display: none;
            }
            #game-container.active {
                min-height: 100vh;
                height: 100vh;
            }
            #game-log {
                font-size: 1.1rem;
                background: rgba(255,255,255,0.95);
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 40;
                max-height: 80px;
                overflow-y: auto;
                border-top: 2px solid #e5e7eb;
                padding: 8px 12px;
                margin-bottom: 120px;
            }
        }
        
        #controls-bar {
            flex-direction: column;
            gap: 8px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            z-index: 50;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            padding: 8px 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            overflow-y: auto;
            background: linear-gradient(135deg, #1a5f3f 0%, #2d8659 50%, #1a5f3f 100%);
            background-attachment: fixed;
        }
        .board {
            display: grid;
            grid-template-columns: 260px repeat(18, 400px) 260px;
            grid-template-rows: 260px repeat(18, 400px) 260px;
            gap: 3px;
            width: 98vmin;
            height: 98vmin;
            max-width: 1400px;
            max-height: 1400px;
            margin: auto;
            border: 8px solid #1a5f3f;
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d4ba 50%, #f5e6d3 100%);
            box-shadow: 0 25px 80px rgba(0,0,0,0.4), inset 0 0 30px rgba(255,255,255,0.3);
            border-radius: 12px;
            position: relative;
        }
        .board::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: linear-gradient(135deg, #c9a66b 0%, #8b6f47 50%, #c9a66b 100%);
            border-radius: 12px;
            z-index: -1;
        }
        .space {
            border: 2px solid #2d3748;
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            text-align: center;
            padding: 4px;
            overflow: hidden;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        .space:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 5;
        }
        .corner { grid-column: span 1; grid-row: span 1; }
        .top-row { grid-column: span 1; grid-row: 1; }
        .bottom-row { grid-column: span 1; grid-row: 11; }
        .left-col { grid-column: 1; grid-row: span 1; }
        .right-col { grid-column: 11; grid-row: span 1; }

        #space-0 { grid-column: 11; grid-row: 11; }
        #space-1 { grid-column: 10; grid-row: 11; }
        #space-2 { grid-column: 9; grid-row: 11; }
        #space-3 { grid-column: 8; grid-row: 11; }
        #space-4 { grid-column: 7; grid-row: 11; }
        #space-5 { grid-column: 6; grid-row: 11; }
        #space-6 { grid-column: 5; grid-row: 11; }
        #space-7 { grid-column: 4; grid-row: 11; }
        #space-8 { grid-column: 3; grid-row: 11; }
        #space-9 { grid-column: 2; grid-row: 11; }
        #space-10 { grid-column: 1; grid-row: 11; }
        #space-11 { grid-column: 1; grid-row: 10; }
        #space-12 { grid-column: 1; grid-row: 9; }
        #space-13 { grid-column: 1; grid-row: 8; }
        #space-14 { grid-column: 1; grid-row: 7; }
        #space-15 { grid-column: 1; grid-row: 6; }
        #space-16 { grid-column: 1; grid-row: 5; }
        #space-17 { grid-column: 1; grid-row: 4; }
        #space-18 { grid-column: 1; grid-row: 3; }
        #space-19 { grid-column: 1; grid-row: 2; }
        #space-20 { grid-column: 1; grid-row: 1; }
        #space-21 { grid-column: 2; grid-row: 1; }
        #space-22 { grid-column: 3; grid-row: 1; }
        #space-23 { grid-column: 4; grid-row: 1; }
        #space-24 { grid-column: 5; grid-row: 1; }
        #space-25 { grid-column: 6; grid-row: 1; }
        #space-26 { grid-column: 7; grid-row: 1; }
        #space-27 { grid-column: 8; grid-row: 1; }
        #space-28 { grid-column: 9; grid-row: 1; }
        #space-29 { grid-column: 10; grid-row: 1; }
        #space-30 { grid-column: 11; grid-row: 1; }
        #space-31 { grid-column: 11; grid-row: 2; }
        #space-32 { grid-column: 11; grid-row: 3; }
        #space-33 { grid-column: 11; grid-row: 4; }
        #space-34 { grid-column: 11; grid-row: 5; }
        #space-35 { grid-column: 11; grid-row: 6; }
        #space-36 { grid-column: 11; grid-row: 7; }
        #space-37 { grid-column: 11; grid-row: 8; }
        #space-38 { grid-column: 11; grid-row: 9; }
        #space-39 { grid-column: 11; grid-row: 10; }
        
        .center-board {
            grid-column: 2 / 11;
            grid-row: 2 / 11;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 3px solid #2d3748;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        .color-bar {
            width: 100%;
            height: 22%;
            border-bottom: 2px solid #2d3748;
            border-radius: 4px 4px 0 0;
        }
        .player-piece {
            position: absolute;
            width: 72px;
            height: 72px;
            font-size: 120px;
            line-height: 72px;
            text-align: center;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
            animation: pieceFloat 2s ease-in-out infinite;
            scale: 1.3;
padding-bottom: 20;
        }
        @keyframes pieceFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-3px) scale(1.05); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .owner-indicator {
            position: absolute;
            bottom: 3px;
            right: 3px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .modal {
            transition: opacity 0.25s ease;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            transition: transform 0.25s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        .dice {
            font-size: 3rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 3px solid #2d3748;
            background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .dice:hover {
            transform: rotate(5deg) scale(1.05);
        }
        
        /* 3D Dice Animation */
        .dice-3d {
            width: 80px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            animation: rollDice 1s ease-out;
        }
        @keyframes rollDice {
            0% { transform: rotateX(0deg) rotateY(0deg) translateY(-100px); }
            50% { transform: rotateX(720deg) rotateY(720deg) translateY(0px); }
            100% { transform: rotateX(1080deg) rotateY(1080deg) translateY(0px); }
        }
        .dice-face {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border: 3px solid #333;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }
        .dice-dot {
            width: 14px;
            height: 14px;
            background: #333;
            border-radius: 50%;
            position: absolute;
        }
        .dice-rolling {
            animation: shake 0.5s infinite;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            75% { transform: translateX(5px) rotate(5deg); }
        }
        
        /* � Property Buy Panel Styles */
        #property-buy-panel {
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* �🎭 Character & Map Button Styles */
        .character-btn, .map-btn {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .character-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .character-btn.border-blue-500 {
            border-width: 4px !important;
            background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%) !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6) !important;
            transform: scale(1.15) !important;
        }
        
        .character-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        
        .map-btn.border-blue-500 {
            border-width: 3px !important;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
        }
        
        /* Game mode button styles */
        .game-mode-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .game-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .game-mode-btn.border-blue-500 {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        
        /* Enhanced space styles */
        .space.corner {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            font-size: 10px;
            font-weight: bold;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .space[id="space-0"] {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: white;
        }
        .space[id="space-10"] {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: white;
        }
        .space[id="space-20"] {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white;
        }
        .space[id="space-30"] {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            color: white;
        }
        
        .houses-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 2px;
            padding: 2px;
        }
        .house {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #065f46;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .hotel {
            width: 24px;
            height: 14px;
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            border: 2px solid #9f1239;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* 📱 Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            /* 📱 LOBBY/MAIN MENU - Mobile Friendly */
            #lobby {
                max-width: 95vw;
                padding: 20px 16px;
                margin: 10px;
            }
            
            #lobby h1 {
                font-size: 28px;
                margin-bottom: 12px;
            }
            
            #lobby p {
                font-size: 13px;
                margin-bottom: 20px;
            }
            
            /* Character selection grid on mobile */
            #main-character-select {
                display: grid;
                grid-template-columns: repeat(8, 2fr);
                gap: 8px;
            }
            
            .character-btn {
                font-size: 28px !important;
                padding: 8px !important;
                min-height: 50px;
            }
            
            /* Map selection mobile */
            #main-map-select {
                grid-template-columns: repeat(4, 2fr);
                gap: 8px;
            }
            
            .map-btn {
                font-size: 12px;
                padding: 10px 8px !important;
                min-height: 44px;
            }
            
            /* Input fields */
            #playerNameInput,
            #gameIdInput {
                font-size: 16px;
                padding: 12px;
            }
            
            /* Buttons */
            #createGameBtn,
            #joinGameBtn {
                font-size: 15px;
                padding: 14px 16px;
                min-height: 48px;
            }
            
            /* Smaller board on mobile */
            .board {
                width: 98vmin;
                height: 98vmin;
                grid-template-columns: 120px repeat(18, 2fr) 120px;
                grid-template-rows: 120px repeat(18, 2fr) 120px;
                gap: 2px;
                border: 4px solid #1a5f3f;
            }
            
            /* Smaller spaces */
            .space {
                font-size: 6px;
                padding: 2px;
            }
            
            /* Smaller corners */
            .corner {
                font-size: 8px;
                padding: 3px;
            }
            
            /* Smaller player pieces */
            .player-piece {
                            scale: 1.3;
padding-bottom: 20;

                font-size: 28px;
                width: 18px;
                height: 18px;
            }
            
            /* Smaller houses */
            .house {
                width: 8px;
                height: 8px;
                border: 1px solid #065f46;
            }
            
            .hotel {
                width: 14px;
                height: 8px;
                border: 1px solid #9f1239;
            }
            
            /* Smaller owner indicators */
            .owner-indicator {
                width: 8px;
                height: 8px;
            }
            
            /* Mobile-friendly modals */
            #modal-overlay {
                padding: 10px;
            }
            
            #modal {
                max-width: 95vw;
                max-height: 90vh;
                padding: 16px;
            }
            
            /* Compact player cards */
            .player-card {
                padding: 8px;
                font-size: 12px;
            }
            
            /* Touch-friendly buttons */
            button {
                min-height: 44px;
                padding: 10px 16px;
            }
            
            /* Scrollable game log */
            #game-log {
                max-height: 120px;
                font-size: 11px;
            }
            
            /* Hide some decorative elements on mobile */
            .leaderboard {
                font-size: 11px;
                padding: 8px;
            }
            
            /* Make character selection more compact */
            .character-btn {
                font-size: 24px;
                padding: 4px;
            }
            
            /* 📱 GAME SETTINGS SCREEN - Mobile Optimizations */
            #game-settings {
                max-width: 95vw !important;
                padding: 16px !important;
                margin: 10px;
                max-height: 95vh !important;
            }
            
            #game-settings h2 {
                font-size: 24px;
                margin-bottom: 12px;
            }
            
            #game-settings h3 {
                font-size: 18px;
                margin-bottom: 12px;
            }
            
            #displayGameId {
                font-size: 20px;
                padding: 12px;
            }
            
            /* Game mode grid - 2 columns on mobile */
            #game-settings .game-mode-btn {
                font-size: 12px;
                padding: 10px 12px;
            }
            
            #game-settings .grid {
                gap: 8px;
            }
            
            /* Properties editor */
            #properties-editor {
                max-height: 250px !important;
                gap: 8px;
            }
            
            #properties-editor .property-card {
                font-size: 11px;
                padding: 8px;
            }
            
            /* Lobby controls */
            #lobby-controls {
                margin-top: 16px;
            }
            
            #lobby-players-list {
                gap: 4px;
            }
            
            #addBotBtn,
            #startGameBtn {
                font-size: 14px;
                padding: 12px 16px;
            }
            
            /* 📱 GAME SCREEN - Mobile Optimizations */
            #game-container {
                padding: 4px !important;
                gap: 4px !important;
                flex-direction: column !important;
            }
            
            /* Leaderboard - smaller and repositioned */
            #leaderboard {
                position: relative !important;
                top: 0 !important;
                right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                min-width: unset !important;
                padding: 8px !important;
                margin-bottom: 8px;
            }
            
            #leaderboard h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            #leaderboard-list {
                font-size: 11px;
            }
            
            #darkModeToggle {
                font-size: 12px;
                padding: 8px;
                margin-top: 8px;
            }
            
            /* Left panel - full width on mobile */
            #left-panel {
                width: 100% !important;
                padding: 8px !important;
                margin-bottom: 8px;
                max-height: 300px;
                overflow-y: auto;
            }
            
            #left-panel h2 {
                font-size: 18px;
                margin-bottom: 8px;
            }
            
            /* Player cards - horizontal scroll */
            #players-info {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                gap: 8px;
                padding-bottom: 8px;
            }
            
            #players-info .player-card {
                min-width: 150px;
                flex-shrink: 0;
            }
            
            /* Dice container */
            #dice-container {
                height: 80px !important;
                margin-bottom: 12px;
            }
            
            .dice {
                width: 50px !important;
                height: 50px !important;
                font-size: 32px !important;
            }
            
            /* Control buttons */
            #controls button {
                font-size: 13px;
                padding: 10px 12px;
                margin-top: 6px;
            }
            
            #rollDiceBtn {
                font-size: 14px !important;
                padding: 12px !important;
            }
            
            /* Right panel - game log */
            #right-panel {
                width: 100% !important;
                padding: 8px !important;
                max-height: 150px !important;
            }
            
            #right-panel h3 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            #game-log {
                font-size: 11px;
                max-height: 100px;
            }
            
            /* Board container - center and resize */
            #board-container {
                order: -1; /* Move board to top */
                width: 100% !important;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 8px;
            }
                /* --- EKSTRA MOBİL OYUN İÇİ İYİLEŞTİRMELER --- */
                /* Oyun içi ana butonlar daha büyük ve kolay tıklanabilir */
                #controls button, .action-btn, .trade-btn, .mortgage-btn, .buy-btn, .bid-btn, .share-btn {
                    font-size: 18px !important;
                    min-width: 90px;
                    min-height: 48px;
                    padding: 12px 18px !important;
                    margin: 6px 0 !important;
                }

                /* Kartlar mobilde daha büyük ve kolay kaydırılabilir */
                .property-card, .card-mini, .owned-card {
                    font-size: 8px !important;
                    min-width: 110px;
                    min-height: 60px;
                    margin: 4px 2px !important;
                    padding: 8px 6px !important;
                }

                /* Kartlar yatay scroll ile gösterilsin */
                #owned-cards, #player-cards, .player-cards-row {
                    display: flex !important;
                    flex-direction: row !important;
                    overflow-x: auto !important;
                    gap: 6px !important;
                    padding-bottom: 8px !important;
                }

                /* Popup ve modal'lar mobilde tam ekran ve kolay kapatılabilir */
                .modal, #modal, .popup, .trade-popup {
                    max-width: 99vw !important;
                    max-height: 99vh !important;
                    min-width: 90vw !important;
                    min-height: 60vh !important;
                    border-radius: 12px !important;
                    padding: 18px 8px !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    margin: auto !important;
                }

                /* Modal kapatma butonu büyük ve sağ üstte */
                .modal-close, .popup-close, .trade-popup-close {
                    position: absolute !important;
                    top: 10px !important;
                    right: 14px !important;
                    font-size: 32px !important;
                    background: none !important;
                    border: none !important;
                    color: #333 !important;
                    z-index: 1001;
                }

                /* Oyun içi alt menü ve hızlı erişim barı */
                #quick-access-bar {
                    display: flex !important;
                    flex-direction: row !important;
                    justify-content: space-around !important;
                    align-items: center !important;
                    position: fixed !important;
                    bottom: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    background: rgba(255,255,255,0.98) !important;
                    border-top: 2px solid #ccc !important;
                    z-index: 1002;
                    padding: 6px 0 !important;
                }

                #quick-access-bar button {
                    font-size: 20px !important;
                    min-width: 60px;
                    min-height: 44px;
                    margin: 0 4px;
                }

                /* Oyun içi kartlar ve oyuncu bilgileri mobilde ekranın üstünde sabitlenebilir */
                #mobile-player-info-bar {
                    display: flex !important;
                    flex-direction: row !important;
                    justify-content: flex-start !important;
                    align-items: center !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    background: rgba(255,255,255,0.98) !important;
                    border-bottom: 2px solid #ccc !important;
                    z-index: 1002;
                    padding: 6px 0 !important;
                    overflow-x: auto !important;
                }

                #mobile-player-info-bar .player-card, #mobile-player-info-bar .card-mini {
                    min-width: 90px;
                    font-size: 13px !important;
                    margin: 0 4px;
                }

                /* Mobilde scroll barları daha belirgin yap */
                ::-webkit-scrollbar {
                    height: 8px;
                    background: #eee;
                }
                ::-webkit-scrollbar-thumb {
                    background: #bbb;
                    border-radius: 4px;
                }

                /* Mobilde gereksiz dekoratif öğeleri gizle */
                .desktop-only {
                    display: none !important;
                }
        }
        
        /* 📱 Very Small Phones */
        @media (max-width: 480px) {
            /* 📱 LOBBY - Extra Small Phones */
            #lobby {
                padding: 16px 12px;
                margin: 5px;
            }
            
            #lobby h1 {
                font-size: 22px;
                margin-bottom: 8px;
            }
            
            #lobby p {
                font-size: 12px;
                margin-bottom: 16px;
            }
            
            /* Character selection - 3 columns on very small screens */
            #main-character-select {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            
            .character-btn {
                font-size: 24px !important;
                padding: 6px !important;
                min-height: 44px;
            }
            
            /* Labels smaller */
            label {
                font-size: 13px;
            }
            
            #createGameBtn,
            #joinGameBtn {
                font-size: 14px;
                padding: 12px;
            }
            
            /* 📱 GAME SETTINGS - Extra Small */
            #game-settings {
                padding: 12px !important;
            }
            
            #game-settings h2 {
                font-size: 20px;
            }
            
            #displayGameId {
                font-size: 18px;
                padding: 10px;
            }
            
            #game-settings .game-mode-btn {
                font-size: 11px;
                padding: 8px;
            }
            
            #addBotBtn,
            #startGameBtn {
                font-size: 13px;
                padding: 10px 12px;
            }
            
            /* 📱 GAME BOARD - Extra Small */
            .board {
                grid-template-columns: 100px repeat(18, 1fr) 100px;
                grid-template-rows: 100px repeat(18, 1fr) 100px;
            }
            
            .space {
                font-size: 5px;
                padding: 1px;
            }
            
            .corner {
                font-size: 7px;
            }
            
            .player-piece {
                            scale: 1.3;
padding-bottom: 20;

                font-size: 24px;
                width: 16px;
                height: 16px;
            }
            
            .dice {
                width: 45px !important;
                height: 45px !important;
                font-size: 28px !important;
            }
            
            #left-panel {
                max-height: 250px;
            }
            
            #right-panel {
                max-height: 120px !important;
            }
            
            #game-log {
                font-size: 10px;
                max-height: 80px;
            }
            
            button {
                font-size: 13px;
                padding: 8px 12px;
            }
        }
            /* 📱 GAME BOARD - Extra Small */
            .board {
                grid-template-columns: 50px repeat(9, 1fr) 50px;
                grid-template-rows: 50px repeat(9, 1fr) 50px;
            }
            
            .space {
                font-size: 5px;
                padding: 1px;
            }
            
            .corner {
                font-size: 7px;
            }
            
            .player-piece {
                            scale: 1.3;
padding-bottom: 20;

                font-size: 24px;
                width: 16px;
                height: 16px;
            }
            
            .dice {
                width: 45px !important;
                height: 45px !important;
                font-size: 28px !important;
            }
            
            #left-panel {
                max-height: 250px;
            }
            
            #right-panel {
                max-height: 120px !important;
            }
            
            #game-log {
                font-size: 10px;
                max-height: 80px;
            }
            
            button {
                font-size: 13px;
                padding: 8px 12px;
            }
        }

        /* Price labels outside spaces */
        .price-bottom {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .price-top {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .price-left {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        .price-right {
            position: absolute;
            right: -35px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        /* MASAÜSTÜNDE her şeyi 0.8x yap */
        @media (min-width: 769px) {
            html {
                font-size: 12.8px; /* 16px * 0.8 = 12.8px */
            }
            
            .mobile-game-actions {
                display: none !important;
            }
        }
        
        /* SADECE MOBİL: Oyun kontrolleri sadece oyun içinde görünür */
        @media (max-width: 768px) {
            /* Mobilde normal boyut */
            body * {
                zoom: 1;
                -moz-transform: scale(0.95);
                transform: scale(0.95);
                -moz-transform-origin: 0 0;
                transform-origin: 0 0;
            }
            
            /* Mobilde board'u tamamen gizle */
            #board,
            .board {
                display: none !important;
            }
            
            /* Sadece oyun içindeyken board'u göster */
            body.in-game #board,
            body.in-game .board {
                display: grid !important;
                margin-bottom: 100px !important;
                padding-bottom: 20px !important;
            }
            
            /* Mobilde masaüstü oyun kontrollerini tamamen gizle */
            #rollDiceBtn,
            #endTurnBtn,
            #teamManagerBtn,
            #managePropertiesBtn,
            #jokerCardsBtn,
            #left-panel,
            #right-panel,
            #mobile-controls-bar,
            .center-board h1,
            #dice-container,
            #dice1-wrapper,
            #dice2-wrapper,
            #dice1,
            #dice2 {
                display: none !important;
            }
            
            /* Center board alanını boş bırak */
            .center-board {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
            }
            
            /* Mobil butonlar varsayılan olarak gizli */
            .mobile-game-actions {
                display: none !important;
            }
            
            /* Sadece oyun içindeyken mobil butonları göster */
            body.in-game .mobile-game-actions {
                display: flex !important;
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 300;
                background: #fff;
                border-top: 2px solid #e0e0e0;
                box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
                padding: 0.8rem;
                justify-content: space-around;
                align-items: center;
                gap: 0.5rem;
            }
            
            body.in-game .mobile-game-actions button {
                display: inline-flex !important;
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                font-weight: 600;
                border-radius: 8px;
                border: none;
                background: #1a73e8;
                color: #fff;
                cursor: pointer;
                transition: background 0.2s;
                flex: 1;
                justify-content: center;
                align-items: center;
                min-height: 44px;
            }
            
            body.in-game .mobile-game-actions button:active {
                background: #155ab6;
            }
            
            /* Mobil butonlar için grid layout - 2 satır, 3+2 buton */
            body.in-game .mobile-game-actions {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
                padding: 0.8rem;
            }
            
            body.in-game .mobile-game-actions button {
                padding: 0.7rem 0.5rem !important;
                font-size: 0.75rem !important;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen">

    <!-- Mobilde sadece oyun içi menüde gösterilecek kontroller -->
    <div class="mobile-game-actions">
        <button id="mobile-roll-btn">🎲 Roll</button>
        <button id="mobile-properties-btn">🏠 Props</button>
        <button id="mobile-joker-btn">🃏 Joker</button>
        <button id="mobile-team-btn" style="grid-column: span 2;">👥 Team</button>
        <button id="mobile-end-turn-btn">✅ End</button>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby" class="w-full max-w-lg p-8 rounded-xl shadow-2xl text-center" style="background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 50%, #f5e6d3 100%); border: 4px solid #c9a66b;">
        <h1 class="text-4xl font-bold mb-4" style="color: #1a5f3f; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">🎲 Monopoly Game 🏠</h1>
        <p class="text-gray-600 mb-8">Create a game and invite your friends, or join an existing game.</p>
        
        <div class="space-y-4">
            <input id="playerNameInput" type="text" placeholder="Enter Your Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <!-- Character Selection in Main Menu -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2 text-left">Select Your Character</label>
                <div id="main-character-select" class="flex gap-2 flex-wrap justify-center">
                    <button type="button" class="character-btn text-3xl p-2 border-2 rounded-lg hover:border-blue-300 transition" data-char="car">🚗</button>
                    <button type="button" class="character-btn text-3xl p-2 border-2 rounded-lg hover:border-blue-300 transition" data-char="hat">🎩</button>
                    <button type="button" class="character-btn text-3xl p-2 border-2 rounded-lg hover:border-blue-300 transition" data-char="dog">🐕</button>
                    <button type="button" class="character-btn text-3xl p-2 border-2 rounded-lg hover:border-blue-300 transition" data-char="shoe">👞</button>
                    <button type="button" class="character-btn text-3xl p-2 border-2 rounded-lg hover:border-blue-300 transition" data-char="iron">🧲</button>
                    <button type="button" class="character-btn text-3xl p-2 border-2 rounded-lg hover:border-blue-300 transition" data-char="ship">🚢</button>
                    <button type="button" class="character-btn text-3xl p-2 border-2 rounded-lg hover:border-blue-300 transition" data-char="cat">🐈</button>
                    <button type="button" class="character-btn text-3xl p-2 border-2 rounded-lg hover:border-blue-300 transition" data-char="money">💰</button>
                </div>
            </div>
            
            <!-- Map Selection in Main Menu -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2 text-left">Select Map <span id="main-map-preview" class="text-xs text-blue-600 font-semibold ml-2"></span></label>
                <div id="main-map-select" class="grid grid-cols-2 gap-2">
                    <button type="button" class="map-btn px-3 py-2 border-2 rounded-lg hover:bg-blue-50 transition text-sm" data-map="classic">🏛️ Classic</button>
                    <button type="button" class="map-btn px-3 py-2 border-2 rounded-lg hover:bg-blue-50 transition text-sm" data-map="turkey">🇹🇷 Turkey</button>
                    <button type="button" class="map-btn px-3 py-2 border-2 rounded-lg hover:bg-blue-50 transition text-sm" data-map="world">🌍 World</button>
                    <button type="button" class="map-btn px-3 py-2 border-2 rounded-lg hover:bg-blue-50 transition text-sm" data-map="holland">🇳🇱 Holland</button>
                    <button type="button" class="map-btn px-3 py-2 border-2 rounded-lg hover:bg-blue-50 transition text-sm" data-map="megarich">💎 Mega Rich</button>
                    <button type="button" class="map-btn px-3 py-2 border-2 rounded-lg hover:bg-blue-50 transition text-sm" data-map="custom">⚙️ Custom</button>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <input id="privateGameCheckbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                <label for="privateGameCheckbox" class="text-sm font-medium text-gray-700">Private Game (won't appear in public games list)</label>
            </div>
            
            <button id="createGameBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Create New Game</button>
        </div>

        <div class="my-6 flex items-center">
            <hr class="flex-grow border-t border-gray-300">
            <span class="px-4 text-gray-500">OR</span>
            <hr class="flex-grow border-t border-gray-300">
        </div>

        <!-- Public Games List -->
        <div class="space-y-4">
            <h3 class="text-lg font-semibold text-gray-800">Public Games</h3>
            <div id="public-games-list" class="space-y-2 max-h-48 overflow-y-auto">
                <!-- Public games will be listed here -->
                <p class="text-gray-500 text-sm">Loading games...</p>
            </div>
            <button id="refreshGamesBtn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300 text-sm">🔄 Refresh List</button>
        </div>

        <div class="my-6 flex items-center">
            <hr class="flex-grow border-t border-gray-300">
            <span class="px-4 text-gray-500">OR</span>
            <hr class="flex-grow border-t border-gray-300">
        </div>

        <div class="space-y-4">
            <input id="gameIdInput" type="text" placeholder="Enter Game ID" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            <button id="joinGameBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300">Join Game</button>
        </div>
        <p id="lobby-error" class="text-red-500 mt-4 h-4"></p>
    </div>

    <!-- Game Settings Screen (Host Only) -->
    <div id="game-settings" class="hidden w-full max-w-4xl p-8 bg-white rounded-xl shadow-2xl overflow-y-auto" style="max-height: 90vh;">
        <h2 class="text-3xl font-bold mb-2 text-gray-800">Game Settings</h2>
        <div class="mb-6">
            <p class="text-gray-600">Share this Game ID with your friends:</p>
            <div class="flex items-center gap-2 mt-2">
                 <p id="displayGameId" class="text-2xl font-mono p-3 bg-gray-100 rounded-lg"></p>
                 <button id="copyGameIdBtn" class="bg-gray-200 p-3 rounded-lg hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                 </button>
            </div>
            <div class="mt-3">
                <p class="text-gray-600 text-sm">Or share this direct link:</p>
                <div class="flex items-center gap-2 mt-1">
                    <input id="gameLinkInput" type="text" readonly class="flex-1 text-sm font-mono p-2 bg-gray-100 rounded border" onclick="this.select()">
                    <button id="copyLinkBtn" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 text-sm">
                        Copy Link
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Game Mode</label>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg hover:bg-blue-50 transition" data-mode="classic">
                    <div class="font-bold">🎲 Classic</div>
                    <div class="text-xs text-gray-600">Traditional rules</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg hover:bg-blue-50 transition" data-mode="fast">
                    <div class="font-bold">⚡ Fast Money</div>
                    <div class="text-xs text-gray-600">2x money, 2x GO</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg hover:bg-blue-50 transition" data-mode="hard">
                    <div class="font-bold">🔥 Hard Mode</div>
                    <div class="text-xs text-gray-600">Less money, more tax</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg hover:bg-blue-50 transition" data-mode="noluck">
                    <div class="font-bold">🚫 No Luck</div>
                    <div class="text-xs text-gray-600">No chance/chest cards</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg hover:bg-blue-50 transition" data-mode="mega">
                    <div class="font-bold">💎 Mega Rich</div>
                    <div class="text-xs text-gray-600">5x starting money</div>
                </button>
                <button type="button" class="game-mode-btn px-4 py-3 border-2 rounded-lg hover:bg-blue-50 transition" data-mode="speed">
                    <div class="font-bold">🏃 Speed Game</div>
                    <div class="text-xs text-gray-600">Half properties</div>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="startingMoney" class="block text-sm font-medium text-gray-700">Starting Money</label>
                <input type="number" id="startingMoney" value="1500" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="passGoAmount" class="block text-sm font-medium text-gray-700">Pass "GO" Amount</label>
                <input type="number" id="passGoAmount" value="200" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
        </div>
        <div class="mb-6">
            <label class="flex items-center">
                <input type="checkbox" id="allowTrading" checked class="mr-2">
                <span class="text-sm font-medium text-gray-700">Allow Player Trading</span>
            </label>
        </div>
        <div class="mb-6">
            <label class="flex items-center">
                <input type="checkbox" id="allowDoubles" class="mr-2">
                <span class="text-sm font-medium text-gray-700">Allow Doubles Rule (Extra turn on doubles)</span>
            </label>
        </div>
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Map <span id="map-preview" class="text-xs text-blue-600 font-semibold ml-2"></span></label>
                    <div id="map-select" class="flex gap-2 flex-wrap">
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="classic">🏛️ Classic</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="turkey">🇹🇷 Türkiye</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="world">🌍 World</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="holland">🇳🇱 Holland</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="megarich">💎 Mega Rich</button>
                        <button type="button" class="map-btn px-4 py-2 border-2 rounded-lg hover:bg-blue-50 transition" data-map="custom">⚙️ Custom</button>
                    </div>
                </div>
            </div>
                <label for="playerCount" class="block text-sm font-medium text-gray-700">Max Players</label>
                <input type="number" id="playerCount" value="4" min="2" max="8" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="auction-timer-container">
                <label for="auctionTimer" class="block text-sm font-medium text-gray-700">Auction Bid Timer (seconds)</label>
                <input type="number" id="auctionTimer" value="10" min="5" max="30" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="allow-trading-container" class="flex items-center mt-6">
                <input id="allowTrading" type="checkbox" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="allowTrading" class="ml-2 block text-sm text-gray-900">Allow Trading</label>
            </div>
        </div>

        <h3 id="customize-board-title" class="text-xl font-bold mb-4 text-gray-700">Customize Board</h3>
        <div id="properties-editor" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto" style="max-height: 400px;">
            <!-- Property editors will be dynamically inserted here -->
        </div>
        
        <div id="lobby-controls" class="mt-8">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-700">Players in Lobby:</h3>
                    <div id="lobby-players-list" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                <div class="flex gap-2">
                    <button id="addBotBtn" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition duration-300">🤖 Add Bot</button>
                    <button id="startGameBtn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 text-lg disabled:bg-gray-400">Start Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-container" class="hidden w-full h-full p-2 flex flex-col lg:flex-row gap-2">
        
        <!-- Mobil Players Menüsü (Sadece mobilde en üstte) -->
        <div id="mobile-players-bar" style="display: none;">
            <div id="mobile-players-list" style="display: flex; overflow-x: auto; gap: 0.5rem; padding: 0.5rem; background: white; border-bottom: 2px solid #e0e0e0;"></div>
        </div>
        
        <style>
            @media (max-width: 768px) {
                #mobile-players-bar {
                    display: block !important;
                    position: sticky;
                    top: 0;
                    z-index: 200;
                }
                #mobile-players-list {
                    white-space: nowrap;
                }
                .mobile-player-card {
                    display: inline-flex;
                    flex-direction: column;
                    align-items: center;
                    min-width: 80px;
                    padding: 0.5rem;
                    background: #f9fafb;
                    border-radius: 8px;
                    border: 2px solid #e5e7eb;
                    font-size: 0.75rem;
                }
                .mobile-player-card.active {
                    border-color: #3b82f6;
                    background: #eff6ff;
                }
            }
            .game-link-display{
                display: none !important;
            }
        </style>
        
        <!-- 🎨 Dark Mode Toggle (Top Right) -->
        <button id="darkModeToggle" class="absolute top-4 right-4 bg-gradient-to-r from-gray-700 to-gray-900 text-white px-4 py-2 rounded-lg hover:from-gray-800 hover:to-black transition-all shadow-lg text-sm font-bold z-20">
            🌙 Dark Mode
        </button>
        
        <!-- 🔗 Game Link Display (Top Right, below dark mode) -->
        <div id="game-link-display" class="absolute top-16 right-4 bg-white border border-gray-300 rounded-lg p-2 shadow-lg hidden z-20">
            <div class="text-xs text-gray-600 mb-1">Game Link:</div>
            <div class="flex gap-1">
                <input id="game-link-input" type="text" readonly class="text-xs bg-gray-50 border border-gray-300 rounded px-2 py-1 flex-1 min-w-0" style="font-size: 10px;">
                <button id="copy-game-link-btn" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                    📋
                </button>
            </div>
        </div>


        
        <!-- Player Info and Controls -->
        <div id="left-panel" class="w-full lg:w-1/4 bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl p-4 flex flex-col gap-3 overflow-y-auto border-2 border-gray-200">
            <h2 class="text-2xl font-bold text-center">Players</h2>
            <div id="players-info" class="flex-grow space-y-2">
                <!-- Player cards will be here -->
            </div>
            
            <!-- Game Link Display (moved from top-right) -->
            <div id="game-link-display-mobile" class="hidden border-t-2 border-gray-200 pt-3">
                <div class="text-xs text-gray-600 mb-1">Game Link:</div>
                <div class="flex gap-1">
                    <input id="game-link-input-mobile" type="text" readonly class="text-xs bg-gray-50 border border-gray-300 rounded px-2 py-1 flex-1 min-w-0" style="font-size: 10px;">
                    <button id="copy-game-link-btn-mobile" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                        📋
                    </button>
                </div>
            </div>
            
            <!-- Chat Panel -->
            <div id="chat-panel" class="flex flex-col gap-3 border-t-2 border-gray-200 pt-3" style="display: none;">
                <h3 class="text-xl font-bold text-center">💬 Chat</h3>
                <div id="chat-messages" class="flex-grow space-y-2 overflow-y-auto max-h-64 bg-gray-50 p-2 rounded-lg resize-y min-h-32">
                    <!-- Chat messages will be here -->
                </div>
                <div class="flex gap-2">
                    <input id="chat-input" type="text" placeholder="Type a message..." class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="200">
                    <button id="chat-send-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">Send</button>
                </div>
            </div>
        </div>
        
        <!-- Board -->
        <div class="flex-grow flex items-center justify-center">
                <div id="board" class="board">
                <div class="center-board">
                    <h1 class="text-5xl font-bold text-gray-800 tracking-wider">BUSINESS</h1>
                    
                    <!-- 🎲 Dice Display - Center of Board -->
                    <div id="dice-container" class="flex justify-center items-center gap-4 h-24">
                        <div id="dice1-wrapper" class="relative">
                            <span id="dice1" class="dice">🎲</span>
                        </div>
                        <div id="dice2-wrapper" class="relative">
                            <span id="dice2" class="dice">🎲</span>
                        </div>
                    </div>
                    
                    <!-- 🎲 Roll Dice Button - Center of Board -->
                    <button id="rollDiceBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3 px-4 rounded-lg hover:from-blue-700 hover:to-blue-800 transition duration-300 disabled:bg-gray-400 shadow-lg transform hover:scale-105">🎲 Roll Dice</button>
                    
                    <!-- 🏠 Manage Properties Button - Center of Board -->
                    <button id="managePropertiesBtn" class="hidden md:block w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:from-purple-700 hover:to-purple-800 transition duration-300 shadow-lg transform hover:scale-105">🏠 Manage Properties</button>
                    
                    <!-- 🤝 Team Manager Button - Center of Board -->
                    <button id="teamManagerBtn" class="hidden md:block w-full bg-gradient-to-r from-orange-600 to-orange-700 text-white font-bold py-2 px-4 rounded-lg hover:from-orange-700 hover:to-orange-800 transition duration-300 shadow-lg transform hover:scale-105">🤝 Team Manager</button>
                    
                    <!-- 🤝 Trade Button - Center of Board -->
                    <button id="viewTradesBtn" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-700 text-white font-bold py-2 px-4 rounded-lg hover:from-yellow-700 hover:to-yellow-800 transition duration-300 shadow-lg transform hover:scale-105">📤 Trade (<span id="pending-trades-count">0</span>)</button>
                    
                    <!-- 🃏 Joker Cards Button - Center of Board -->
                    <button id="jokerCardsBtn" class="w-full bg-gradient-to-r from-pink-600 to-pink-700 text-white font-bold py-2 px-4 rounded-lg hover:from-pink-700 hover:to-pink-800 transition duration-300 shadow-lg transform hover:scale-105">🃏 Joker Cards</button>
                    
                    <!-- ✓ End Turn Button - Center of Board -->
                    <button id="endTurnBtn" class="hidden w-full bg-gradient-to-r from-red-600 to-red-700 text-white font-bold py-2 px-4 rounded-lg hover:from-red-700 hover:to-red-800 transition duration-300 shadow-lg transform hover:scale-105">✓ End Turn</button>
                    
                    <div id="game-log" class="w-full h-24 bg-gray-100 p-2 rounded-lg overflow-y-auto text-xs border">
                        <!-- Game log messages go here -->
                    </div>
                    <!-- Mobile controls bar -->
                    <div id="mobile-controls-bar" class="hidden">
                        <button id="managePropertiesBtnMobile" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-yellow-600 transition duration-200">Manage Properties</button>
                        <button id="teamManagerBtnMobile" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition duration-200">Team Manager</button>
                        <button id="jokerCardsBtnMobile" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-purple-600 transition duration-200">Joker Cards</button>
                    </div>
                </div>
                <!-- Spaces will be dynamically inserted here -->
            </div>
            
            <!-- 🏡 Property Buy Panel - Floating on Board -->
            <div id="property-buy-panel" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 z-40 max-w-md w-full border-4 border-green-500">
                <div class="text-center">
                    <h3 id="property-buy-title" class="text-2xl font-bold mb-2 text-green-700">🏡 Buy Property</h3>
                    <p id="property-buy-name" class="text-xl font-semibold mb-4 text-gray-800"></p>
                    <p id="property-buy-desc" class="text-sm text-gray-600 mb-6"></p>
                    
                    <!-- Share Options -->
                    <div id="property-buy-options" class="space-y-3">
                        <!-- Options will be added dynamically -->
                    </div>
                    
                    <button id="property-buy-close" class="mt-4 bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 font-bold">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Game Management Modal -->
        <div id="game-management-modal" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 z-40 max-w-lg w-full border-4 border-purple-500">
            <div class="text-center">
                <h3 class="text-2xl font-bold mb-4 text-purple-700">🎮 Game Management</h3>
                <div id="game-management-players" class="space-y-3 max-h-64 overflow-y-auto">
                    <!-- Players will be added here -->
                </div>
                <button onclick="hideGameManagementModal()" class="mt-4 bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 font-bold">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Generic Modal -->
    <div id="modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center transform scale-95">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Modal Title</h3>
            <div id="modal-body" class="text-gray-600 mb-6">Modal body text goes here.</div>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <!-- Buttons will be added here -->
            </div>
        </div>
    </div>


    <script>
        // Oyun içi menüde olup olmadığını kontrol eden fonksiyon
        function updateMobileGameActions() {
            const body = document.body;
            // window.isInGameMenu değişkenini kendi oyun içi menü kontrolünüzle değiştirin
            const inGame = window.isInGameMenu || false;
            if (inGame) {
                body.classList.add('in-game');
            } else {
                body.classList.remove('in-game');
            }
        }
        // Oyun durumu değiştiğinde bu fonksiyonu çağırın
        // örn: updateMobileGameActions();
        // Oyun içi menüde olup olmadığını kontrol eden fonksiyon
        function updateMobileGameActions() {
            const body = document.body;
            // window.isInGameMenu değişkenini kendi oyun içi menü kontrolünüzle değiştirin
            const inGame = window.isInGameMenu || false;
            if (inGame) {
                body.classList.add('in-game');
            } else {
                body.classList.remove('in-game');
            }
        }
        // Oyun durumu değiştiğinde bu fonksiyonu çağırın
        // örn: updateMobileGameActions();
        // Oyun içi menüde olup olmadığını kontrol eden fonksiyon
        function updateMobileGameActions() {
            const body = document.body;
            // window.isInGameMenu değişkenini kendi oyun içi menü kontrolünüzle değiştirin
            const inGame = window.isInGameMenu || false;
            if (inGame) {
                body.classList.add('in-game');
            } else {
                body.classList.remove('in-game');
            }
        }
        // Oyun durumu değiştiğinde bu fonksiyonu çağırın
        // örn: updateMobileGameActions();
        // Mobile controls bar logic
        function updateMobileControlsBar() {
            const mobileBar = document.getElementById('mobile-controls-bar');
            const gameContainer = document.getElementById('game-container');
            if (window.innerWidth <= 900 && gameContainer && !gameContainer.classList.contains('hidden')) {
                mobileBar.classList.remove('hidden');
            } else {
                mobileBar.classList.add('hidden');
            }
        }
        window.addEventListener('resize', updateMobileControlsBar);
        window.addEventListener('DOMContentLoaded', updateMobileControlsBar);
        // Button event bindings
        document.getElementById('managePropertiesBtnMobile').onclick = () => document.getElementById('managePropertiesBtn').click();
        document.getElementById('teamManagerBtnMobile').onclick = () => document.getElementById('teamManagerBtn').click();
        document.getElementById('jokerCardsBtnMobile').onclick = () => document.getElementById('jokerCardsBtn').click();
        
        // Modal toggle state tracking
        let lastOpenedModal = null;
        let lastOpenedButton = null;
        
        // Mobil oyun kontrol butonları için toggle event listener'lar
        document.getElementById('mobile-roll-btn').onclick = () => document.getElementById('rollDiceBtn').click();
        
        document.getElementById('mobile-properties-btn').onclick = function() {
            if (lastOpenedButton === this && !modal.classList.contains('hidden')) {
                hideModal();
                lastOpenedButton = null;
            } else {
                document.getElementById('managePropertiesBtn').click();
                lastOpenedButton = this;
            }
        };
        
        document.getElementById('mobile-joker-btn').onclick = function() {
            if (lastOpenedButton === this && !modal.classList.contains('hidden')) {
                hideModal();
                lastOpenedButton = null;
            } else {
                document.getElementById('jokerCardsBtn').click();
                lastOpenedButton = this;
            }
        };
        
        document.getElementById('mobile-team-btn').onclick = function() {
            if (lastOpenedButton === this && !modal.classList.contains('hidden')) {
                hideModal();
                lastOpenedButton = null;
            } else {
                document.getElementById('teamManagerBtn').click();
                lastOpenedButton = this;
            }
        };
        
        document.getElementById('mobile-end-turn-btn').onclick = () => document.getElementById('endTurnBtn').click();
        
        // === WEBSOCKET CONNECTION ===
        let ws;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let connectionStatus = 'disconnected'; // 'connected', 'connecting', 'disconnected'

        function connectWebSocket() {
            if (connectionStatus === 'connecting') return;
            
            connectionStatus = 'connecting';
            updateConnectionIndicator();
            
            // Allow overriding the WebSocket URL by including a small `ws-config.js`
            // that sets `window.WS_URL = 'wss://your-server.example.com';`
            const configuredWsUrl = (typeof window !== 'undefined' && window.WS_URL) ? window.WS_URL : null;
            let wsUrl;
            if (configuredWsUrl) {
                wsUrl = configuredWsUrl;
                console.log('🔌 Using configured WS URL from ws-config.js:', wsUrl);
                addDebugLog('🔌 WS URL (configured): ' + wsUrl);
            } else {
                // If we're hosted on a static host like Netlify and no WS_URL is configured,
                // do not attempt to connect to a WebSocket on the static host (it won't exist).
                const isLikelyStaticHost = (typeof window !== 'undefined' && window.location && window.location.hostname && (window.location.hostname.includes('netlify.app') || window.location.hostname.includes('vercel.app') || window.location.hostname === '')); 
                if (isLikelyStaticHost) {
                    console.warn('⚠️ No WebSocket backend configured and site appears to be on a static host. Multiplayer (WebSocket) is disabled.');
                    addDebugLog('⚠️ No WS backend configured — multiplayer disabled');
                    // Show a small on-page notice for users
                    let notice = document.getElementById('ws-no-backend-notice');
                    if (!notice) {
                        notice = document.createElement('div');
                        notice.id = 'ws-no-backend-notice';
                        notice.style.cssText = 'position:fixed;top:12px;right:12px;background:#fffbeb;color:#92400e;padding:10px 14px;border:1px solid #f59e0b;border-radius:8px;z-index:10001;box-shadow:0 6px 20px rgba(0,0,0,0.12);font-weight:600;';
                        notice.innerHTML = 'Multiplayer disabled — no WebSocket server configured. See README for deploy options.';
                        document.body.appendChild(notice);
                    }
                    connectionStatus = 'disconnected';
                    updateConnectionIndicator();
                    return; // Don't attempt to create a WebSocket
                }

                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host || 'localhost:8000';
                wsUrl = `${protocol}//${host}`;
                console.log('🔌 Connecting to WebSocket (fallback):', wsUrl);
                console.log('📍 Protocol:', protocol);
                console.log('📍 Host:', host);
                addDebugLog('🔌 WS URL: ' + wsUrl);
            }
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('✅ WebSocket connected successfully!');
                console.log('🔌 WebSocket URL:', wsUrl);
                console.log('🔌 ReadyState:', ws.readyState);
                addDebugLog('✅ WS CONNECTED!');
                reconnectAttempts = 0;
                connectionStatus = 'connected';
                updateConnectionIndicator();
                
                // 🔄 Auto-reconnect to previous game if stored
                const storedGameId = localStorage.getItem('monopolyCurrentGameId');
                const storedPlayerId = localStorage.getItem('monopolyPlayerId');
                if (storedGameId && storedPlayerId && !currentGameId) {
                    console.log('🔄 Auto-reconnecting to game:', storedGameId);
                    currentGameId = storedGameId;
                    localPlayer.id = storedPlayerId;
                    sendMessage({
                        type: 'get_game',
                        gameId: storedGameId,
                        playerId: storedPlayerId
                    });
                }
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleServerMessage(message);
            };

            ws.onclose = (event) => {
                connectionStatus = 'disconnected';
                updateConnectionIndicator();
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(() => {
                        connectWebSocket();
                    }, 2000);
                } else {
                    alert('Connection lost. Please refresh the page to reconnect.');
                }
            };

            ws.onerror = (error) => {
                connectionStatus = 'disconnected';
                updateConnectionIndicator();
            };
        }

        function updateConnectionIndicator() {
            // Create connection indicator if it doesn't exist
            let indicator = document.getElementById('connection-status');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'connection-status';
                indicator.style.cssText = 'position: fixed; top: 10px; left: 10px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: bold; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: all 0.3s; max-width: 200px; text-align: center; cursor: pointer;';
                document.body.appendChild(indicator);
                
                // Toggle debug log on click
                indicator.addEventListener('click', () => {
                    const debugLog = document.getElementById('debug-log');
                    if (debugLog) {
                        debugLog.style.display = 'none';
                    }
                });
            }
            
            // Create debug log display
            let debugLog = document.getElementById('debug-log');
            if (!debugLog) {
                debugLog = document.createElement('div');
                debugLog.id = 'debug-log';
                debugLog.style.cssText = 'position: none; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); color: #0f0; padding: 0px; font-size: 1px; font-family: monospace; max-height: 2px; overflow-y: auto; z-index: 999999; display: none; border-top: 0px solid #0f0;';
                document.body.appendChild(debugLog);
                
                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '✕ Close';
                closeBtn.style.cssText = 'position: sticky; top: 0; right: 0; background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; float: right; z-index: 10000;';
                closeBtn.onclick = () => { debugLog.style.display = 'none'; };
                debugLog.appendChild(closeBtn);
            }
            
            if (connectionStatus === 'connected') {
                indicator.textContent = '🟢 Connected';
                indicator.style.backgroundColor = '#10b981';
                indicator.style.color = 'white';
                console.log('🟢 Status: Connected');
                addDebugLog('🟢 CONNECTED');
            } else if (connectionStatus === 'connecting') {
                indicator.textContent = '🟡 Connecting...';
                indicator.style.backgroundColor = '#f59e0b';
                indicator.style.color = 'white';
                console.log('🟡 Status: Connecting...');
                addDebugLog('🟡 CONNECTING...');
            } else {
                indicator.textContent = '🔴 Disconnected';
                indicator.style.backgroundColor = '#ef4444';
                indicator.style.color = 'white';
                console.log('🔴 Status: Disconnected');
                addDebugLog('🔴 DISCONNECTED');
            }
        }
        
        /*
        // 🐛 DEBUG LOG FUNCTION - Uncomment if needed
        function addDebugLog(message) {
            const debugLog = document.getElementById('debug-log');
            if (debugLog) {
                const time = new Date().toLocaleTimeString();
                debugLog.innerHTML += `<div>${time}: ${message}</div>`;
                debugLog.scrollTop = debugLog.scrollHeight;
                
                const lines = debugLog.querySelectorAll('div');
                if (lines.length > 20) {
                    lines[0].remove();
                }
            }
        }
        */
        
        // Dummy function to prevent errors
        function addDebugLog(message) {
            // Debug disabled - uncomment code above to enable
        }

        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            } else {
                console.error('❌ Cannot send message - WebSocket not connected');
                alert('Connection lost. Please wait while we reconnect...');
                connectWebSocket();
            }
        }

        function handleServerMessage(message) {
            switch(message.type) {
                case 'game_created':
                    currentGameId = message.gameId;
                    gameData = message.game;
                    
                    // 🔄 Save session to localStorage for F5 protection
                    localStorage.setItem('monopolyCurrentGameId', currentGameId);
                    localStorage.setItem('monopolyPlayerId', localPlayer.id);
                    
                    // Re-enable create button
                    createGameBtn.disabled = false;
                    createGameBtn.textContent = 'Create New Game';
                    lobbyError.textContent = '✅ Game created!';
                    lobbyError.style.color = 'green';
                    
                    showGameSettings();
                    break;
                    
                case 'game_joined':
                    currentGameId = message.gameId;
                    gameData = message.game;
                    
                    // 🔄 Save session to localStorage for F5 protection
                    localStorage.setItem('monopolyCurrentGameId', currentGameId);
                    localStorage.setItem('monopolyPlayerId', localPlayer.id);
                    
                    // Re-enable join button
                    joinGameBtn.disabled = false;
                    joinGameBtn.textContent = 'Join Game';
                    lobbyError.textContent = '✅ Joined successfully!';
                    lobbyError.style.color = 'green';
                    
                    showWaitingLobby();
                    break;
                    
                case 'game_updated':
                    const oldGameData = gameData;
                    gameData = message.game;
                    
                    if (!gameData || !gameData.settings) {
                        console.error('Invalid game data received:', gameData);
                        return;
                    }
                    
                    // Ensure all players have joker cards and secret trades
                    if (gameData && gameData.players) {
                        gameData.players = gameData.players.map(player => {
                            if (!player.jokerCards) {
                                player.jokerCards = {
                                    steal: 1,
                                    skip: 1,
                                    reroll: 1
                                };
                            }
                            if (player.secretTradesAvailable === undefined) {
                                player.secretTradesAvailable = 3;
                            }
                            return player;
                        });
                    }
                    
                    if (gameData.state === 'lobby') {
                        updateLobbyUI();
                        if(gameData.hostId !== localPlayer.id) {
                            showWaitingLobby();
                        } else {
                            showGameSettings();
                        }
                    } else if (gameData.state === 'playing') {
                        if (gameContainer.classList.contains('hidden')) {
                            showGame();
                            setTimeout(() => {
                                renderBoard();
                                updateGameUI();
                            }, 100);
                        } else {
                            updateGameUI();
                        }
                        
                        // 🤝 Check for pending trades
                        if (gameData.trades && gameData.trades.length > 0) {
                            checkPendingTrades();
                        }
                        
                        // 🤝 Check for partnership requests
                        if (gameData.partnershipRequests && gameData.partnershipRequests.length > 0) {
                            checkPartnershipRequests();
                        }
                        
                        // ❌ Check for declined partnership requests
                        if (gameData.declinedPartnershipRequests && gameData.declinedPartnershipRequests.length > 0) {
                            checkDeclinedPartnerships(oldGameData);
                        }
                        
                        // Check for active auction
                        if (gameData.auction && gameData.auction.active) {
                            const auctionChanged = !oldGameData || !oldGameData.auction || 
                                                  JSON.stringify(oldGameData.auction) !== JSON.stringify(gameData.auction);
                            
                            // Start timer if auction just started
                            if (auctionChanged && !auctionTimerInterval) {
                                auctionTimerInterval = setInterval(updateAuctionTimer, 1000);
                            }
                            
                            // Bot auction bidding logic
                            if (auctionChanged && gameData.players[gameData.currentPlayerIndex].isBot && 
                                gameData.auction.playersInAuction.includes(gameData.players[gameData.currentPlayerIndex].id)) {
                                // Bot should bid if current bid is less than property price
                                const space = gameData.settings.board[gameData.auction.position];
                                const currentBid = gameData.auction.currentBid;
                                const botPlayer = gameData.players[gameData.currentPlayerIndex];
                                
                                if (currentBid < space.price && botPlayer.money > currentBid + 10) {
                                    // Bot bids up to the original price
                                    const bidAmount = Math.min(currentBid + Math.floor(Math.random() * 20) + 10, space.price, botPlayer.money - 1);
                                    if (bidAmount > currentBid) {
                                        setTimeout(() => {
                                            placeBid(bidAmount);
                                        }, 1000 + Math.random() * 1000); // Random delay 1-2 seconds
                                    }
                                }
                            }
                            
                            if (auctionChanged && gameData.auction.playersInAuction.includes(localPlayer.id)) {
                                showAuctionModal();
                            }
                        } else {
                            // Auction ended - close modal for everyone
                            if (oldGameData && oldGameData.auction && oldGameData.auction.active) {
                                hideModal();
                            }
                            
                            // Clear timer if auction ended
                            if (auctionTimerInterval) {
                                clearInterval(auctionTimerInterval);
                                auctionTimerInterval = null;
                            }
                        }
                        
                        // Check for incoming trade offer
                        if (gameData.trade && gameData.trade.toId === localPlayer.id && 
                            (!oldGameData || JSON.stringify(oldGameData.trade) !== JSON.stringify(gameData.trade))) {
                            // Trade popup otomatik gösterilmeyecek eğer "decide later" denmiş ise
                            const tradeId = gameData.trade.id || JSON.stringify(gameData.trade);
                            if (!decidedLaterTrades.includes(tradeId) && !shownTradeIds.has(tradeId)) {
                                shownTradeIds.add(tradeId);
                                showTradeOfferModal();
                            }
                        }
                    }
                    
                    // 🤖 Bot AI - if current player is a bot, make it move automatically
                    if (gameData.state === 'playing' && gameData.players && gameData.players[gameData.currentPlayerIndex] && 
                        gameData.players[gameData.currentPlayerIndex].id.startsWith('bot_') && 
                        gameData.players[gameData.currentPlayerIndex].id !== localPlayer.id &&
                        !window.isBotTurnInProgress) {
                        window.isBotTurnInProgress = true;
                        setTimeout(() => botTurn(), 1500); // Delay for better UX
                    }
                    
                    break;
                    
                case 'game_started':
                    gameData = message.game;
                    console.log('✅ Game started, rendering board...');
                    
                    // Ensure all players have joker cards
                    if (gameData && gameData.players) {
                        gameData.players = gameData.players.map(player => {
                            if (!player.jokerCards) {
                                player.jokerCards = {
                                    steal: 1,
                                    skip: 1,
                                    reroll: 1
                                };
                            }
                            if (player.secretTradesAvailable === undefined) {
                                player.secretTradesAvailable = 3;
                            }
                            return player;
                        });
                    }
                    
                    showGame();
                    setTimeout(() => {
                        renderBoard();
                        updateGameUI();
                    }, 100);
                    break;
                    
                case 'chat_message':
                    if (message.playerName !== localPlayer.name) {
                        addChatMessage(message.playerName, message.text);
                    }
                    break;
                    
                case 'games_list':
                    displayPublicGames(message.games);
                    break;
                    
                case 'error':
                    console.error('❌ Server error:', message.message);
                    lobbyError.textContent = message.message;
                    lobbyError.style.color = 'red';
                    
                    // Re-enable join button if it was disabled
                    if (joinGameBtn.disabled) {
                        joinGameBtn.disabled = false;
                        joinGameBtn.textContent = 'Join Game';
                    }
                    if (createGameBtn.disabled) {
                        createGameBtn.disabled = false;
                        createGameBtn.textContent = 'Create New Game';
                    }
                    
                    showModal('Error', message.message, [{text:'OK', class:'bg-red-500', action:hideModal}]);
                    break;
            }
        }

        async function updateGame(updates) {
            sendMessage({
                type: 'update_game',
                gameId: currentGameId,
                updates: updates
            });
        }

        // --- DOM ELEMENTS ---
        const lobby = document.getElementById('lobby');
        const gameSettingsScreen = document.getElementById('game-settings');
        const gameContainer = document.getElementById('game-container');
        
        const playerNameInput = document.getElementById('playerNameInput');
        const createGameBtn = document.getElementById('createGameBtn');
        const gameIdInput = document.getElementById('gameIdInput');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const lobbyError = document.getElementById('lobby-error');

        const displayGameId = document.getElementById('displayGameId');
        const copyGameIdBtn = document.getElementById('copyGameIdBtn');
        const propertiesEditor = document.getElementById('properties-editor');
        const startGameBtn = document.getElementById('startGameBtn');
        const lobbyPlayersList = document.getElementById('lobby-players-list');
        
        const board = document.getElementById('board');
        const playersInfo = document.getElementById('players-info');
        const rollDiceBtn = document.getElementById('rollDiceBtn');
        const endTurnBtn = document.getElementById('endTurnBtn');
        const managePropertiesBtn = document.getElementById('managePropertiesBtn');
        const jokerCardsBtn = document.getElementById('jokerCardsBtn');
        const dice1El = document.getElementById('dice1');
        const dice2El = document.getElementById('dice2');
        const gameLogEl = document.getElementById('game-log');

        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalButtons = document.getElementById('modal-buttons');

        // Property Buy Panel Elements
        const propertyBuyPanel = document.getElementById('property-buy-panel');
        const propertyBuyTitle = document.getElementById('property-buy-title');
        const propertyBuyName = document.getElementById('property-buy-name');
        const propertyBuyDesc = document.getElementById('property-buy-desc');
        const propertyBuyOptions = document.getElementById('property-buy-options');
        const propertyBuyClose = document.getElementById('property-buy-close');

        // Prevent clicks inside modal content from bubbling to modal overlay
        modalContent.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // 🎨 Dark Mode System
        const darkModeToggle = document.getElementById('darkModeToggle');
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        function applyDarkMode() {
            if (isDarkMode) {
                document.body.style.background = 'linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #0f0f0f 100%)';
                board.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%)';
                board.style.borderColor = '#00ffff';
                board.style.boxShadow = '0 0 40px rgba(0, 255, 255, 0.5), 0 25px 80px rgba(0,0,0,0.8)';
                darkModeToggle.innerHTML = '☀️ Light Mode';
                darkModeToggle.className = 'absolute top-4 right-4 bg-gradient-to-r from-yellow-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-yellow-600 hover:to-orange-700 transition-all shadow-lg text-sm font-bold z-20';
            } else {
                // Restore to current map theme
                applyMapTheme();
                darkModeToggle.innerHTML = '🌙 Dark Mode';
                darkModeToggle.className = 'absolute top-4 right-4 bg-gradient-to-r from-gray-700 to-gray-900 text-white px-4 py-2 rounded-lg hover:from-gray-800 hover:to-black transition-all shadow-lg text-sm font-bold z-20';
            }
        }
        
        if (darkModeToggle) {
            // Apply saved dark mode preference
            if (isDarkMode && gameData && gameData.state === 'playing') {
                applyDarkMode();
            }
            
            darkModeToggle.addEventListener('click', () => {
                isDarkMode = !isDarkMode;
                localStorage.setItem('darkMode', isDarkMode);
                applyDarkMode();
            });
        }

        // 📸 Screenshot System
        const screenshotBtn = document.getElementById('screenshotBtn');
        if (screenshotBtn) {
            screenshotBtn.addEventListener('click', async () => {
                try {
                    // Use html2canvas library if available, otherwise use native approach
                    const boardElement = document.getElementById('board');
                    
                    // Simple canvas approach
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const rect = boardElement.getBoundingClientRect();
                    canvas.width = rect.width * 2; // Higher resolution
                    canvas.height = rect.height * 2;
                    ctx.scale(2, 2);
                    
                    // Draw background
                    const bgStyle = window.getComputedStyle(boardElement).background;
                    ctx.fillStyle = bgStyle || '#f5e6d3';
                    ctx.fillRect(0, 0, rect.width, rect.height);
                    
                    // Convert canvas to blob
                    canvas.toBlob(async (blob) => {
                        const url = URL.createObjectURL(blob);
                        
                        // Download the image
                        const link = document.createElement('a');
                        link.download = `monopoly-game-${Date.now()}.png`;
                        link.href = url;
                        link.click();
                        
                        // Also try to share if supported
                        if (navigator.share && navigator.canShare) {
                            try {
                                const file = new File([blob], 'monopoly-game.png', { type: 'image/png' });
                                if (navigator.canShare({ files: [file] })) {
                                    await navigator.share({
                                        title: '🎲 My Monopoly Game!',
                                        text: 'Check out my Monopoly game!',
                                        files: [file]
                                    });
                                }
                            } catch (shareError) {
                                console.log('Share cancelled or not supported');
                            }
                        }
                        
                        URL.revokeObjectURL(url);
                        showModal('📸 Screenshot Saved!', 'Your game screenshot has been downloaded!', [
                            { text: 'OK', class: 'bg-green-500', action: hideModal }
                        ]);
                    }, 'image/png');
                    
                } catch (error) {
                    console.error('Screenshot error:', error);
                    showModal('Error', 'Could not take screenshot. Try again!', [
                        { text: 'OK', class: 'bg-red-500', action: hideModal }
                    ]);
                }
            });
        }

        // --- GAME STATE ---
        let localPlayer = { id: '', name: '' };
        let currentGameId = null;
        let gameData = null;
        const playerColors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
        let selectedGameMode = 'classic';
        let decidedLaterTrades = []; // Trade'ler için "decide later" takibi
        let shownTradeIds = new Set(); // Gösterilen trade ID'lerini takip et
        let turnTimer = null; // ⏰ Turn timer for auto-end turn

        // --- DEFAULT GAME DATA ---
        function getDefaultBoard() {
            return [
                { name: "GO", type: "go" },
                { name: "Mediterranean Ave", type: "property", price: 60, rent: [2, 10, 30, 90, 160, 250], color: "#a55a40", houseCost: 50 },
                { name: "Community Chest", type: "community_chest" },
                { name: "Baltic Ave", type: "property", price: 60, rent: [4, 20, 60, 180, 320, 450], color: "#a55a40", houseCost: 50 },
                { name: "Income Tax", type: "tax", amount: 200 },
                { name: "Reading Railroad", type: "railroad", price: 200 },
                { name: "Oriental Ave", type: "property", price: 100, rent: [6, 30, 90, 270, 400, 550], color: "#add8e6", houseCost: 50 },
                { name: "Chance", type: "chance" },
                { name: "Vermont Ave", type: "property", price: 100, rent: [6, 30, 90, 270, 400, 550], color: "#add8e6", houseCost: 50 },
                { name: "Connecticut Ave", type: "property", price: 120, rent: [8, 40, 100, 300, 450, 600], color: "#add8e6", houseCost: 50 },
                { name: "Jail / Just Visiting", type: "jail" },
                { name: "St. Charles Place", type: "property", price: 140, rent: [10, 50, 150, 450, 625, 750], color: "#d25298", houseCost: 100 },
                { name: "Electric Company", type: "utility", price: 150 },
                { name: "States Ave", type: "property", price: 140, rent: [10, 50, 150, 450, 625, 750], color: "#d25298", houseCost: 100 },
                { name: "Virginia Ave", type: "property", price: 160, rent: [12, 60, 180, 500, 700, 900], color: "#d25298", houseCost: 100 },
                { name: "Pennsylvania Railroad", type: "railroad", price: 200 },
                { name: "St. James Place", type: "property", price: 180, rent: [14, 70, 200, 550, 750, 950], color: "#f7941e", houseCost: 100 },
                { name: "Community Chest", type: "community_chest" },
                { name: "Tennessee Ave", type: "property", price: 180, rent: [14, 70, 200, 550, 750, 950], color: "#f7941e", houseCost: 100 },
                { name: "New York Ave", type: "property", price: 200, rent: [16, 80, 220, 600, 800, 1000], color: "#f7941e", houseCost: 100 },
                { name: "Free Parking", type: "free_parking" },
                { name: "Kentucky Ave", type: "property", price: 220, rent: [18, 90, 250, 700, 875, 1050], color: "#ed1c24", houseCost: 150 },
                { name: "Chance", type: "chance" },
                { name: "Indiana Ave", type: "property", price: 220, rent: [18, 90, 250, 700, 875, 1050], color: "#ed1c24", houseCost: 150 },
                { name: "Illinois Ave", type: "property", price: 240, rent: [20, 100, 300, 750, 925, 1100], color: "#ed1c24", houseCost: 150 },
                { name: "B. & O. Railroad", type: "railroad", price: 200 },
                { name: "Atlantic Ave", type: "property", price: 260, rent: [22, 110, 330, 800, 975, 1150], color: "#ffeb3b", houseCost: 150 },
                { name: "Ventnor Ave", type: "property", price: 260, rent: [22, 110, 330, 800, 975, 1150], color: "#ffeb3b", houseCost: 150 },
                { name: "Water Works", type: "utility", price: 150 },
                { name: "Marvin Gardens", type: "property", price: 280, rent: [24, 120, 360, 850, 1025, 1200], color: "#ffeb3b", houseCost: 150 },
                { name: "Go to Jail", type: "go_to_jail" },
                { name: "Pacific Ave", type: "property", price: 300, rent: [26, 130, 390, 900, 1100, 1275], color: "#4caf50", houseCost: 200 },
                { name: "North Carolina Ave", type: "property", price: 300, rent: [26, 130, 390, 900, 1100, 1275], color: "#4caf50", houseCost: 200 },
                { name: "Community Chest", type: "community_chest" },
                { name: "Pennsylvania Ave", type: "property", price: 320, rent: [28, 150, 450, 1000, 1200, 1400], color: "#4caf50", houseCost: 200 },
                { name: "Short Line", type: "railroad", price: 200 },
                { name: "Chance", type: "chance" },
                { name: "Park Place", type: "property", price: 350, rent: [35, 175, 500, 1100, 1300, 1500], color: "#2196f3", houseCost: 200 },
                { name: "Luxury Tax", type: "tax", amount: 100 },
                { name: "Boardwalk", type: "property", price: 400, rent: [50, 200, 600, 1400, 1700, 2000], color: "#2196f3", houseCost: 200 }
            ];
        }
        
        const defaultCards = {
            chance: [
                { text: "Advance to Go (Collect $200)", action: "move_to", space: 0, collect: true },
                { text: "Advance to Illinois Ave.", action: "move_to", space: 24 },
                { text: "Advance to St. Charles Place.", action: "move_to", space: 11 },
                { text: "Bank pays you dividend of $50.", action: "add_money", amount: 50 },
                { text: "Get Out of Jail Free.", action: "get_out_of_jail" },
                { text: "Go Back 3 Spaces.", action: "move_back", amount: 3 },
                { text: "Go to Jail. Go directly to Jail.", action: "go_to_jail" },
                { text: "Pay poor tax of $15.", action: "remove_money", amount: 15 },
                { text: "Your building loan matures. Collect $150.", action: "add_money", amount: 150 },
                { text: "Speeding fine $50.", action: "remove_money", amount: 50 },
                { text: "Pay school fees of $50.", action: "remove_money", amount: 50 },
                { text: "Take a trip to Reading Railroad.", action: "move_to", space: 5 },
                { text: "Advance to Boardwalk.", action: "move_to", space: 39 },
                { text: "Make general repairs on all properties. $25 per house, $100 per hotel.", action: "repair", house: 25, hotel: 100 },
            ],
            community_chest: [
                { text: "Advance to Go (Collect $200).", action: "move_to", space: 0, collect: true },
                { text: "Bank error in your favor. Collect $200.", action: "add_money", amount: 200 },
                { text: "Doctor's fees. Pay $50.", action: "remove_money", amount: 50 },
                { text: "From sale of stock you get $50.", action: "add_money", amount: 50 },
                { text: "Get Out of Jail Free.", action: "get_out_of_jail" },
                { text: "Go to Jail. Go directly to Jail.", action: "go_to_jail" },
                { text: "Holiday fund matures. Receive $100.", action: "add_money", amount: 100 },
                { text: "Income tax refund. Collect $20.", action: "add_money", amount: 20 },
                { text: "Life insurance matures. Collect $100.", action: "add_money", amount: 100 },
                { text: "Pay hospital fees of $100.", action: "remove_money", amount: 100 },
                { text: "You inherit $100.", action: "add_money", amount: 100 },
                { text: "You have won second prize in a beauty contest. Collect $10.", action: "add_money", amount: 10 },
                { text: "Receive $25 consultancy fee.", action: "add_money", amount: 25 },
                { text: "Street repairs. $40 per house, $115 per hotel.", action: "repair", house: 40, hotel: 115 },
            ]
        };
        
        // Game Mode Presets
        const gameModes = {
            classic: { startingMoney: 1500, passGoAmount: 200, multiplier: 1, noLuck: false, name: "Classic" },
            fast: { startingMoney: 3000, passGoAmount: 400, multiplier: 2, noLuck: false, name: "Fast Money" },
            hard: { startingMoney: 1000, passGoAmount: 150, multiplier: 0.75, noLuck: false, name: "Hard Mode" },
            noluck: { startingMoney: 1500, passGoAmount: 200, multiplier: 1, noLuck: true, name: "No Luck" },
            mega: { startingMoney: 7500, passGoAmount: 1000, multiplier: 5, noLuck: false, name: "Mega Rich" },
            speed: { startingMoney: 2000, passGoAmount: 300, multiplier: 1.5, noLuck: false, name: "Speed Game" }
        };

        // --- CHARACTER & MAP SELECTION ---
        let selectedCharacter = ''; // No default, user must choose
        let selectedMap = '';

        const characterIcons = {
          car: '🚗', hat: '🎩', dog: '🐕', shoe: '👞', iron: '🧲', ship: '🚢', cat: '🐈', money: '💰'
        };

        // 🎵 Sound Effects System using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'dice':
                    // Dice roll sound - quick rattle
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                    break;
                    
                case 'purchase':
                    // Cash register cha-ching
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                    
                case 'jail':
                    // Jail door slam - low thud
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(100, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                    
                case 'win':
                    // Victory fanfare
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.15);
                    oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
            }
        }

        // 💫 Confetti Animation for Property Purchase
        function createConfetti(x, y) {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500'];
            const confettiCount = 30;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.left = x + 'px';
                confetti.style.top = y + 'px';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.zIndex = '9999';
                confetti.style.pointerEvents = 'none';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                
                document.body.appendChild(confetti);
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 100 + Math.random() * 100;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity - 200;
                
                let posX = x;
                let posY = y;
                let velX = vx;
                let velY = vy;
                const gravity = 500;
                let opacity = 1;
                
                const startTime = Date.now();
                const duration = 2000;
                
                function animate() {
                    const elapsed = Date.now() - startTime;
                    const dt = 0.016;
                    
                    velY += gravity * dt;
                    posX += velX * dt;
                    posY += velY * dt;
                    opacity = 1 - (elapsed / duration);
                    
                    confetti.style.left = posX + 'px';
                    confetti.style.top = posY + 'px';
                    confetti.style.opacity = opacity;
                    confetti.style.transform = `rotate(${elapsed / 10}deg)`;
                    
                    if (elapsed < duration && opacity > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        confetti.remove();
                    }
                }
                
                requestAnimationFrame(animate);
            }
        }

        // 🎨 Animate Property Card on Purchase
        function animatePropertyPurchase(position, ownerColor) {
            const spaceEl = document.getElementById(`space-${position}`);
            if (!spaceEl) return;
            
            // Get position for confetti
            const rect = spaceEl.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Trigger confetti
            createConfetti(centerX, centerY);
            
            // Animate the space card
            spaceEl.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            spaceEl.style.transform = 'scale(1.2)';
            spaceEl.style.boxShadow = `0 0 30px ${ownerColor}`;
            
            setTimeout(() => {
                spaceEl.style.transform = 'scale(1)';
                spaceEl.style.boxShadow = '';
            }, 500);
        }

        const mapBoards = {
          classic: getDefaultBoard(),
          
          turkey: [
            { name: "BAŞLANGIÇ", type: "go" },
            { name: "İstanbul - Kadıköy", type: "property", price: 80, rent: [6,30,90,270,400,550], color: "#a55a40", houseCost: 50 },
            { name: "Kamu Sandığı", type: "community_chest" },
            { name: "Ankara - Kızılay", type: "property", price: 80, rent: [8,40,100,300,450,600], color: "#a55a40", houseCost: 50 },
            { name: "Gelir Vergisi", type: "tax", amount: 200 },
            { name: "TCDD Tren Hattı", type: "railroad", price: 200 },
            { name: "İzmir - Alsancak", type: "property", price: 120, rent: [10,50,150,450,625,750], color: "#add8e6", houseCost: 50 },
            { name: "Şans", type: "chance" },
            { name: "Antalya - Kaleiçi", type: "property", price: 120, rent: [10,50,150,450,625,750], color: "#add8e6", houseCost: 50 },
            { name: "Bursa - Osmangazi", type: "property", price: 140, rent: [12,60,180,500,700,900], color: "#add8e6", houseCost: 50 },
            { name: "Hapishane / Ziyaret", type: "jail" },
            { name: "Trabzon", type: "property", price: 160, rent: [14,70,200,550,750,950], color: "#d25298", houseCost: 100 },
            { name: "Elektrik Şirketi", type: "utility", price: 150 },
            { name: "Gaziantep", type: "property", price: 160, rent: [14,70,200,550,750,950], color: "#d25298", houseCost: 100 },
            { name: "Adana", type: "property", price: 180, rent: [16,80,220,600,800,1000], color: "#d25298", houseCost: 100 },
            { name: "THY Hava Yolu", type: "railroad", price: 200 },
            { name: "Eskişehir", type: "property", price: 200, rent: [18,90,250,700,875,1050], color: "#f7941e", houseCost: 100 },
            { name: "Kamu Sandığı", type: "community_chest" },
            { name: "Konya", type: "property", price: 200, rent: [18,90,250,700,875,1050], color: "#f7941e", houseCost: 100 },
            { name: "Kayseri", type: "property", price: 220, rent: [20,100,300,750,925,1100], color: "#f7941e", houseCost: 100 },
            { name: "Ücretsiz Park", type: "free_parking" },
            { name: "Bodrum", type: "property", price: 240, rent: [22,110,330,800,975,1150], color: "#ed1c24", houseCost: 150 },
            { name: "Şans", type: "chance" },
            { name: "Çeşme", type: "property", price: 240, rent: [22,110,330,800,975,1150], color: "#ed1c24", houseCost: 150 },
            { name: "Marmaris", type: "property", price: 260, rent: [24,120,360,850,1025,1200], color: "#ed1c24", houseCost: 150 },
            { name: "İDO Deniz Otobüsü", type: "railroad", price: 200 },
            { name: "İstanbul - Nişantaşı", type: "property", price: 280, rent: [26,130,390,900,1100,1275], color: "#ffeb3b", houseCost: 150 },
            { name: "Ankara - Çankaya", type: "property", price: 280, rent: [26,130,390,900,1100,1275], color: "#ffeb3b", houseCost: 150 },
            { name: "Su Şirketi", type: "utility", price: 150 },
            { name: "İzmir - Karşıyaka", type: "property", price: 300, rent: [28,150,450,1000,1200,1400], color: "#ffeb3b", houseCost: 150 },
            { name: "Hapse Git", type: "go_to_jail" },
            { name: "İstanbul - Bebek", type: "property", price: 320, rent: [30,160,480,1100,1300,1500], color: "#4caf50", houseCost: 200 },
            { name: "Ankara - Bilkent", type: "property", price: 320, rent: [30,160,480,1100,1300,1500], color: "#4caf50", houseCost: 200 },
            { name: "Kamu Sandığı", type: "community_chest" },
            { name: "İstanbul - Etiler", type: "property", price: 350, rent: [35,175,500,1200,1400,1600], color: "#4caf50", houseCost: 200 },
            { name: "Marmaray", type: "railroad", price: 200 },
            { name: "Şans", type: "chance" },
            { name: "İstanbul - Tarabya", type: "property", price: 380, rent: [40,200,600,1400,1700,2000], color: "#2196f3", houseCost: 200 },
            { name: "Lüks Vergi", type: "tax", amount: 150 },
            { name: "İstanbul - Emirgan", type: "property", price: 420, rent: [50,250,750,1600,1900,2200], color: "#2196f3", houseCost: 200 }
          ],
          
          world: [
            { name: "START", type: "go" },
            { name: "New York - Brooklyn", type: "property", price: 70, rent: [5,25,75,225,350,500], color: "#a55a40", houseCost: 50 },
            { name: "Community Chest", type: "community_chest" },
            { name: "London - Soho", type: "property", price: 70, rent: [7,35,105,315,450,625], color: "#a55a40", houseCost: 50 },
            { name: "Income Tax", type: "tax", amount: 200 },
            { name: "International Airport", type: "railroad", price: 200 },
            { name: "Paris - Montmartre", type: "property", price: 110, rent: [9,45,135,405,575,750], color: "#add8e6", houseCost: 50 },
            { name: "Chance", type: "chance" },
            { name: "Berlin - Mitte", type: "property", price: 110, rent: [9,45,135,405,575,750], color: "#add8e6", houseCost: 50 },
            { name: "Tokyo - Shibuya", type: "property", price: 130, rent: [11,55,165,495,700,900], color: "#add8e6", houseCost: 50 },
            { name: "Jail / Just Visiting", type: "jail" },
            { name: "Rome - Colosseum", type: "property", price: 150, rent: [13,65,195,575,800,1025], color: "#d25298", houseCost: 100 },
            { name: "Power Company", type: "utility", price: 150 },
            { name: "Madrid - Plaza Mayor", type: "property", price: 150, rent: [13,65,195,575,800,1025], color: "#d25298", houseCost: 100 },
            { name: "Barcelona - Gothic Quarter", type: "property", price: 170, rent: [15,75,225,625,875,1100], color: "#d25298", houseCost: 100 },
            { name: "Trans-Europe Railway", type: "railroad", price: 200 },
            { name: "Amsterdam - Canal District", type: "property", price: 190, rent: [17,85,255,725,950,1200], color: "#f7941e", houseCost: 100 },
            { name: "Community Chest", type: "community_chest" },
            { name: "Brussels - Grand Place", type: "property", price: 190, rent: [17,85,255,725,950,1200], color: "#f7941e", houseCost: 100 },
            { name: "Vienna - Ringstrasse", type: "property", price: 210, rent: [19,95,285,775,1025,1300], color: "#f7941e", houseCost: 100 },
            { name: "Free Parking", type: "free_parking" },
            { name: "Sydney - Opera House", type: "property", price: 230, rent: [21,105,315,850,1100,1400], color: "#ed1c24", houseCost: 150 },
            { name: "Chance", type: "chance" },
            { name: "Dubai - Marina", type: "property", price: 230, rent: [21,105,315,850,1100,1400], color: "#ed1c24", houseCost: 150 },
            { name: "Singapore - Marina Bay", type: "property", price: 250, rent: [23,115,345,900,1150,1500], color: "#ed1c24", houseCost: 150 },
            { name: "Pacific Airlines", type: "railroad", price: 200 },
            { name: "Hong Kong - Victoria Peak", type: "property", price: 270, rent: [25,125,375,950,1200,1600], color: "#ffeb3b", houseCost: 150 },
            { name: "Shanghai - Bund", type: "property", price: 270, rent: [25,125,375,950,1200,1600], color: "#ffeb3b", houseCost: 150 },
            { name: "Water Works", type: "utility", price: 150 },
            { name: "Mumbai - Gateway of India", type: "property", price: 290, rent: [27,135,405,1000,1250,1700], color: "#ffeb3b", houseCost: 150 },
            { name: "Go to Jail", type: "go_to_jail" },
            { name: "New York - Manhattan", type: "property", price: 310, rent: [29,145,435,1050,1300,1800], color: "#4caf50", houseCost: 200 },
            { name: "London - Mayfair", type: "property", price: 310, rent: [29,145,435,1050,1300,1800], color: "#4caf50", houseCost: 200 },
            { name: "Community Chest", type: "community_chest" },
            { name: "Paris - Champs-Élysées", type: "property", price: 340, rent: [33,165,495,1150,1400,1950], color: "#4caf50", houseCost: 200 },
            { name: "Global Express", type: "railroad", price: 200 },
            { name: "Chance", type: "chance" },
            { name: "Tokyo - Ginza", type: "property", price: 370, rent: [38,190,570,1300,1600,2100], color: "#2196f3", houseCost: 200 },
            { name: "Luxury Tax", type: "tax", amount: 150 },
            { name: "Monaco - Monte Carlo", type: "property", price: 410, rent: [48,240,720,1600,2000,2400], color: "#2196f3", houseCost: 200 }
          ],
          
          holland: [
            { name: "START", type: "go" },
            { name: "Amsterdam - Jordaan", type: "property", price: 75, rent: [6,30,90,270,400,550], color: "#a55a40", houseCost: 50 },
            { name: "Gemeenschap Kas", type: "community_chest" },
            { name: "Rotterdam - Delfshaven", type: "property", price: 75, rent: [8,40,100,300,450,600], color: "#a55a40", houseCost: 50 },
            { name: "Inkomstenbelasting", type: "tax", amount: 200 },
            { name: "NS Spoorweg", type: "railroad", price: 200 },
            { name: "Utrecht - Oudegracht", type: "property", price: 115, rent: [10,50,150,450,625,750], color: "#add8e6", houseCost: 50 },
            { name: "Kans", type: "chance" },
            { name: "Den Haag - Binnenhof", type: "property", price: 115, rent: [10,50,150,450,625,750], color: "#add8e6", houseCost: 50 },
            { name: "Groningen - Grote Markt", type: "property", price: 135, rent: [12,60,180,500,700,900], color: "#add8e6", houseCost: 50 },
            { name: "Gevangenis / Bezoek", type: "jail" },
            { name: "Eindhoven - Strijp-S", type: "property", price: 155, rent: [14,70,200,550,750,950], color: "#d25298", houseCost: 100 },
            { name: "Elektriciteitsbedrijf", type: "utility", price: 150 },
            { name: "Leiden - Burcht", type: "property", price: 155, rent: [14,70,200,550,750,950], color: "#d25298", houseCost: 100 },
            { name: "Delft - Markt", type: "property", price: 175, rent: [16,80,220,600,800,1000], color: "#d25298", houseCost: 100 },
            { name: "Connexxion Bus", type: "railroad", price: 200 },
            { name: "Haarlem - Grote Markt", type: "property", price: 195, rent: [18,90,250,700,875,1050], color: "#f7941e", houseCost: 100 },
            { name: "Gemeenschap Kas", type: "community_chest" },
            { name: "Maastricht - Vrijthof", type: "property", price: 195, rent: [18,90,250,700,875,1050], color: "#f7941e", houseCost: 100 },
            { name: "Nijmegen - Waalkade", type: "property", price: 215, rent: [20,100,300,750,925,1100], color: "#f7941e", houseCost: 100 },
            { name: "Gratis Parkeren", type: "free_parking" },
            { name: "Amsterdam - De Pijp", type: "property", price: 235, rent: [22,110,330,800,975,1150], color: "#ed1c24", houseCost: 150 },
            { name: "Kans", type: "chance" },
            { name: "Rotterdam - Katendrecht", type: "property", price: 235, rent: [22,110,330,800,975,1150], color: "#ed1c24", houseCost: 150 },
            { name: "Utrecht - Museum Quarter", type: "property", price: 255, rent: [24,120,360,850,1025,1200], color: "#ed1c24", houseCost: 150 },
            { name: "GVB Tram", type: "railroad", price: 200 },
            { name: "Amsterdam - Oud-Zuid", type: "property", price: 275, rent: [26,130,390,900,1100,1275], color: "#ffeb3b", houseCost: 150 },
            { name: "Den Haag - Scheveningen", type: "property", price: 275, rent: [26,130,390,900,1100,1275], color: "#ffeb3b", houseCost: 150 },
            { name: "Waterbedrijf", type: "utility", price: 150 },
            { name: "Rotterdam - Kralingen", type: "property", price: 295, rent: [28,150,450,1000,1200,1400], color: "#ffeb3b", houseCost: 150 },
            { name: "Ga Naar Gevangenis", type: "go_to_jail" },
            { name: "Amsterdam - Centrum", type: "property", price: 315, rent: [30,160,480,1100,1300,1500], color: "#4caf50", houseCost: 200 },
            { name: "Rotterdam - Centrum", type: "property", price: 315, rent: [30,160,480,1100,1300,1500], color: "#4caf50", houseCost: 200 },
            { name: "Gemeenschap Kas", type: "community_chest" },
            { name: "Den Haag - Centrum", type: "property", price: 345, rent: [35,175,500,1200,1400,1600], color: "#4caf50", houseCost: 200 },
            { name: "Metro Amsterdam", type: "railroad", price: 200 },
            { name: "Kans", type: "chance" },
            { name: "Amsterdam - Grachtengordel", type: "property", price: 375, rent: [40,200,600,1400,1700,2000], color: "#2196f3", houseCost: 200 },
            { name: "Luxe Belasting", type: "tax", amount: 150 },
            { name: "Amsterdam - Museum Quarter", type: "property", price: 415, rent: [50,250,750,1600,1900,2200], color: "#2196f3", houseCost: 200 }
          ],
          
          megarich: [
            { name: "START", type: "go" },
            { name: "Budget District", type: "property", price: 50, rent: [10,50,150,450,800,1200], color: "#8b4513", houseCost: 25 },
            { name: "Cheap Avenue", type: "property", price: 60, rent: [12,60,180,500,900,1400], color: "#8b4513", houseCost: 25 },
            { name: "Thrift Street", type: "property", price: 80, rent: [15,75,225,650,1100,1600], color: "#a55a40", houseCost: 30 },
            { name: "Economy Lane", type: "property", price: 100, rent: [20,100,300,750,1300,1800], color: "#a55a40", houseCost: 30 },
            { name: "Market Place", type: "property", price: 120, rent: [25,125,375,900,1500,2000], color: "#a55a40", houseCost: 30 },
            { name: "Free Parking", type: "free_parking" },
            { name: "Standard Plaza", type: "property", price: 200, rent: [40,200,600,1400,2200,3000], color: "#add8e6", houseCost: 50 },
            { name: "Common Boulevard", type: "property", price: 250, rent: [50,250,750,1800,2700,3600], color: "#add8e6", houseCost: 50 },
            { name: "Regular Street", type: "property", price: 300, rent: [60,300,900,2200,3300,4400], color: "#add8e6", houseCost: 50 },
            { name: "Middle Avenue", type: "property", price: 400, rent: [80,400,1200,2800,4200,5600], color: "#d25298", houseCost: 75 },
            { name: "Jail / Just Visiting", type: "jail" },
            { name: "Good Quarter", type: "property", price: 500, rent: [100,500,1500,3500,5000,6500], color: "#d25298", houseCost: 75 },
            { name: "Nice District", type: "property", price: 600, rent: [120,600,1800,4200,6000,7800], color: "#d25298", houseCost: 75 },
            { name: "Quality Street", type: "property", price: 750, rent: [150,750,2250,5000,7000,9000], color: "#f7941e", houseCost: 100 },
            { name: "Premium Place", type: "property", price: 900, rent: [180,900,2700,6000,8400,10800], color: "#f7941e", houseCost: 100 },
            { name: "Fine Avenue", type: "property", price: 1100, rent: [220,1100,3300,7500,10500,13500], color: "#f7941e", houseCost: 100 },
            { name: "Free Parking", type: "free_parking" },
            { name: "Upscale Boulevard", type: "property", price: 1300, rent: [260,1300,3900,9000,12600,16200], color: "#ed1c24", houseCost: 150 },
            { name: "Expensive Plaza", type: "property", price: 1500, rent: [300,1500,4500,10500,14700,18900], color: "#ed1c24", houseCost: 150 },
            { name: "Luxury Lane", type: "property", price: 1800, rent: [360,1800,5400,12600,17600,22600], color: "#ed1c24", houseCost: 150 },
            { name: "Elite Street", type: "property", price: 2100, rent: [420,2100,6300,14700,20600,26500], color: "#ffeb3b", houseCost: 200 },
            { name: "Go to Jail", type: "go_to_jail" },
            { name: "Exclusive Avenue", type: "property", price: 2500, rent: [500,2500,7500,17500,24500,31500], color: "#ffeb3b", houseCost: 200 },
            { name: "Prestige Plaza", type: "property", price: 2900, rent: [580,2900,8700,20300,28400,36500], color: "#ffeb3b", houseCost: 200 },
            { name: "VIP Quarter", type: "property", price: 3300, rent: [660,3300,9900,23100,32300,41500], color: "#4caf50", houseCost: 250 },
            { name: "Royal District", type: "property", price: 3800, rent: [760,3800,11400,26600,37200,47800], color: "#4caf50", houseCost: 250 },
            { name: "Imperial Street", type: "property", price: 4300, rent: [860,4300,12900,30100,42100,54100], color: "#4caf50", houseCost: 250 },
            { name: "Free Parking", type: "free_parking" },
            { name: "Diamond Avenue", type: "property", price: 4800, rent: [960,4800,14400,33600,47000,60400], color: "#2196f3", houseCost: 300 },
            { name: "Platinum Boulevard", type: "property", price: 5000, rent: [1000,5000,15000,35000,49000,63000], color: "#2196f3", houseCost: 300 }
          ],
          
          custom: getDefaultBoard()
        };

        // Character selection
        const characterBtns = document.querySelectorAll('.character-btn');
        
        // Function to update character button availability
        function updateCharacterAvailability() {
            if (!gameData || !gameData.players) return;
            
            // Get list of taken characters (excluding local player)
            const takenCharacters = gameData.players
                .filter(p => p.id !== localPlayer.id)
                .map(p => p.character);
            
            characterBtns.forEach(btn => {
                const char = btn.dataset.char;
                const isTaken = takenCharacters.includes(char);
                
                if (isTaken) {
                    // Disable taken characters
                    btn.disabled = true;
                    btn.style.opacity = '0.3';
                    btn.style.cursor = 'not-allowed';
                    btn.style.filter = 'grayscale(100%)';
                    btn.title = 'Bu karakter başka bir oyuncu tarafından seçildi';
                } else {
                    // Enable available characters
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.filter = 'none';
                    btn.title = '';
                }
            });
        }
        
        characterBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            // Check if character is taken
            if (this.disabled) {
                alert('Bu karakter başka bir oyuncu tarafından seçildi. Lütfen başka bir karakter seçin.');
                return;
            }
            
            // Remove selection from all
            characterBtns.forEach(b => {
                b.classList.remove('border-blue-500', 'bg-blue-50', 'border-4');
                b.style.boxShadow = '';
                b.style.transform = '';
            });
            
            // Add strong visual selection
            this.classList.add('border-blue-500', 'bg-blue-50', 'border-4');
            this.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.8)';
            this.style.transform = 'scale(1.1)';
            
            selectedCharacter = this.dataset.char;
            console.log(`✅ Character selected: ${selectedCharacter}`);
            
            // Visual feedback for mobile
            const emoji = this.textContent;
            lobbyError.textContent = `Selected: ${emoji}`;
            lobbyError.style.color = '#3b82f6';
            setTimeout(() => {
                lobbyError.textContent = '';
                lobbyError.style.color = '';
            }, 2000);
          });
        });
        // Don't auto-select first character - let user choose
        // characterBtns[0].click();

        // Map selection
        const mapBtns = document.querySelectorAll('.map-btn');
        const mapPreview = document.getElementById('map-preview');
        const mapNames = {
            classic: '🏛️ Classic',
            turkey: '🇹🇷 Türkiye',
            world: '🌍 World',
            holland: '🇳🇱 Holland',
            megarich: '💎 Mega Rich',
            custom: '⚙️ Custom'
        };
        mapBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        mapBtns.forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
                        this.classList.add('border-blue-500', 'bg-blue-50');
                        selectedMap = this.dataset.map;
                        
                        // Update both preview elements (main menu and lobby)
                        const mainMapPreview = document.getElementById('main-map-preview');
                        if (mapPreview) {
                                mapPreview.textContent = `(${mapNames[selectedMap]} selected)`;
                        }
                        if (mainMapPreview) {
                                mainMapPreview.textContent = `(${mapNames[selectedMap]} selected)`;
                        }
                        
                        console.log('✅ Selected map:', selectedMap);
                    });
                });
                // Otomatik map seçimi kaldırıldı. Kullanıcı bir map seçmeli.

        // Game mode selection
        const gameModeBtns = document.querySelectorAll('.game-mode-btn');
        gameModeBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            gameModeBtns.forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
            this.classList.add('border-blue-500', 'bg-blue-50');
            selectedGameMode = this.dataset.mode;
            
            // Update settings based on game mode
            const mode = gameModes[selectedGameMode];
            if (mode) {
                document.getElementById('startingMoney').value = mode.startingMoney;
                document.getElementById('passGoAmount').value = mode.passGoAmount;
            }
            console.log('✅ Selected game mode:', selectedGameMode);
          });
        });
        if (gameModeBtns.length > 0) gameModeBtns[0].click();

        // --- LOBBY LOGIC ---
        createGameBtn.addEventListener('click', async () => {
            console.log('🆕 Create Game button clicked');
            addDebugLog('🆕 CREATE CLICKED');
            
            // Disable button and show loading
            createGameBtn.disabled = true;
            createGameBtn.textContent = 'Creating...';
            lobbyError.textContent = '';
            lobbyError.style.color = '';
            
            if (!validatePlayerName()) {
                addDebugLog('❌ NAME INVALID');
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Create New Game';
                return;
            }
            addDebugLog('✅ Name valid: ' + localPlayer.name);
            
            // Check if character is selected
            if (!selectedCharacter) {
                addDebugLog('❌ NO CHARACTER');
                showModal('Character Required', 'Please select a character before creating the game!', [{text: 'OK', class: 'bg-red-500', action: hideModal}]);
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Create New Game';
                return;
            }
            addDebugLog('✅ Character: ' + selectedCharacter);
            
            // Check WebSocket connection
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('❌ WebSocket not connected');
                addDebugLog('❌ WS NOT CONNECTED');
                lobbyError.textContent = 'Connecting to server...';
                lobbyError.style.color = 'orange';
                connectWebSocket();
                
                setTimeout(() => {
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        lobbyError.textContent = 'Connection failed. Please refresh the page.';
                        lobbyError.style.color = 'red';
                        createGameBtn.disabled = false;
                        createGameBtn.textContent = 'Create New Game';
                    } else {
                        createGameBtn.click();
                    }
                }, 2000);
                return;
            }
            addDebugLog('✅ WS Connected');
            
            // Eğer harita seçilmemişse varsayılan olarak Classic kullan
            if (!selectedMap) {
                selectedMap = 'classic';
                console.log('⚠️ No map selected, defaulting to classic');
                addDebugLog('⚠️ Map defaulted to classic');
            }
            addDebugLog('✅ Map: ' + selectedMap);
            
            console.log('🎮 CREATE GAME CLICKED!');
            console.log('📍 selectedMap variable:', selectedMap);
            console.log('📍 selectedCharacter:', selectedCharacter);
            console.log('📍 selectedGameMode:', selectedGameMode);
            
            const gameId = generateGameId();
            currentGameId = gameId;
            
            const hostPlayer = {
                id: localPlayer.id,
                name: localPlayer.name,
                color: playerColors[0],
                money: parseInt(document.getElementById('startingMoney').value),
                position: 0,
                character: selectedCharacter,
                team: '', // No team at start, can join later
                getOutOfJailCards: 0,
                bankrupt: false
            };

            const mode = gameModes[selectedGameMode];
            
            try {
                console.log('🎮 Creating game with map:', selectedMap);
                console.log('📋 mapBoards object keys:', Object.keys(mapBoards));
                console.log('📋 mapBoards[selectedMap] exists?', selectedMap in mapBoards);
                console.log('📋 Board data:', mapBoards[selectedMap]);
                console.log('📍 First 5 spaces:', mapBoards[selectedMap].slice(0, 5).map(s => s.name));
                
                addDebugLog('📤 Sending create_game...');
                
                sendMessage({
                    type: 'create_game',
                    gameId: gameId,
                    hostId: localPlayer.id,
                    player: hostPlayer,
                    private: document.getElementById('privateGameCheckbox').checked,
                    settings: {
                        startingMoney: parseInt(document.getElementById('startingMoney').value),
                        passGoAmount: parseInt(document.getElementById('passGoAmount').value),
                        maxPlayers: parseInt(document.getElementById('playerCount').value),
                        auctionTimer: parseInt(document.getElementById('auctionTimer').value),
                        allowTrading: document.getElementById('allowTrading').checked,
                        gameMode: selectedGameMode,
                        noLuck: mode.noLuck,
                        board: mapBoards[selectedMap],
                        map: selectedMap,
                        chanceCards: mode.noLuck ? [] : defaultCards.chance,
                        communityChestCards: mode.noLuck ? [] : defaultCards.community_chest,
                    }
                });
                console.log('✅ Game creation message sent:', gameId);
                addDebugLog('✅ Create msg sent: ' + gameId);
            } catch (error) {
                console.error("❌ Error creating game:", error);
                addDebugLog('❌ CREATE ERROR: ' + error.message);
                lobbyError.textContent = `Error: ${error.message}. Check connection.`;
                lobbyError.style.color = 'red';
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Create New Game';
            }
        });

        joinGameBtn.addEventListener('click', async () => {
            console.log('🔘 Join Game button clicked');
            console.log('📝 Player name:', playerNameInput.value);
            console.log('🎭 Selected character:', selectedCharacter);
            console.log('🎮 Game ID:', gameIdInput.value);
            console.log('🔌 WebSocket state:', ws ? ws.readyState : 'null');
            addDebugLog('🔘 JOIN CLICKED');
            
            // Visual feedback - disable button
            joinGameBtn.disabled = true;
            joinGameBtn.textContent = 'Joining...';
            lobbyError.textContent = '';
            lobbyError.style.color = '';
            
            // Allow joining even if game is playing
            if (!validatePlayerName()) {
                console.log('❌ Name validation failed');
                addDebugLog('❌ NAME INVALID');
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
                return;
            }
            
            // Check if character is selected
            if (!selectedCharacter) {
                console.log('❌ No character selected');
                addDebugLog('❌ NO CHARACTER');
                showModal('Character Required', 'Please select a character before joining!', [{text: 'OK', class: 'bg-red-500', action: hideModal}]);
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
                return;
            }
            
            const gameId = gameIdInput.value.trim().toUpperCase();
            if (!gameId) {
                console.log('❌ No game ID');
                addDebugLog('❌ NO GAME ID');
                lobbyError.textContent = 'Please enter a Game ID.';
                lobbyError.style.color = 'red';
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
                return;
            }
            currentGameId = gameId;

            if (!currentGameId) {
                showModal('Error', 'Game ID is missing. Lütfen geçerli bir oyun kodu girin.', [{text:'Tamam', class:'bg-red-500', action:hideModal}]);
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
                return;
            }
            
            // Check WebSocket connection
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('❌ WebSocket not connected, attempting to reconnect...');
                addDebugLog('❌ WS NOT CONNECTED! State: ' + (ws ? ws.readyState : 'null'));
                lobbyError.textContent = 'Connecting to server...';
                lobbyError.style.color = 'orange';
                connectWebSocket();
                
                // Wait a bit for connection
                setTimeout(() => {
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        lobbyError.textContent = 'Connection failed. Please refresh the page.';
                        lobbyError.style.color = 'red';
                        addDebugLog('❌ RECONNECT FAILED');
                        joinGameBtn.disabled = false;
                        joinGameBtn.textContent = 'Join Game';
                    } else {
                        // Retry join
                        addDebugLog('✅ RECONNECTED, RETRY');
                        joinGameBtn.click();
                    }
                }, 2000);
                return;
            }

            try {
                const newPlayer = {
                    id: localPlayer.id,
                    name: localPlayer.name,
                    color: playerColors[Math.floor(Math.random()*playerColors.length)],
                    position: 0,
                    character: selectedCharacter,
                    team: '', // No team at start
                    getOutOfJailCards: 0,
                    bankrupt: false,
                    secretTradesAvailable: 3, // Gizli trade hakları (başlangıç: 3)
                    jokerCards: {
                        steal: 1, // Kart çalma joker'i
                        skip: 1, // Tur atlama joker'i
                        reroll: 1 // Zar tekrar atma joker'i
                    }
                };
                
                console.log('📤 Sending join_game message:', newPlayer);
                addDebugLog('📤 SENDING JOIN MSG');
                lobbyError.textContent = 'Joining game...';
                lobbyError.style.color = 'blue';
                
                sendMessage({
                    type: 'join_game',
                    gameId: gameId,
                    player: newPlayer
                });

                console.log('✅ Join message sent to game:', gameId);
                
                // Set timeout to re-enable button if no response
                setTimeout(() => {
                    if (joinGameBtn.disabled) {
                        console.log('⚠️ No response from server after 5 seconds');
                        addDebugLog('⚠️ NO RESPONSE (5s)');
                        lobbyError.textContent = 'No response from server. Check Game ID or try again.';
                        lobbyError.style.color = 'red';
                        joinGameBtn.disabled = false;
                        joinGameBtn.textContent = 'Join Game';
                    }
                }, 5000);
                
            } catch (error) {
                console.error("❌ Error joining game:", error);
                addDebugLog('❌ JOIN ERROR: ' + error.message);
                lobbyError.textContent = `Error: ${error.message}. Check game ID.`;
                lobbyError.style.color = 'red';
                joinGameBtn.disabled = false;
                joinGameBtn.textContent = 'Join Game';
            }
        });
        
        // 🤖 Add Bot Player
        const addBotBtn = document.getElementById('addBotBtn');
        addBotBtn.addEventListener('click', () => {
            // Coming Soon - Bots disabled
            showModal('🤖 Bots Coming Soon!', 
                '<p class="text-center">Bot players are currently under development and will be available in a future update!</p><p class="text-center mt-4 text-gray-600">Stay tuned! 🚀</p>', 
                [{text: 'OK', class: 'bg-blue-500', action: hideModal}]
            );
        });
        
        // Add Bot button
        addBotBtn.addEventListener('click', () => {
            sendMessage({
                type: 'add_bot'
            });
        });

        startGameBtn.addEventListener('click', async () => {
            if (gameData.players.length < 2) {
                showModal("Not Enough Players", "You need at least 2 players to start the game.", [{ text: 'OK', class: 'bg-blue-500', action: hideModal }]);
                return;
            }

            // Save final settings
            const settings = {
                startingMoney: parseInt(document.getElementById('startingMoney').value),
                passGoAmount: parseInt(document.getElementById('passGoAmount').value),
                maxPlayers: parseInt(document.getElementById('playerCount').value),
                allowTrading: document.getElementById('allowTrading').checked,
                allowDoubles: document.getElementById('allowDoubles').checked,
                board: gameData.settings.board, // Use the board that was set during game creation
                map: gameData.settings.map, // Preserve the map selection
                chanceCards: defaultCards.chance, 
                communityChestCards: defaultCards.community_chest,
            };
            
            console.log('🎮 Starting game with map:', gameData.settings.map);
            console.log('📍 Board has', settings.board.length, 'spaces');
            console.log('📍 First property:', settings.board[1]?.name);
            
            // 🌟 Select random lucky player for bonus
            const luckyPlayerIndex = Math.floor(Math.random() * gameData.players.length);
            
            // Initialize game state properties for each player
            const initializedPlayers = gameData.players.map((p, i) => ({
                ...p,
                money: settings.startingMoney,
                position: 0,
                properties: [],
                inJail: false,
                jailTurns: 0,
                getOutOfJailCards: 0,
                isBankrupt: false,
                isLucky: i === luckyPlayerIndex, // Lucky player flag
                luckyTurnsLeft: i === luckyPlayerIndex ? 3 : 0, // 3 turns of double money
                jailCount: 0, // Track jail visits
                doublesCount: 0 // Track lucky doubles
            }));
            
            sendMessage({
                type: 'start_game',
                gameId: currentGameId,
                settings: settings,
                players: initializedPlayers
            });
        });

        // --- UI TRANSITIONS ---
        function showGameSettings() {
            lobby.classList.add('hidden');
            gameContainer.classList.add('hidden');
            gameSettingsScreen.classList.remove('hidden');
            displayGameId.textContent = currentGameId;
            
            // Generate shareable link
            const currentUrl = window.location.origin + window.location.pathname;
            const gameLink = `${currentUrl}?gameId=${currentGameId}`;
            const gameLinkInput = document.getElementById('gameLinkInput');
            if (gameLinkInput) {
                gameLinkInput.value = gameLink;
            }
            
            populateSettingsEditor(gameData.settings.board);
            
            // Mobilde oyun kontrol butonlarını gizle
            document.body.classList.remove('in-game');
            
            // Hide game link display in settings screen
            const gameLinkDisplay = document.getElementById('game-link-display');
            const gameLinkDisplayMobile = document.getElementById('game-link-display-mobile');
            if (gameLinkDisplay) {
                gameLinkDisplay.classList.add('hidden');
            }
            if (gameLinkDisplayMobile) {
                gameLinkDisplayMobile.classList.add('hidden');
            }
            
            // Show game-settings-only elements
            const customizeTitle = document.getElementById('customize-board-title');
            const propertiesEditor = document.getElementById('properties-editor');
            const lobbyControls = document.getElementById('lobby-controls');
            const allowTradingContainer = document.getElementById('allow-trading-container');
            const auctionTimerContainer = document.getElementById('auction-timer-container');
            
            if (customizeTitle) customizeTitle.style.display = 'block';
            if (propertiesEditor) propertiesEditor.style.display = 'grid';
            if (lobbyControls) lobbyControls.style.display = 'flex';
            if (allowTradingContainer) allowTradingContainer.style.display = 'flex';
            if (auctionTimerContainer) auctionTimerContainer.style.display = 'block';
        }

        function showWaitingLobby() {
            lobby.classList.add('hidden');
            gameContainer.classList.add('hidden');
            gameSettingsScreen.classList.remove('hidden');
            
            // Mobilde oyun kontrol butonlarını gizle
            document.body.classList.remove('in-game');
            
            // Hide game link display in waiting lobby
            const gameLinkDisplay = document.getElementById('game-link-display');
            const gameLinkDisplayMobile = document.getElementById('game-link-display-mobile');
            if (gameLinkDisplay) {
                gameLinkDisplay.classList.add('hidden');
            }
            if (gameLinkDisplayMobile) {
                gameLinkDisplayMobile.classList.add('hidden');
            }
            
            gameSettingsScreen.querySelectorAll('input, button').forEach(el => {
                if (el.id !== 'displayGameId' && el.id !== 'copyGameIdBtn') el.disabled = true;
            });
            startGameBtn.textContent = 'Waiting for Host to Start...';
            displayGameId.textContent = currentGameId;
            
            // Show game-settings-only elements (but disabled)
            const customizeTitle = document.getElementById('customize-board-title');
            const propertiesEditor = document.getElementById('properties-editor');
            const lobbyControls = document.getElementById('lobby-controls');
            const allowTradingContainer = document.getElementById('allow-trading-container');
            const auctionTimerContainer = document.getElementById('auction-timer-container');
            
            if (customizeTitle) customizeTitle.style.display = 'block';
            if (propertiesEditor) propertiesEditor.style.display = 'grid';
            if (lobbyControls) lobbyControls.style.display = 'flex';
            if (allowTradingContainer) allowTradingContainer.style.display = 'flex';
            if (auctionTimerContainer) auctionTimerContainer.style.display = 'block';
        }

        // Apply map-specific theme to board
        function applyMapTheme() {
            if (!gameData || !gameData.settings) return;
            
            const mapThemes = {
                classic: {
                    boardBg: 'linear-gradient(135deg, #f5e6d3 0%, #e8d4ba 50%, #f5e6d3 100%)',
                    bodyBg: 'linear-gradient(135deg, #1a5f3f 0%, #2d8659 50%, #1a5f3f 100%)',
                    borderColor: '#1a5f3f'
                },
                turkey: {
                    boardBg: 'linear-gradient(135deg, #f5e6d3 0%, #ffd6d6 50%, #f5e6d3 100%)',
                    bodyBg: 'linear-gradient(135deg, #1a5f3f 0%, #8b1a1a 50%, #1a5f3f 100%)',
                    borderColor: '#e30a17'
                },
                world: {
                    boardBg: 'linear-gradient(135deg, #e8f4ff 0%, #c8e0f5 50%, #e8f4ff 100%)',
                    bodyBg: 'linear-gradient(135deg, #003d7a 0%, #0066cc 50%, #003d7a 100%)',
                    borderColor: '#0066cc'
                },
                holland: {
                    boardBg: 'linear-gradient(135deg, #fff5e6 0%, #ffe0b3 50%, #fff5e6 100%)',
                    bodyBg: 'linear-gradient(135deg, #cc5200 0%, #ff8533 50%, #cc5200 100%)',
                    borderColor: '#ff6600'
                },
                mega_rich: {
                    boardBg: 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%)',
                    bodyBg: 'linear-gradient(135deg, #1a1000 0%, #3d3000 50%, #1a1000 100%)',
                    borderColor: '#d4af37'
                }
            };
            
            const currentMap = gameData.settings.map || 'classic';
            const theme = mapThemes[currentMap] || mapThemes.classic;
            
            // Apply theme to board
            board.style.background = theme.boardBg;
            board.style.borderColor = theme.borderColor;
            
            // Apply theme to body
            document.body.style.background = theme.bodyBg;
            
            console.log('🎨 Applied theme for map:', currentMap);
        }

        function showGame() {
            lobby.classList.add('hidden');
            lobby.style.cssText = 'display: none !important; visibility: hidden !important; position: fixed !important; left: -9999px !important; z-index: -9999 !important;';
            
            gameSettingsScreen.classList.add('hidden');
            gameSettingsScreen.style.cssText = 'display: none !important; visibility: hidden !important; position: fixed !important; left: -9999px !important; z-index: -9999 !important;';
            
            gameContainer.classList.remove('hidden');
            gameContainer.style.cssText = 'display: flex !important; visibility: visible !important; position: relative !important; z-index: 1 !important;';
            
            // Mobilde oyun kontrol butonlarını göstermek için body'ye in-game class'ı ekle
            document.body.classList.add('in-game');
            
            // Show chat panel
            const chatPanel = document.getElementById('chat-panel');
            if (chatPanel) {
                chatPanel.style.display = 'flex';
            }
            
            // Show game link display
            const gameLinkDisplay = document.getElementById('game-link-display');
            const gameLinkInput = document.getElementById('game-link-input');
            const gameLinkDisplayMobile = document.getElementById('game-link-display-mobile');
            const gameLinkInputMobile = document.getElementById('game-link-input-mobile');
            
            if (gameLinkDisplay && gameLinkInput) {
                const currentUrl = window.location.origin + window.location.pathname;
                const gameLink = `${currentUrl}?gameId=${currentGameId}`;
                gameLinkInput.value = gameLink;
                gameLinkDisplay.classList.remove('hidden');
            }
            
            if (gameLinkDisplayMobile && gameLinkInputMobile) {
                const currentUrl = window.location.origin + window.location.pathname;
                const gameLink = `${currentUrl}?gameId=${currentGameId}`;
                gameLinkInputMobile.value = gameLink;
                gameLinkDisplayMobile.classList.remove('hidden');
            }
            
            // Hide game-settings-only elements
            const customizeTitle = document.getElementById('customize-board-title');
            const propertiesEditor = document.getElementById('properties-editor');
            const lobbyControls = document.getElementById('lobby-controls');
            const allowTradingContainer = document.getElementById('allow-trading-container');
            const auctionTimerContainer = document.getElementById('auction-timer-container');
            
            if (customizeTitle) customizeTitle.style.display = 'none';
            if (propertiesEditor) propertiesEditor.style.display = 'none';
            if (lobbyControls) lobbyControls.style.display = 'none';
            if (allowTradingContainer) allowTradingContainer.style.display = 'none';
            if (auctionTimerContainer) auctionTimerContainer.style.display = 'none';
            
            // Apply map theme (unless dark mode is on)
            if (!isDarkMode) {
                applyMapTheme();
            } else {
                applyDarkMode();
            }
            
            console.log('✅ Showing game screen');
        }

        // --- SETTINGS EDITOR ---
        function populateSettingsEditor(boardData) {
            propertiesEditor.innerHTML = '';
            boardData.forEach((prop, index) => {
                if (prop.type === 'property' || prop.type === 'railroad' || prop.type === 'utility') {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-lg bg-gray-50';
                    div.innerHTML = `
                        <label class="block text-xs font-bold text-gray-600">Space ${index}</label>
                        <input data-index="${index}" data-field="name" type="text" value="${prop.name}" class="w-full text-sm font-semibold border-b bg-transparent">
                        <input data-index="${index}" data-field="price" type="number" value="${prop.price || ''}" class="w-full text-sm mt-1 border-b bg-transparent" placeholder="Price">
                    `;
                    propertiesEditor.appendChild(div);
                }
            });
        }
        
        function getEditedBoardData() {
            const newBoard = JSON.parse(JSON.stringify(getDefaultBoard())); // Deep copy
            propertiesEditor.querySelectorAll('input').forEach(input => {
                const index = input.dataset.index;
                const field = input.dataset.field;
                const value = field === 'price' ? parseInt(input.value) : input.value;
                if(newBoard[index] && field in newBoard[index]) {
                    newBoard[index][field] = value;
                }
            });
            return newBoard;
        }

        // --- REAL-TIME LISTENER ---
        // No longer needed - WebSocket automatically receives updates

        function updateLobbyUI() {
            lobbyPlayersList.innerHTML = gameData.players.map(p => `
                <div class="flex items-center gap-2 p-2 bg-gray-100 rounded-md">
                    <div class="w-4 h-4 rounded-full" style="background-color: ${p.color};"></div>
                    <span class="font-medium">${p.name} ${characterIcons[p.character] || ''}</span>
                </div>
            `).join('');
            startGameBtn.disabled = gameData.players.length < 2;

            const joinBtn = document.getElementById('joinGameBtn');
            if (gameData && gameData.state === 'playing') {
                joinBtn.disabled = true;
                joinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                joinBtn.innerText = 'Oyun Başladı';
            } else {
                joinBtn.disabled = false;
                joinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                joinBtn.innerText = 'Join Game';
            }
            
            // Update character availability based on taken characters
            updateCharacterAvailability();
        }

        // --- GAME UI RENDERING ---
        function renderBoard() {
            if (!gameData || !gameData.settings) {
                console.error('❌ Cannot render board: gameData or settings missing');
                return;
            }
            
            console.log('🎨 Rendering board...');
            console.log('📋 Map selected:', gameData.settings.map);
            console.log('📍 Total spaces:', gameData.settings.board.length);
            console.log('📍 First 5 spaces:', gameData.settings.board.slice(0, 5).map(s => s.name));
            console.log('📍 Spaces 10-15:', gameData.settings.board.slice(10, 15).map(s => s.name));
            console.log('📍 Last 3 spaces:', gameData.settings.board.slice(-3).map(s => s.name));
            
            // Apply map-specific theme
            applyMapTheme();
            
            const spacesContainer = document.createDocumentFragment();
            gameData.settings.board.forEach((spaceData, i) => {
                const spaceEl = document.createElement('div');
                spaceEl.id = `space-${i}`;
                spaceEl.className = 'space';
                
                // Add corner class for special spaces
                if ([0, 10, 20, 30].includes(i)) {
                    spaceEl.classList.add('corner');
                }
                
                let content = `<div class="font-bold uppercase">${spaceData.name}</div>`;
                // Price labels removed for cleaner board appearance
                let priceLabel = '';
                /*
                if (spaceData.type === 'property' || spaceData.type === 'railroad' || spaceData.type === 'utility') {
                    if (i >=1 && i <=9) { // bottom row - üstlerinde
                        priceLabel = `<div class="price price-top">💰 $${spaceData.price}</div>`;
                    } else if (i >=21 && i <=30) { // top row - altlarında
                        priceLabel = `<div class="price price-bottom">💰 $${spaceData.price}</div>`;
                    } else if (i >=11 && i <=19) { // left col - sağlarında
                        priceLabel = `<div class="price price-right">💰 $${spaceData.price}</div>`;
                    } else if (i >=31 && i <=39) { // right col - sollarında
                        priceLabel = `<div class="price price-left">💰 $${spaceData.price}</div>`;
                    }
                }
                */
                if (spaceData.type === 'property') {
                    const property = gameData.properties[i];
                    let ownersHTML = '';
                    if (property && property.owners) {
                        ownersHTML = Object.entries(property.owners).map(([ownerId, percentage]) => {
                            const owner = gameData.players.find(p => p.id === ownerId);
                            if (!owner) return '';
                            return `<span class="inline-block text-[8px] mr-1 px-1 py-0.5 rounded bg-gray-100 border border-gray-300" style="color:${owner.color}">${owner.name} <span class="font-bold">${percentage}%</span></span>`;
                        }).join(' ');
                    }
                    const ownerColor = property && property.ownerId ? (gameData.players.find(p => p.id === property.ownerId)?.color || '#ffffff') : '#ffffff';
                    content = `
                        <div class="houses-container"></div>
                        <div class="color-bar" style="background: linear-gradient(135deg, ${spaceData.color} 0%, ${adjustColor(spaceData.color, -20)} 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <div class="p-1 flex-grow flex flex-col justify-center" style="background: ${ownerColor ? `linear-gradient(135deg, ${ownerColor}20 0%, ${ownerColor}40 100%)` : 'transparent'}; border: ${ownerColor ? `2px solid ${ownerColor}` : 'none'}; border-radius: 4px;">
                           <div class="font-bold text-[12px] uppercase leading-tight">${spaceData.name}</div>
                           ${ownersHTML ? `<div class="text-[8px] text-gray-700 mt-1">Owners: ${ownersHTML}</div>` : ''}
                        </div>`;
                } else if(spaceData.type === 'railroad') {
                     content = `<div class="text-center p-2"><div class="text-2xl">🚂</div><div class="font-bold text-[11px]">${spaceData.name}</div></div>`;
                } else if(spaceData.type === 'utility') {
                     const icon = spaceData.name.includes('Electric') ? '⚡' : '💧';
                     content = `<div class="text-center p-2"><div class="text-2xl">${icon}</div><div class="font-bold text-[11px]">${spaceData.name}</div></div>`;
                } else if(spaceData.type === 'tax') {
                     content = `<div class="text-center p-2"><div class="text-2xl">💸</div><div class="font-bold text-[11px]">${spaceData.name}</div><div class="text-[10px]">Pay $${spaceData.amount}</div></div>`;
                } else if(spaceData.type === 'chance') {
                     content = `<div class="text-center p-2"><div class="text-2xl">❓</div><div class="font-bold text-[11px]">${spaceData.name}</div></div>`;
                } else if(spaceData.type === 'community_chest') {
                     content = `<div class="text-center p-2"><div class="text-2xl">🎁</div><div class="font-bold text-[11px]">${spaceData.name}</div></div>`;
                } else if(spaceData.type === 'go') {
                     content = `<div class="text-center p-2"><div class="text-3xl">➡️</div><div class="font-bold text-[13px]">GO</div><div class="text-[11px]">Collect $200</div></div>`;
                } else if(spaceData.type === 'jail') {
                     content = `<div class="text-center p-2"><div class="text-3xl">🔒</div><div class="font-bold text-[11px]">Jail</div></div>`;
                } else if(spaceData.type === 'free_parking') {
                     content = `<div class="text-center p-2"><div class="text-3xl">🅿️</div><div class="font-bold text-[11px]">Free Parking</div></div>`;
                } else if(spaceData.type === 'go_to_jail') {
                     content = `<div class="text-center p-2"><div class="text-3xl">👮</div><div class="font-bold text-[11px]">Go To Jail</div></div>`;
                }
                
                spaceEl.innerHTML = content + priceLabel;
                spacesContainer.appendChild(spaceEl);
                
                // 🏠 Add click event to show property details
                if (spaceData.type === 'property' || spaceData.type === 'railroad' || spaceData.type === 'utility') {
                    spaceEl.style.cursor = 'pointer';
                    spaceEl.addEventListener('click', () => {
                        showPropertyDetails(i, spaceData);
                    });
                }
            });
             const piecesContainer = document.createElement('div');
             piecesContainer.id = "pieces-container";
             piecesContainer.style.position = 'relative';
             piecesContainer.style.gridColumn = '1 / -1';
             piecesContainer.style.gridRow = '1 / -1';
             piecesContainer.style.pointerEvents = 'none';

             board.querySelectorAll('.space').forEach(s => s.remove());
             board.appendChild(spacesContainer);
             board.appendChild(piecesContainer);
        }

        function updateGameUI() {
            updatePlayersInfo();
            updateBoardPiecesAndHouses();
            updateControls();
            updateGameLog();
            
            // ⏰ Handle turn timer for auto-end turn
            handleTurnTimer();
            
            // Leaderboard kaldırıldı
        }

        // ⏰ Handle turn timer for auto-end turn
        function handleTurnTimer() {
            if (!gameData || !gameData.players) return;
            
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const isMyTurn = currentPlayer && currentPlayer.id === localPlayer.id;
            
            // Clear existing timer
            if (turnTimer) {
                clearTimeout(turnTimer);
                turnTimer = null;
            }
            
            // Start timer if it's our turn and we're not a bot
            if (isMyTurn && !currentPlayer.isBot) {
                console.log('⏰ Starting turn timer (90 seconds)');
                turnTimer = setTimeout(() => {
                    console.log('⏰ Turn timer expired, auto-ending turn');
                    // Auto-end turn
                    sendMessage({
                        type: 'end_turn',
                        gameId: currentGameId
                    });
                }, 90000); // 1.5 minutes = 90 seconds
            }
        }

        function updatePlayersInfo() {
            if (!gameData || !gameData.players) {
                showModal('Error', 'Oyuncu verisi eksik. Lütfen tekrar bağlanın.', [{text:'Tamam', class:'bg-red-500', action:hideModal}]);
                return;
            }
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            playersInfo.innerHTML = gameData.players.map((p) => {
                if (p.isBankrupt) return '';
                const isCurrent = p.id === currentPlayer.id;
                // Team badge
                const teamBadges = {
                    red: '🔴',
                    blue: '🔵',
                    green: '🟢',
                    yellow: '🟡'
                };
                const teamBadge = p.team ? teamBadges[p.team] || '' : '';
                // Sahip olunan kartları al ve mini ikonlar olarak göster
                const playerProperties = gameData.properties
                    .map((prop, idx) => ({...prop, spaceIndex: idx}))
                    .filter(prop => prop.owners && prop.owners[p.id] > 0);
                let propertiesHTML = '';
                if (playerProperties.length > 0) {
                    // Mobile: expandable property list
                    propertiesHTML = `
                        <div class="mt-2">
                            <button class="property-list-toggle text-xs bg-gray-200 px-2 py-1 rounded mb-1" onclick="window.togglePropertyList('${p.id}')">${playerProperties.length} Properties ▼</button>
                            <div class="property-list hidden flex flex-wrap gap-1 max-h-32 overflow-y-auto">
                                ${playerProperties.map(prop => {
                                    const space = gameData.settings.board[prop.spaceIndex];
                                    const propColor = space.color || '#cccccc';
                                    const housesDisplay = prop.houses > 0 ? (prop.houses === 5 ? '🏨' : `🏠${prop.houses}`) : '';
                                    const share = prop.owners[p.id] || 0;
                                    return `<div class=\"property-mini-icon text-xs px-1 py-0.5 rounded border\" style=\"background: linear-gradient(135deg, ${propColor} 0%, ${p.color}40 100%); border-color: ${p.color}; min-width: 40px;\" title=\"${space.name}\">${space.name.substring(0, 3)}${housesDisplay} <span class=\"font-bold text-[8px]\">${share}%</span></div>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                return `
                    <div class="player-card border rounded-xl p-3 ${isCurrent ? 'border-blue-500 border-2 shadow-xl bg-gradient-to-r from-blue-50 to-white' : 'border-gray-200 bg-white'} transition-all duration-300 cursor-pointer hover:shadow-lg" data-player-id="${p.id}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full shadow-md" style="background: linear-gradient(135deg, ${p.color} 0%, ${adjustColor(p.color, -30)} 100%); border: 2px solid white;"></div>
                                <span class="font-bold text-lg">${teamBadge} ${p.name} ${p.id === localPlayer.id ? '(You)' : ''} ${p.isLucky && p.luckyTurnsLeft > 0 ? `⭐(${p.luckyTurnsLeft} turns)` : ''}</span>
                            </div>
                            <span class="font-semibold text-green-600 text-xl">💰 $${p.money}</span>
                        </div>
                        ${propertiesHTML}
                        <div class="flex justify-between items-center mt-2">
                            ${p.inJail ? `<div class="text-red-500 font-bold text-sm flex items-center gap-1">🔒 IN JAIL</div>` : '<div></div>'}
                            <div class="flex gap-2">
                                ${p.id === localPlayer.id && p.money < 0 ? `<button onclick="window.declareBankruptcy()" class="text-xs bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1 rounded-lg hover:from-red-600 hover:to-red-700 shadow transition-all">💥 İflas Et</button>` : ''}
                                ${p.id !== localPlayer.id && gameData.settings.allowTrading ? `<button data-player-id="${p.id}" onclick="window.showTradeModal('${p.id}')" class="trade-btn text-xs bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-1 rounded-lg hover:from-blue-600 hover:to-blue-700 shadow transition-all">🤝 Trade</button>` : ''}
                                ${p.id === gameData.hostId && localPlayer.id === gameData.hostId ? `<button onclick="showGameManagementModal()" class="text-xs bg-gradient-to-r from-purple-500 to-purple-600 text-white px-3 py-1 rounded-lg hover:from-purple-600 hover:to-purple-700 shadow transition-all">🎮 Oyun Yönetimi</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        // Mobile: property list toggle logic
        window.togglePropertyList = function(playerId) {
            document.querySelectorAll('.player-card').forEach(card => {
                if (card.dataset.playerId === playerId) {
                    const list = card.querySelector('.property-list');
                    if (list) {
                        list.classList.toggle('hidden');
                    }
                }
            });
        }
        
        function showGameManagementModal() {
            const modal = document.getElementById('game-management-modal');
            const playersContainer = document.getElementById('game-management-players');
            
            playersContainer.innerHTML = gameData.players.map(p => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full" style="background: ${p.color}"></div>
                        <span class="font-bold">${p.name}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="kickPlayer('${p.id}')" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Kick</button>
                        <button onclick="forceEndTurn('${p.id}')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Force End Turn</button>
                        <button onclick="forceRollDice('${p.id}')" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Force Roll</button>
                    </div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }
        
        function hideGameManagementModal() {
            document.getElementById('game-management-modal').classList.add('hidden');
        }
        
        async function kickPlayer(playerId) {
            if (!confirm('Are you sure you want to kick this player?')) return;
            
            const playersCopy = gameData.players.filter(p => p.id !== playerId);
            await updateGame({ players: playersCopy });
            hideGameManagementModal();
            addLog(`Player ${gameData.players.find(p => p.id === playerId).name} was kicked by the host.`);
        }
        
        async function forceEndTurn(playerId) {
            if (gameData.players[gameData.currentPlayerIndex].id !== playerId) {
                alert('This player is not currently taking their turn.');
                return;
            }
            
            await endTurn();
            hideGameManagementModal();
            addLog(`Host forced ${gameData.players.find(p => p.id === playerId).name} to end their turn.`);
        }
        
        async function forceRollDice(playerId) {
            if (gameData.players[gameData.currentPlayerIndex].id !== playerId) {
                alert('This player is not currently taking their turn.');
                return;
            }
            
            // Simulate roll dice
            const rollDiceBtn = document.getElementById('rollDiceBtn');
            rollDiceBtn.click();
            hideGameManagementModal();
            addLog(`Host forced ${gameData.players.find(p => p.id === playerId).name} to roll the dice.`);
        };
            
            // Add click event to show player stats
            document.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Don't trigger if clicking trade button
                    if (e.target.classList.contains('trade-btn')) return;
                    const playerId = card.dataset.playerId;
                    showPlayerStats(playerId);
                });
            });
        }

        // 🤖 Bot AI - Handle bot turns automatically
        function handleBotTurn() {
            if (!gameData || !gameData.players || gameData.players[gameData.currentPlayerIndex].id === localPlayer.id) {
                return; // Not bot's turn or no game data
            }
            
            const bot = gameData.players[gameData.currentPlayerIndex];
            if (!bot.isBot) return;
            
            console.log(`🤖 Bot ${bot.name}'s turn`);
            
            // Simple bot AI logic
            setTimeout(() => {
                // Roll dice
                sendMessage({ type: 'roll_dice' });
                
                // After rolling, wait a bit then make decisions
                setTimeout(() => {
                    // If bot landed on an unowned property, decide whether to buy
                    const currentSpace = gameData.settings.board[bot.position];
                    if (currentSpace && currentSpace.type === 'property' && !gameData.properties[bot.position].ownerId) {
                        const canAfford = bot.money >= currentSpace.price;
                        if (canAfford && Math.random() > 0.3) { // 70% chance to buy
                            setTimeout(() => sendMessage({ type: 'buy_property' }), 1000);
                        } else {
                            // Don't buy, end turn
                            setTimeout(() => sendMessage({ type: 'end_turn' }), 1000);
                        }
                    } else {
                        // Not on a buyable property, end turn
                        setTimeout(() => sendMessage({ type: 'end_turn' }), 1000);
                    }
                }, 2000);
            }, 500);
        }

        // 📊 Show Player Statistics Modal
        function showPlayerStats(playerId) {
            const player = gameData.players.find(p => p.id === playerId);
            if (!player) return;
            
            // Calculate statistics
            // Find all properties where player owns a share
            const properties = gameData.properties
                .map((prop, idx) => ({...prop, spaceIndex: idx}))
                .filter(prop => prop.owners && prop.owners[playerId] > 0);
            const totalProperties = properties.length;
            let totalPropertyValue = 0;
            properties.forEach(prop => {
                const space = gameData.settings.board[prop.spaceIndex];
                if (space.price) {
                    totalPropertyValue += space.price * (prop.owners[playerId] || 0) / 100;
                    if (prop.houses > 0 && prop.houses < 5) {
                        totalPropertyValue += prop.houses * (space.houseCost || 50) * (prop.owners[playerId] || 0) / 100;
                    } else if (prop.houses === 5) {
                        totalPropertyValue += 5 * (space.houseCost || 50) * (prop.owners[playerId] || 0) / 100;
                    }
                }
            });
            
            const totalWealth = player.money + totalPropertyValue;
            const emoji = characterIcons[player.character] || '❓';
            
            // Stats tracking (you can extend this by adding these to player object)
            const jailTimes = player.jailCount || 0;
            const doubles = player.doublesCount || 0;
            
            // Find most expensive property
            let mostExpensive = null;
            let maxPrice = 0;
            properties.forEach(prop => {
                const space = gameData.settings.board[prop.spaceIndex];
                if (space.price && space.price > maxPrice) {
                    maxPrice = space.price;
                    mostExpensive = space.name;
                }
            });
            
            // Expandable property list for modal
            let propertiesListHTML = '';
            if (properties.length > 0) {
                propertiesListHTML = `
                    <div class="mt-4">
                        <button id="modal-property-list-toggle" class="property-list-toggle text-xs bg-gray-200 px-2 py-1 rounded mb-1">${properties.length} Properties ▼</button>
                        <div id="modal-property-list" class="property-list hidden flex flex-wrap gap-1 max-h-32 overflow-y-auto">
                            ${properties.map(prop => {
                                const space = gameData.settings.board[prop.spaceIndex];
                                const propColor = space.color || '#cccccc';
                                const housesDisplay = prop.houses > 0 ? (prop.houses === 5 ? '🏨' : `🏠${prop.houses}`) : '';
                                const share = prop.owners[playerId] || 0;
                                return `<div class=\"property-mini-icon text-xs px-1 py-0.5 rounded border\" style=\"background: linear-gradient(135deg, ${propColor} 0%, ${player.color}40 100%); border-color: ${player.color}; min-width: 40px;\" title=\"${space.name}\">${space.name.substring(0, 3)}${housesDisplay} <span class=\"font-bold text-[8px]\">${share}%</span></div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            const statsHTML = `
                <div class="text-center mb-4">
                    <div class="text-6xl mb-2">${emoji}</div>
                    <div class="text-2xl font-bold" style="color: ${player.color}">${player.name}</div>
                </div>
                <div class="space-y-3 text-left">
                    <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                        <div class="text-sm text-gray-600">💰 Total Wealth</div>
                        <div class="text-2xl font-bold text-green-700">$${totalWealth}</div>
                        <div class="text-xs text-gray-500">Cash: $${player.money} + Properties: $${totalPropertyValue.toFixed(0)}</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                        <div class="text-sm text-gray-600">🏠 Properties Owned</div>
                        <div class="text-xl font-bold text-blue-700">${totalProperties} properties</div>
                        ${propertiesListHTML}
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                        <div class="text-sm text-gray-600">💎 Most Expensive Property</div>
                        <div class="text-lg font-bold text-purple-700">${mostExpensive || 'None'}</div>
                        ${mostExpensive ? `<div class="text-xs text-gray-500">$${maxPrice}</div>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-red-50 p-2 rounded-lg border-l-4 border-red-500">
                            <div class="text-xs text-gray-600">🔒 Jail Visits</div>
                            <div class="text-xl font-bold text-red-700">${jailTimes}</div>
                        </div>
                        <div class="bg-yellow-50 p-2 rounded-lg border-l-4 border-yellow-500">
                            <div class="text-xs text-gray-600">🎲 Lucky Doubles</div>
                            <div class="text-xl font-bold text-yellow-700">${doubles}</div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(`📊 Player Statistics`, statsHTML, [
                { text: 'Close', class: 'bg-blue-500', action: hideModal },
                ...(playerId === localPlayer.id && player.money < 0 ? [{ text: '💥 İflas Et', class: 'bg-red-600', action: () => {
                    hideModal();
                    setTimeout(() => window.declareBankruptcy(), 300);
                }}] : [])
            ]);
            // Add toggle logic for modal property list
            setTimeout(() => {
                const toggleBtn = document.getElementById('modal-property-list-toggle');
                const list = document.getElementById('modal-property-list');
                if (toggleBtn && list) {
                    toggleBtn.onclick = () => {
                        list.classList.toggle('hidden');
                    };
                }
            }, 100);
        }

        // 🏠 Show Property Details Modal
        function showPropertyDetails(position, spaceData) {
            const property = gameData.properties[position];
            let detailsHTML = `
                <div class="text-center mb-4">
                    <div class="text-3xl mb-2">${spaceData.type === 'property' ? '🏠' : spaceData.type === 'railroad' ? '🚂' : '⚡'}</div>
                    <div class="text-2xl font-bold">${spaceData.name}</div>
                    ${spaceData.color ? `<div class="w-full h-3 rounded-full mt-2" style="background: ${spaceData.color};"></div>` : ''}
                </div>
            `;
            if (spaceData.type === 'property') {
                detailsHTML += `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                            <div class="text-sm text-gray-600">💰 Purchase Price</div>
                            <div class="text-2xl font-bold text-green-700">$${spaceData.price}</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                            <div class="text-sm text-gray-600 mb-2">💵 Rent Details</div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between"><span>Base Rent:</span><span class="font-bold">$${spaceData.rent[0]}</span></div>
                                <div class="flex justify-between"><span>With 1 House:</span><span class="font-bold">$${spaceData.rent[1]}</span></div>
                                <div class="flex justify-between"><span>With 2 Houses:</span><span class="font-bold">$${spaceData.rent[2]}</span></div>
                                <div class="flex justify-between"><span>With 3 Houses:</span><span class="font-bold">$${spaceData.rent[3]}</span></div>
                                <div class="flex justify-between"><span>With 4 Houses:</span><span class="font-bold">$${spaceData.rent[4]}</span></div>
                                <div class="flex justify-between border-t-2 pt-1 mt-1"><span class="font-bold">With Hotel:</span><span class="font-bold text-purple-700">$${spaceData.rent[5]}</span></div>
                            </div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg border-l-4 border-orange-500">
                            <div class="text-sm text-gray-600">🏗️ House Cost</div>
                            <div class="text-xl font-bold text-orange-700">$${spaceData.houseCost || 50} each</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                            <div class="text-sm text-gray-600">👤 Owners</div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${property && property.owners ? Object.entries(property.owners).map(([ownerId, percentage]) => {
                                    const owner = gameData.players.find(p => p.id === ownerId);
                                    if (!owner) return '';
                                    return `<span class=\"inline-block text-xs px-2 py-1 rounded bg-gray-100 border border-gray-300\" style=\"color:${owner.color}\">${owner.name} <span class=\"font-bold\">${percentage}%</span></span>`;
                                }).join(' ') : '<span class="text-gray-500">🆓 Available for Purchase</span>'}
                            </div>
                            ${property && property.houses > 0 ? `<div class="text-sm text-gray-600 mt-1">${property.houses === 5 ? '🏨 Hotel' : `🏠 ${property.houses} House${property.houses > 1 ? 's' : ''}`}</div>` : ''}
                        </div>
                    </div>
                `;
            } else if (spaceData.type === 'railroad') {
                detailsHTML += `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                            <div class="text-sm text-gray-600">💰 Purchase Price</div>
                            <div class="text-2xl font-bold text-green-700">$${spaceData.price}</div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                            <div class="text-sm text-gray-600 mb-2">💵 Rent by Railroads Owned</div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>1 Railroad:</span>
                                    <span class="font-bold">$25</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>2 Railroads:</span>
                                    <span class="font-bold">$50</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>3 Railroads:</span>
                                    <span class="font-bold">$100</span>
                                </div>
                                <div class="flex justify-between border-t-2 pt-1 mt-1">
                                    <span class="font-bold">4 Railroads:</span>
                                    <span class="font-bold text-purple-700">$200</span>
                                </div>
                            </div>
                        </div>
                        
                        ${owner ? `
                            <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                                <div class="text-sm text-gray-600">👤 Owner</div>
                                <div class="text-xl font-bold" style="color: ${owner.color}">${owner.name} ${characterIcons[owner.character]}</div>
                            </div>
                        ` : '<div class="bg-gray-50 p-3 rounded-lg border-l-4 border-gray-400 text-center text-gray-600">🆓 Available for Purchase</div>'}
                    </div>
                `;
            } else if (spaceData.type === 'utility') {
                detailsHTML += `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                            <div class="text-sm text-gray-600">💰 Purchase Price</div>
                            <div class="text-2xl font-bold text-green-700">$${spaceData.price}</div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                            <div class="text-sm text-gray-600 mb-2">💵 Rent Formula</div>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>1 Utility Owned:</span>
                                    <span class="font-bold">4× Dice Roll</span>
                                </div>
                                <div class="flex justify-between border-t-2 pt-1 mt-1">
                                    <span class="font-bold">2 Utilities Owned:</span>
                                    <span class="font-bold text-purple-700">10× Dice Roll</span>
                                </div>
                            </div>
                        </div>
                        
                        ${owner ? `
                            <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500">
                                <div class="text-sm text-gray-600">👤 Owner</div>
                                <div class="text-xl font-bold" style="color: ${owner.color}">${owner.name} ${characterIcons[owner.character]}</div>
                            </div>
                        ` : '<div class="bg-gray-50 p-3 rounded-lg border-l-4 border-gray-400 text-center text-gray-600">🆓 Available for Purchase</div>'}
                    </div>
                `;
            }
            
            showModal(`🏠 Property Details`, detailsHTML, [
                { text: 'Close', class: 'bg-blue-500', action: hideModal }
            ]);
        }
        
        function updateBoardPiecesAndHouses() {
            const piecesContainer = document.getElementById('pieces-container');
            if (!piecesContainer) return;
            piecesContainer.innerHTML = ''; 
            
            // Display player emojis on board (always show them, not just after dice roll)
            gameData.players.forEach((p, i) => {
                if (p.isBankrupt) return;
                
                const pieceEl = document.createElement('div');
                pieceEl.className = 'player-piece';
                pieceEl.id = `piece-${p.id}`;
                
                // Get emoji from characterIcons
                const emoji = characterIcons[p.character] || '❓';
                
                // Debug log
                console.log(`🎮 Player ${p.name}: character='${p.character}', emoji='${emoji}'`);
                
                pieceEl.textContent = emoji;
                
                const targetSpace = document.getElementById(`space-${p.position}`);
                if (targetSpace) {
                    // Calculate offset for multiple players on same space
                    // Group players by position
                    const playersOnSameSpace = gameData.players.filter(
                        player => player.position === p.position && !player.isBankrupt
                    );
                    const positionIndex = playersOnSameSpace.findIndex(player => player.id === p.id);
                    
                    // Arrange players in a 2x2 grid if multiple on same space
                    const offsetX = (positionIndex % 2) * 18;
                    const offsetY = Math.floor(positionIndex / 2) * 18;
                    
                    pieceEl.style.left = `${targetSpace.offsetLeft + 8 + offsetX}px`;
                    pieceEl.style.top = `${targetSpace.offsetTop + 8 + offsetY}px`;
                }
                piecesContainer.appendChild(pieceEl);
            });
            
            // Update property ownership and houses
            board.querySelectorAll('.owner-indicator, .houses-container > *').forEach(el => el.remove());
            gameData.properties.forEach((prop, i) => {
                const spaceEl = document.getElementById(`space-${i}`);
                if (!spaceEl) return;

                if (prop.ownerId) {
                    const owner = gameData.players.find(p => p.id === prop.ownerId);
                    if(owner) {
                        const indicator = document.createElement('div');
                        indicator.className = 'owner-indicator';
                        indicator.style.backgroundColor = owner.color;
                        spaceEl.appendChild(indicator);
                    }
                }
                
                if (prop.houses > 0) {
                    const housesContainer = spaceEl.querySelector('.houses-container');
                    if(housesContainer) {
                        if (prop.houses === 5) { // Hotel
                            const hotelEl = document.createElement('div');
                            hotelEl.className = 'hotel';
                            housesContainer.appendChild(hotelEl);
                        } else { // Houses
                            for (let j = 0; j < prop.houses; j++) {
                                const houseEl = document.createElement('div');
                                houseEl.className = 'house';
                                housesContainer.appendChild(houseEl);
                            }
                        }
                    }
                }
            });
            
            // Mobil players menüsünü güncelle
            updateMobilePlayersBar();
        }
        
        function updateMobilePlayersBar() {
            const mobilePlayersList = document.getElementById('mobile-players-list');
            if (!mobilePlayersList || !gameData) return;
            
            mobilePlayersList.innerHTML = '';
            
            gameData.players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'mobile-player-card';
                if (player.id === gameData.players[gameData.currentPlayerIndex].id) {
                    card.classList.add('active');
                }
                
                const emoji = characterIcons[player.character] || '❓';
                const name = player.name.length > 8 ? player.name.substring(0, 8) + '...' : player.name;
                const money = `$${player.money}`;
                
                card.innerHTML = `
                    <div style="font-size: 1.5rem;">${emoji}</div>
                    <div style="font-weight: 600; color: ${player.color};">${name}</div>
                    <div style="color: #059669; font-size: 0.7rem;">${money}</div>
                `;
                
                card.onclick = () => {
                    showPlayerProfile(player);
                };
                
                // Trade butonu ekle (kendisi ve iflaslar hariç)
                if (player.id !== localPlayer.id && !player.isBankrupt) {
                    const tradeBtn = document.createElement('button');
                    tradeBtn.textContent = '🤝';
                    tradeBtn.style.cssText = 'margin-top: 0.25rem; padding: 0.25rem 0.5rem; background: #1a73e8; color: white; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer;';
                    tradeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // Team manager'ı aç
                        document.getElementById('teamManagerBtn').click();
                    });
                    card.appendChild(tradeBtn);
                }
                
                // Host management butonu (host ise ve kendisi hariç)
                if (localPlayer.id === gameData.players[0].id && player.id !== localPlayer.id) {
                    console.log('Adding manage button for player:', player.id);
                    const manageBtn = document.createElement('button');
                    manageBtn.textContent = '⚙️';
                    manageBtn.style.cssText = 'margin-top: 0.25rem; margin-left: 0.25rem; padding: 0.25rem 0.5rem; background: #ff6b35; color: white; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer;';
                    manageBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        console.log('manageBtn clicked, player.id:', player.id);
                        showGameManagementModal(player.id);
                    });
                    card.appendChild(manageBtn);
                }
                
                if (player.isBankrupt) {
                    card.style.opacity = '0.5';
                    card.style.textDecoration = 'line-through';
                }
                
                mobilePlayersList.appendChild(card);
            });
        }

        function updateControls() {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const isMyTurn = currentPlayer.id === localPlayer.id;

            dice1El.textContent = gameData.lastDiceRoll[0] || '🎲';
            dice2El.textContent = gameData.lastDiceRoll[1] || '🎲';

            const canAct = isMyTurn && !currentPlayer.isBankrupt;
            rollDiceBtn.disabled = !canAct || gameData.turnState !== 'start';
            endTurnBtn.classList.toggle('hidden', !canAct || gameData.turnState !== 'action_complete');
            managePropertiesBtn.classList.toggle('hidden', !canAct || (gameData.turnState !== 'start' && gameData.turnState !== 'action_complete'));
            
            // Mobil butonları da güncelle
            const mobileRollBtn = document.getElementById('mobile-roll-btn');
            const mobileEndTurnBtn = document.getElementById('mobile-end-turn-btn');
            const mobilePropertiesBtn = document.getElementById('mobile-properties-btn');
            const mobileJokerBtn = document.getElementById('mobile-joker-btn');
            const mobileTeamBtn = document.getElementById('mobile-team-btn');
            
            if (mobileRollBtn) mobileRollBtn.disabled = !canAct || gameData.turnState !== 'start';
            if (mobileEndTurnBtn) {
                mobileEndTurnBtn.disabled = !canAct || gameData.turnState !== 'action_complete';
                mobileEndTurnBtn.style.display = (!canAct || gameData.turnState !== 'action_complete') ? 'none' : 'inline-flex';
            }
            if (mobilePropertiesBtn) {
                mobilePropertiesBtn.disabled = !canAct || (gameData.turnState !== 'start' && gameData.turnState !== 'action_complete');
                mobilePropertiesBtn.style.display = (!canAct || (gameData.turnState !== 'start' && gameData.turnState !== 'action_complete')) ? 'none' : 'inline-flex';
            }
            // Team, Joker her zaman görünür (team her oyuncu yapabilir, joker kendi turunda)
            if (mobileJokerBtn) mobileJokerBtn.disabled = !canAct;
            
            // Update trades button - show sent + received trades
            const sentTrades = (gameData.trades || []).filter(t => t.fromId === localPlayer.id && t.status === 'pending');
            const receivedTrades = (gameData.trades || []).filter(t => t.toId === localPlayer.id && t.status === 'pending');
            const totalTrades = sentTrades.length + receivedTrades.length;
            
            const tradesCount = document.getElementById('pending-trades-count');
            if (tradesCount) tradesCount.textContent = totalTrades;
            viewTradesBtn.classList.toggle('hidden', totalTrades === 0);
            
            // 🤖 Bot AI - Disabled for now (coming soon)
            // if (currentPlayer.isBot && isMyTurn === false && gameData.turnState === 'start') {
            //     setTimeout(() => handleBotTurn(), 1500);
            // }
        }
        
        // 🤖 Bot AI Handler (Disabled - Coming Soon)
        async function handleBotTurn() {
            // Bot functionality coming soon!
            console.log('🤖 Bot AI is currently disabled');
        }
        
        function updateGameLog() {
            gameLogEl.innerHTML = gameData.gameLog.map(msg => `<div>${msg}</div>`).join('');
            gameLogEl.scrollTop = gameLogEl.scrollHeight;
        }

        // --- GAME ACTIONS ---
        rollDiceBtn.addEventListener('click', async () => {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            if (currentPlayer.inJail) {
                handleJailTurn();
                return;
            }

            // Animate dice rolling
            rollDiceBtn.disabled = true;
            animateDiceRoll();
            
            // 🎵 Play dice roll sound
            playSound('dice');

            let logMessages = [];

            const die1 = Math.floor(Math.random() * 6) + 1;
            const die2 = Math.floor(Math.random() * 6) + 1;
            const total = die1 + die2;
            const newPosition = (currentPlayer.position + total) % 40;
            const newMoney = currentPlayer.money;
            
            // 🎲 Check for doubles
            const isDouble = (die1 === die2);
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            playersCopy[gameData.currentPlayerIndex].position = newPosition;
            playersCopy[gameData.currentPlayerIndex].money = newMoney;
            
            // Update lucky turns and track doubles
            if (currentPlayer.isLucky && currentPlayer.luckyTurnsLeft > 0) {
                playersCopy[gameData.currentPlayerIndex].luckyTurnsLeft -= 1;
                if (playersCopy[gameData.currentPlayerIndex].luckyTurnsLeft === 0) {
                    playersCopy[gameData.currentPlayerIndex].isLucky = false;
                    logMessages.push(`⭐ ${currentPlayer.name}'s lucky streak has ended!`);
                }
            }
            
            if (isDouble) {
                playersCopy[gameData.currentPlayerIndex].doublesCount = (currentPlayer.doublesCount || 0) + 1;
                logMessages.push(`🎲 ${currentPlayer.name} rolled ${die1} + ${die2} = ${total} (DOUBLES!)`);
            } else {
                logMessages.push(`🎲 ${currentPlayer.name} rolled ${die1} + ${die2} = ${total}`);
            }
            
            await updateGame({
                lastDiceRoll: [die1, die2],
                players: playersCopy,
                turnState: 'rolled',
                gameLog: [...gameData.gameLog, ...logMessages]
            });
            
            setTimeout(() => {
                handleLanding(newPosition);
            }, 1500);
            
            // Re-enable dice button after animation
            setTimeout(() => {
                rollDiceBtn.disabled = false;
            }, 2000);
        });
        
        // 3D Dice Animation Function
        function animateDiceRoll() {
            dice1El.classList.add('dice-rolling');
            dice2El.classList.add('dice-rolling');
            
            let rolls = 0;
            const rollInterval = setInterval(() => {
                dice1El.textContent = Math.floor(Math.random() * 6) + 1;
                dice2El.textContent = Math.floor(Math.random() * 6) + 1;
                rolls++;
                if (rolls >= 10) {
                    clearInterval(rollInterval);
                }
            }, 100);
        }
        
        // View Trades Button
        const viewTradesBtn = document.getElementById('viewTradesBtn');
        viewTradesBtn.addEventListener('click', viewPendingTrades);
        
        // Team Manager Button
        const teamManagerBtn = document.getElementById('teamManagerBtn');
        teamManagerBtn.addEventListener('click', showTeamManager);
        
        function showTeamManager() {
            const me = gameData.players.find(p => p.id === localPlayer.id);
            const myTeam = me.team || '';
            
            const teamPlayers = {
                red: gameData.players.filter(p => p.team === 'red'),
                blue: gameData.players.filter(p => p.team === 'blue'),
                green: gameData.players.filter(p => p.team === 'green'),
                yellow: gameData.players.filter(p => p.team === 'yellow')
            };
            
            let body = `
                <div class="text-left space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <h4 class="font-bold text-blue-800 mb-2">Your Current Status:</h4>
                        <p>${myTeam ? `You are in <strong>${myTeam.toUpperCase()} TEAM</strong>` : 'You are playing SOLO (no team)'}</p>
                    </div>
                    
                    <div class="space-y-2">
                        <h4 class="font-bold">Available Teams:</h4>
                        ${['red', 'blue', 'green', 'yellow'].map(team => {
                            const badge = {'red': '🔴', 'blue': '🔵', 'green': '🟢', 'yellow': '🟡'}[team];
                            const players = teamPlayers[team];
                            const isMemberOfThisTeam = myTeam === team;
                            
                            return `
                                <div class="border-2 border-gray-300 rounded-lg p-3 ${isMemberOfThisTeam ? 'bg-green-50 border-green-500' : ''}">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-bold">${badge} ${team.toUpperCase()} Team (${players.length} members)</span>
                                        ${!isMemberOfThisTeam ? 
                                            `<button onclick="window.joinTeam('${team}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Join</button>` :
                                            `<button onclick="window.leaveTeam()" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Leave</button>`
                                        }
                                    </div>
                                    ${players.length > 0 ? `<div class="text-sm text-gray-600">Members: ${players.map(p => p.name).join(', ')}</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="bg-yellow-50 p-3 rounded-lg text-sm">
                        <strong>💡 Team Benefits:</strong>
                        <ul class="list-disc ml-5 mt-1">
                            <li>Shared money pool - all team members share funds</li>
                            <li>Shared properties - all properties owned by team</li>
                            <li>Can't trade with teammates</li>
                            <li>Team wins together!</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showModal('🤝 Team Manager', body, [
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ]);
        }
        
        function showGameManagementModal(playerId) {
            console.log('playerId:', playerId);
            const player = gameData.players.find(p => p.id === playerId);
            console.log('player:', player);
            if (!player) {
                console.error('Player not found for id:', playerId);
                return;
            }
            document.getElementById('managementPlayerName').textContent = `Manage ${player.name}`;
            document.getElementById('gameManagementModal').classList.remove('hidden');
            
            document.getElementById('kickPlayerBtn').onclick = () => {
                socket.emit('kickPlayer', { playerId });
                document.getElementById('gameManagementModal').classList.add('hidden');
            };
            
            document.getElementById('forceEndTurnBtn').onclick = () => {
                socket.emit('forceEndTurn', { playerId });
                document.getElementById('gameManagementModal').classList.add('hidden');
            };
            
            document.getElementById('forceRollDiceBtn').onclick = () => {
                socket.emit('forceRollDice', { playerId });
                document.getElementById('gameManagementModal').classList.add('hidden');
            };
            
            document.getElementById('closeManagementModal').onclick = () => {
                document.getElementById('gameManagementModal').classList.add('hidden');
            };
        }
        
        // 🤖 Bot Property Purchase Decision
        async function botDecidePropertyPurchase(position) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // Calculate property value score (0-100)
            let valueScore = 0;
            
            // Base value by type
            switch(space.type) {
                case 'railroad':
                    valueScore = 80; // Railroads are very valuable for monopolies
                    break;
                case 'utility':
                    valueScore = 70; // Utilities are valuable but expensive
                    break;
                case 'property':
                    // Value based on color group and position
                    const colorGroups = {
                        'brown': 40, 'lightblue': 45, 'pink': 50, 'orange': 55,
                        'red': 60, 'yellow': 65, 'green': 70, 'darkblue': 75
                    };
                    valueScore = colorGroups[space.color] || 50;
                    break;
            }
            
            // Adjust for current money situation
            const moneyRatio = currentPlayer.money / space.price;
            let affordabilityScore = 0;
            
            if (moneyRatio >= 2) affordabilityScore = 100; // Very affordable
            else if (moneyRatio >= 1.5) affordabilityScore = 80; // Affordable
            else if (moneyRatio >= 1) affordabilityScore = 60; // Just affordable
            else if (moneyRatio >= 0.8) affordabilityScore = 40; // Tight but possible
            else affordabilityScore = 0; // Can't afford
            
            // Strategic consideration: Check if bot already owns properties in this color group
            let monopolyBonus = 0;
            if (space.type === 'property') {
                const sameColorProperties = gameData.settings.board.filter(p => 
                    p.type === 'property' && p.color === space.color
                );
                const ownedSameColor = sameColorProperties.filter(p => 
                    gameData.properties[p.position] && 
                    (gameData.properties[p.position].ownerId === currentPlayer.id ||
                     (gameData.properties[p.position].owners && gameData.properties[p.position].owners[currentPlayer.id]))
                ).length;
                
                if (ownedSameColor > 0) {
                    monopolyBonus = 20; // Bonus for completing color groups
                }
            }
            
            // Calculate final decision score
            const finalScore = (valueScore * 0.4) + (affordabilityScore * 0.5) + (monopolyBonus * 0.1);
            
            // Special rule: If bot has 3x the property price, buy immediately
            if (moneyRatio >= 3) {
                addLog(`🤖 ${currentPlayer.name} has plenty of money ($${currentPlayer.money}) and decided to buy ${space.name} for $${space.price}.`);
                await buyPropertyWithShare(position, 100);
                return;
            }
            
            // Decision thresholds
            if (finalScore >= 70) {
                // Buy 100% if very valuable and affordable
                addLog(`🤖 ${currentPlayer.name} decided to buy ${space.name} for $${space.price}.`);
                await buyPropertyWithShare(position, 100);
            } else if (finalScore >= 50) {
                // Buy 75% if moderately valuable
                const cost75 = Math.floor(space.price * 0.75);
                if (currentPlayer.money >= cost75) {
                    addLog(`🤖 ${currentPlayer.name} decided to buy 75% of ${space.name} for $${cost75}.`);
                    await buyPropertyWithShare(position, 75);
                } else {
                    // Can't afford 75%, try 50%
                    const cost50 = Math.floor(space.price * 0.5);
                    if (currentPlayer.money >= cost50) {
                        addLog(`🤖 ${currentPlayer.name} decided to buy 50% of ${space.name} for $${cost50}.`);
                        await buyPropertyWithShare(position, 50);
                    } else {
                        addLog(`🤖 ${currentPlayer.name} decided not to buy ${space.name} (can't afford).`);
                        await startAuction(position);
                    }
                }
            } else if (finalScore >= 30) {
                // Buy 50% if borderline
                const cost50 = Math.floor(space.price * 0.5);
                if (currentPlayer.money >= cost50) {
                    addLog(`🤖 ${currentPlayer.name} decided to buy 50% of ${space.name} for $${cost50}.`);
                    await buyPropertyWithShare(position, 50);
                } else {
                    addLog(`🤖 ${currentPlayer.name} decided not to buy ${space.name} (can't afford).`);
                    await startAuction(position);
                }
            } else {
                // Don't buy, start auction
                addLog(`🤖 ${currentPlayer.name} decided not to buy ${space.name} (not valuable enough).`);
                await startAuction(position);
            }
        }
        
        async function handleLanding(position) {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const space = gameData.board[position];
            
            let logMessages = [];
            
            // Log landing
            logMessages.push(`🏠 ${currentPlayer.name} landed on ${space.name}`);
            
            // Handle different space types
            if (space.type === 'property') {
                // Property logic - rent, buy, etc.
                // For now, just log
                logMessages.push(`This is a property: ${space.name}`);
            } else if (space.type === 'special') {
                // Special spaces like GO, Jail, etc.
                if (space.name === 'Go') {
                    // Pass GO logic
                    logMessages.push(`Passed GO! Collect $200`);
                } else if (space.name === 'Jail') {
                    // Jail logic
                    logMessages.push(`Just visiting Jail`);
                }
            }
            
            // Update turn state to landed
            await updateGame({
                turnState: 'landed',
                gameLog: [...gameData.gameLog, ...logMessages]
            });
        }
        
        window.joinTeam = async function(teamName) {
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            playersCopy[myIndex].team = teamName;
            
            await updateGame({
                players: playersCopy,
                gameLog: [...gameData.gameLog, `🤝 ${localPlayer.name} joined ${teamName.toUpperCase()} team!`]
            });
            
            hideModal();
            setTimeout(() => showTeamManager(), 200);
        };
        
        window.leaveTeam = async function() {
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            const oldTeam = playersCopy[myIndex].team;
            playersCopy[myIndex].team = '';
            
            await updateGame({
                players: playersCopy,
                gameLog: [...gameData.gameLog, `👋 ${localPlayer.name} left ${oldTeam.toUpperCase()} team.`]
            });
            
            hideModal();
            setTimeout(() => showTeamManager(), 200);
        };
        
        endTurnBtn.addEventListener('click', async () => {
            let nextPlayerIndex = (gameData.currentPlayerIndex + 1) % gameData.players.length;
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            // Check for extra turn from doubles (only if doubles rule is enabled)
            if (gameData.allowDoubles && gameData.players[gameData.currentPlayerIndex].doublesCount > 0) {
                nextPlayerIndex = gameData.currentPlayerIndex;
                playersCopy[gameData.currentPlayerIndex].doublesCount = 0;
            } else {
                // Skip bankrupt players
                while(gameData.players[nextPlayerIndex].isBankrupt) {
                    nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                }
            }
            
            // Reset doubles count when moving to next player
            if (nextPlayerIndex !== gameData.currentPlayerIndex) {
                playersCopy[gameData.currentPlayerIndex].doublesCount = 0;
            }
            
            // ⏭️ Check if next player should skip their turn (from Skip Joker Card)
            if (playersCopy[nextPlayerIndex].skipNextTurn) {
                playersCopy[nextPlayerIndex].skipNextTurn = false;
                const skippedPlayerName = playersCopy[nextPlayerIndex].name;
                
                // Move to the player after the skipped one
                nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                
                // Skip bankrupt players again
                while(gameData.players[nextPlayerIndex].isBankrupt) {
                    nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                }
                
                await updateGame({
                    currentPlayerIndex: nextPlayerIndex,
                    players: playersCopy,
                    turnState: 'start',
                    lastDiceRoll: [0, 0],
                    gameLog: [...gameData.gameLog, `⏭️ ${skippedPlayerName}'s turn was skipped!`, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
                });
                return;
            }
            
            await updateGame({
                currentPlayerIndex: nextPlayerIndex,
                players: playersCopy,
                turnState: 'start',
                lastDiceRoll: [0, 0],
                gameLog: [...gameData.gameLog, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
            });
        });
        
        async function handleLanding(position) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const propertyState = gameData.properties[position];
            
            addLog(`${currentPlayer.name} landed on ${space.name}.`);

            switch(space.type) {
                case 'property':
                case 'railroad':
                case 'utility':
                    if (propertyState.ownerId === null || (propertyState.owners && Object.keys(propertyState.owners).length === 0)) {
                        // Check if current player is a bot
                        if (currentPlayer.isBot) {
                            // Bot automatically decides whether to buy
                            await botDecidePropertyPurchase(position);
                        } else {
                            // Show property buy panel for human players
                            showPropertyBuyPanel(position);
                        }
                    } else if (propertyState.ownerId !== currentPlayer.id && !(propertyState.owners && propertyState.owners[currentPlayer.id])) {
                        // Kart başka birine ait ve bende hissem yok
                        payRent(position);
                    } else {
                        // Kartın sahibiyim veya hissem var
                        addLog('You own a share of this property.');
                        handleAfterLanding();
                    }
                    break;
                case 'go_to_jail':
                    goToJail();
                    break;
                case 'chance':
                case 'community_chest':
                    drawCard(space.type);
                    break;
                case 'tax':
                    payTax(space.amount);
                    break;
                default:
                    handleAfterLanding();
            }
        }
        
        // 🎲 Handle actions after landing (rent payment, property actions, etc.)
        async function handleAfterLanding() {
            // Turn does not end automatically, player must click End Turn manually
        }
        
        async function botTurn() {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // Wait a bit for realism
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Roll dice
            const die1 = Math.floor(Math.random() * 6) + 1;
            const die2 = Math.floor(Math.random() * 6) + 1;
            const total = die1 + die2;
            const newPosition = (currentPlayer.position + total) % 40;
            const newMoney = currentPlayer.money;
            
            const isDouble = (die1 === die2);
            const rollPlayersCopy = JSON.parse(JSON.stringify(gameData.players));
            rollPlayersCopy[gameData.currentPlayerIndex].position = newPosition;
            rollPlayersCopy[gameData.currentPlayerIndex].money = newMoney;
            
            let logMessages = [];
            logMessages.push(`🎲 ${currentPlayer.name} rolled ${die1} + ${die2} = ${total}`);
            
            if (isDouble) {
                rollPlayersCopy[gameData.currentPlayerIndex].doublesCount = (currentPlayer.doublesCount || 0) + 1;
                logMessages.push(`🎲 ${currentPlayer.name} rolled DOUBLES!`);
            }
            
            await updateGame({
                lastDiceRoll: [die1, die2],
                players: rollPlayersCopy,
                turnState: 'rolled',
                gameLog: [...gameData.gameLog, ...logMessages]
            });
            
            // Wait for animation
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Handle landing
            await handleLanding(newPosition);
            
            // Bot automatically ends turn after landing
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // End turn logic for bot
            let nextPlayerIndex = (gameData.currentPlayerIndex + 1) % gameData.players.length;
            
            const botPlayersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            // Check for extra turn from doubles (only if doubles rule is enabled)
            if (gameData.allowDoubles && gameData.players[gameData.currentPlayerIndex].doublesCount > 0) {
                nextPlayerIndex = gameData.currentPlayerIndex;
                botPlayersCopy[gameData.currentPlayerIndex].doublesCount = 0;
            } else {
                // Skip bankrupt players
                while(gameData.players[nextPlayerIndex].isBankrupt) {
                    nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                }
            }
            
            // Reset doubles count when moving to next player
            if (nextPlayerIndex !== gameData.currentPlayerIndex) {
                botPlayersCopy[gameData.currentPlayerIndex].doublesCount = 0;
            }
            
            // ⏭️ Check if next player should skip their turn (from Skip Joker Card)
            if (botPlayersCopy[nextPlayerIndex].skipNextTurn) {
                botPlayersCopy[nextPlayerIndex].skipNextTurn = false;
                const skippedPlayerName = botPlayersCopy[nextPlayerIndex].name;
                
                // Move to the player after the skipped one
                nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                
                // Skip bankrupt players again
                while(gameData.players[nextPlayerIndex].isBankrupt) {
                    nextPlayerIndex = (nextPlayerIndex + 1) % gameData.players.length;
                }
                
                await updateGame({
                    currentPlayerIndex: nextPlayerIndex,
                    players: botPlayersCopy,
                    turnState: 'start',
                    lastDiceRoll: [0, 0],
                    gameLog: [...gameData.gameLog, `⏭️ ${skippedPlayerName}'s turn was skipped!`, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
                });
                
                window.isBotTurnInProgress = false;
                return;
            }
            
            await updateGame({
                currentPlayerIndex: nextPlayerIndex,
                players: botPlayersCopy,
                turnState: 'start',
                lastDiceRoll: [0, 0],
                gameLog: [...gameData.gameLog, `It's now ${gameData.players[nextPlayerIndex].name}'s turn.`]
            });
            
            window.isBotTurnInProgress = false;
        }
        
        async function buyProperty(position) {
            // Eski buyProperty fonksiyonu - geriye dönük uyumluluk için
            return buyPropertyWithShare(position, 100);
        }
        
        async function buyPropertyWithShare(position, sharePercentage) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const cost = Math.floor(space.price * (sharePercentage / 100));
            
            // Eğer %100 değilse, ortak seçmesi gerekiyor
            if (sharePercentage < 100) {
                // Ortak seçme modalını göster
                showPartnerSelectionModal(position, sharePercentage, cost);
                return;
            }
            
            // %100 ise direkt satın al
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            
            const currentPlayerIndex = gameData.currentPlayerIndex;
            playersCopy[currentPlayerIndex].money -= cost;
            
            // Hisse sistemini ayarla
            if (!propertiesCopy[position].owners) {
                propertiesCopy[position].owners = {};
            }
            propertiesCopy[position].owners[playersCopy[currentPlayerIndex].id] = sharePercentage;
            propertiesCopy[position].ownerId = playersCopy[currentPlayerIndex].id;
            
            // 🎵 Play purchase sound
            playSound('purchase');
            
            // 💫 Animate property purchase
            animatePropertyPurchase(position, currentPlayer.color);
            
            await updateGame({
                players: playersCopy,
                properties: propertiesCopy,
                turnState: 'action_complete',
                gameLog: [...gameData.gameLog, `${playersCopy[currentPlayerIndex].name} bought ${sharePercentage}% of ${space.name} for $${cost}.`] 
            });
        }
        
        // 🤝 Partner Selection Modal for Shared Property
        function showPartnerSelectionModal(position, sharePercentage, cost) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            // Get other players who can afford the remaining share
            const remainingShare = 100 - sharePercentage;
            const remainingCost = Math.floor(space.price * (remainingShare / 100));
            
            const availablePartners = gameData.players.filter(p => 
                p.id !== currentPlayer.id && 
                !p.isBankrupt && 
                !p.isBot &&
                p.money >= remainingCost
            );
            
            if (availablePartners.length === 0) {
                showModal('No Partners Available', 
                    `<p>No other players can afford the remaining ${remainingShare}% share ($${remainingCost}).</p>
                     <p class="mt-2 text-sm text-gray-600">You can only buy 100% or start an auction.</p>`, 
                    [
                        {text: 'Buy 100% Instead', class: 'bg-green-600', action: () => {
                            hideModal();
                            buyPropertyWithShare(position, 100);
                        }},
                        {text: 'Start Auction', class: 'bg-yellow-500', action: () => {
                            hideModal();
                            startAuction(position);
                        }},
                        {text: 'Cancel', class: 'bg-gray-500', action: hideModal}
                    ]
                );
                return;
            }
            
            let partnerHTML = `
                <div class="text-left space-y-3">
                    <p class="text-center font-semibold text-gray-700">
                        You want to buy <span class="text-green-600">${sharePercentage}%</span> for <span class="text-green-600">$${cost}</span>
                    </p>
                    <p class="text-center text-sm text-gray-600">
                        Choose a partner to buy the remaining <span class="font-semibold">${remainingShare}%</span> for <span class="font-semibold">$${remainingCost}</span>
                    </p>
                    <div class="space-y-2 mt-4">
            `;
            
            availablePartners.forEach(partner => {
                partnerHTML += `
                    <button onclick="window.sendPartnershipRequest('${position}', ${sharePercentage}, '${partner.id}')" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-between transition duration-200">
                        <span>${partner.name}</span>
                        <span class="text-sm">💰 $${partner.money}</span>
                    </button>
                `;
            });
            
            partnerHTML += `
                    </div>
                    <p class="text-xs text-gray-500 text-center mt-4">
                        💡 Your partner will receive a notification to accept or decline the partnership.
                    </p>
                </div>
            `;
            
            showModal(`🤝 Choose Your Partner`, partnerHTML, [
                {text: 'Cancel', class: 'bg-gray-500', action: () => {
                    hideModal();
                    showPropertyBuyPanel(position); // Go back to buy panel
                }}
            ]);
        }
        
        // 📤 Send Partnership Request
        window.sendPartnershipRequest = async function(position, mySharePercentage, partnerId) {
            hideModal();
            
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const partner = gameData.players.find(p => p.id === partnerId);
            
            // Don't send partnership requests to bots
            if (partner && partner.isBot) {
                showModal('Cannot Send Partnership', 'You cannot send partnership requests to bot players.', [{text: 'OK', class: 'bg-gray-500', action: hideModal}]);
                return;
            }
            
            const partnerSharePercentage = 100 - mySharePercentage;
            const myCost = Math.floor(space.price * (mySharePercentage / 100));
            const partnerCost = Math.floor(space.price * (partnerSharePercentage / 100));
            
            // Create partnership request
            const partnershipRequest = {
                id: `partnership_${Date.now()}`,
                propertyPosition: position,
                propertyName: space.name,
                requesterId: currentPlayer.id,
                requesterName: currentPlayer.name,
                requesterShare: mySharePercentage,
                requesterCost: myCost,
                partnerId: partnerId,
                partnerName: partner.name,
                partnerShare: partnerSharePercentage,
                partnerCost: partnerCost,
                status: 'pending',
                timestamp: Date.now()
            };
            
            // Add to game data
            const partnershipRequests = gameData.partnershipRequests || [];
            partnershipRequests.push(partnershipRequest);
            
            await updateGame({
                partnershipRequests: partnershipRequests,
                gameLog: [...gameData.gameLog, `🤝 ${currentPlayer.name} sent a partnership request to ${partner.name} for ${space.name}`]
            });
            
            showModal('Partnership Request Sent', 
                `<p>Your partnership request has been sent to <span class="font-bold">${partner.name}</span>.</p>
                 <p class="text-sm text-gray-600 mt-2">Waiting for their response...</p>`, 
                [{text: 'OK', class: 'bg-green-500', action: hideModal}]
            );
        }
        
        // 📬 Check for Partnership Requests
        function checkPartnershipRequests() {
            if (!gameData || !gameData.partnershipRequests) return;
            
            const myRequests = gameData.partnershipRequests.filter(req => 
                req.partnerId === localPlayer.id && req.status === 'pending'
            );
            
            if (myRequests.length > 0) {
                const latestRequest = myRequests[myRequests.length - 1];
                
                // Check if the current player (who might be receiving this request) is a bot
                const currentPlayer = gameData.players[gameData.currentPlayerIndex];
                if (currentPlayer && currentPlayer.id === localPlayer.id && currentPlayer.isBot) {
                    // Bot automatically decides on partnership
                    botDecidePartnership(latestRequest);
                } else {
                    // Show modal for human players
                    showPartnershipRequestModal(latestRequest);
                }
            }
        }
        
        // 🤖 Bot Partnership Decision
        async function botDecidePartnership(request) {
            // Bot thinks for 2 seconds before deciding
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const requester = gameData.players.find(p => p.id === request.requesterId);
            const partner = gameData.players.find(p => p.id === request.partnerId);
            const space = gameData.settings.board[request.propertyPosition];
            
            if (!requester || !partner) {
                declinePartnership(request.id);
                return;
            }
            
            // Check if bot can afford
            if (partner.money < request.partnerCost) {
                addLog(`🤖 ${partner.name} declined partnership with ${requester.name} for ${space.name} (can't afford $${request.partnerCost}).`);
                declinePartnership(request.id);
                return;
            }
            
            // Calculate property value score (same as in property purchase)
            let propertyValueScore = 0;
            switch(space.type) {
                case 'railroad': propertyValueScore = 80; break;
                case 'utility': propertyValueScore = 70; break;
                case 'property':
                    const colorGroups = {
                        'brown': 40, 'lightblue': 45, 'pink': 50, 'orange': 55,
                        'red': 60, 'yellow': 65, 'green': 70, 'darkblue': 75
                    };
                    propertyValueScore = colorGroups[space.color] || 50;
                    break;
            }
            
            // Partner trust score (based on existing partnerships)
            let trustScore = 50; // Base trust
            let existingPartnerships = 0;
            
            // Count existing partnerships between these players
            Object.values(gameData.properties).forEach(property => {
                if (property.owners && property.owners[requester.id] && property.owners[partner.id]) {
                    existingPartnerships++;
                    trustScore += 10; // Bonus for existing partnerships
                }
            });
            
            // Adjust trust based on requester's financial situation
            const requesterMoneyRatio = requester.money / (requester.money + partner.money);
            if (requesterMoneyRatio > 0.6) trustScore += 10; // Requester is wealthier
            else if (requesterMoneyRatio < 0.4) trustScore -= 10; // Requester is poorer
            
            // Cost fairness score
            const myShareRatio = request.partnerShare / 100;
            const costFairness = Math.abs(myShareRatio - (request.partnerCost / space.price));
            const fairnessScore = Math.max(0, 100 - (costFairness * 200)); // Penalize unfair deals
            
            // Strategic value: Check if this completes a color group
            let strategicBonus = 0;
            if (space.type === 'property') {
                const sameColorProperties = gameData.settings.board.filter(p => 
                    p.type === 'property' && p.color === space.color
                );
                const partnerOwnedSameColor = sameColorProperties.filter(p => 
                    gameData.properties[p.position] && 
                    (gameData.properties[p.position].ownerId === partner.id ||
                     (gameData.properties[p.position].owners && gameData.properties[p.position].owners[partner.id]))
                ).length;
                
                if (partnerOwnedSameColor > 0) {
                    strategicBonus = 15; // Bonus for completing color groups
                }
            }
            
            // Calculate final decision score
            const finalScore = (propertyValueScore * 0.3) + (trustScore * 0.25) + (fairnessScore * 0.25) + (strategicBonus * 0.2);
            
            if (finalScore >= 65) {
                // Accept partnership
                addLog(`🤖 ${partner.name} accepted partnership with ${requester.name} for ${request.partnerShare}% of ${space.name} (cost: $${request.partnerCost}).`);
                
                // Accept partnership - implement bot logic inline
                const requests = [...(gameData.partnershipRequests || [])];
                const partnershipRequest = requests.find(r => r.id === request.id);
                
                if (partnershipRequest) {
                    const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                    const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
                    
                    const requesterIndex = playersCopy.findIndex(p => p.id === partnershipRequest.requesterId);
                    const partnerIndex = playersCopy.findIndex(p => p.id === partnershipRequest.partnerId);
                    
                    // Deduct money
                    playersCopy[requesterIndex].money -= partnershipRequest.requesterCost;
                    playersCopy[partnerIndex].money -= partnershipRequest.partnerCost;
                    
                    // Set up ownership
                    if (!propertiesCopy[partnershipRequest.propertyPosition].owners) {
                        propertiesCopy[partnershipRequest.propertyPosition].owners = {};
                    }
                    propertiesCopy[partnershipRequest.propertyPosition].owners[partnershipRequest.requesterId] = partnershipRequest.requesterShare;
                    propertiesCopy[partnershipRequest.propertyPosition].owners[partnershipRequest.partnerId] = partnershipRequest.partnerShare;
                    
                    // Determine main owner (highest share)
                    const mainOwner = partnershipRequest.requesterShare > partnershipRequest.partnerShare ? partnershipRequest.requesterId : partnershipRequest.partnerId;
                    propertiesCopy[partnershipRequest.propertyPosition].ownerId = mainOwner;
                    
                    // Remove request
                    const updatedRequests = requests.filter(r => r.id !== partnershipRequest.id);
                    
                    await updateGame({
                        players: playersCopy,
                        properties: propertiesCopy,
                        partnershipRequests: updatedRequests,
                        turnState: 'action_complete',
                        gameLog: [...gameData.gameLog, `🤝 ${partnershipRequest.requesterName} and ${partnershipRequest.partnerName} became partners on ${partnershipRequest.propertyName}!`]
                    });
                }
            } else {
                // Decline partnership
                addLog(`🤖 ${partner.name} declined partnership with ${requester.name} for ${space.name} (score: ${Math.round(finalScore)}).`);
                
                // Decline partnership - implement bot logic inline
                const requests = [...(gameData.partnershipRequests || [])];
                const partnershipRequest = requests.find(r => r.id === request.id);
                
                if (partnershipRequest) {
                    // Remove request
                    const updatedRequests = requests.filter(r => r.id !== partnershipRequest.id);
                    
                    // Add to declined list so requester knows
                    const declinedRequests = gameData.declinedPartnershipRequests || [];
                    declinedRequests.push({
                        ...partnershipRequest,
                        declinedAt: Date.now()
                    });
                    
                    await updateGame({
                        partnershipRequests: updatedRequests,
                        declinedPartnershipRequests: declinedRequests,
                        gameLog: [...gameData.gameLog, `❌ ${partnershipRequest.partnerName} declined partnership with ${partnershipRequest.requesterName} for ${partnershipRequest.propertyName}`]
                    });
                }
            }
        }
        
        // 🤖 Bot Trade Decision
        async function botDecideTrade(trade) {
            // Bot thinks for 2 seconds before deciding
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const fromPlayer = gameData.players.find(p => p.id === trade.fromId);
            const toPlayer = gameData.players.find(p => p.id === trade.toId);
            
            if (!fromPlayer || !toPlayer) {
                declineTrade(trade.id);
                return;
            }
            
            // Calculate trade value
            let offerValue = 0;
            let requestValue = 0;
            
            // Calculate offered money
            offerValue += trade.fromMoney || 0;
            
            // Calculate offered properties value
            if (trade.fromProperties && trade.fromProperties.length > 0) {
                trade.fromProperties.forEach(propIndex => {
                    const space = gameData.settings.board[propIndex];
                    if (space) offerValue += space.price;
                });
            }
            
            // Calculate requested money
            requestValue += trade.toMoney || 0;
            
            // Calculate requested properties value
            if (trade.toProperties && trade.toProperties.length > 0) {
                trade.toProperties.forEach(propIndex => {
                    const space = gameData.settings.board[propIndex];
                    if (space) requestValue += space.price;
                });
            }
            
            // Bot's perspective: What bot is giving vs receiving
            const botGivingValue = trade.toMoney + (trade.toProperties ? trade.toProperties.reduce((sum, propIndex) => {
                const space = gameData.settings.board[propIndex];
                return sum + (space ? space.price : 0);
            }, 0) : 0);
            
            const botReceivingValue = trade.fromMoney + (trade.fromProperties ? trade.fromProperties.reduce((sum, propIndex) => {
                const space = gameData.settings.board[propIndex];
                return sum + (space ? space.price : 0);
            }, 0) : 0);
            
            // Bot's financial situation
            const botMoneyRatio = toPlayer.money / (fromPlayer.money + toPlayer.money);
            
            // Calculate decision score
            let score = 0;
            
            // Value difference (positive if bot gains value)
            const valueDiff = botReceivingValue - botGivingValue;
            
            // New trade logic: Check if trade is favorable
            const isFavorableTrade = valueDiff >= (botGivingValue * 0.5); // 1.5x value or more
            
            if (isFavorableTrade) {
                // 70% chance to accept, 30% chance to decline
                const acceptChance = Math.random() < 0.7;
                if (acceptChance) {
                    addLog(`🤖 ${toPlayer.name} accepted favorable trade with ${fromPlayer.name} (receiving ${valueDiff} more value).`);
                    acceptTrade(trade.id);
                } else {
                    addLog(`🤖 ${toPlayer.name} declined favorable trade with ${fromPlayer.name} despite good value.`);
                    declineTrade(trade.id);
                }
            } else {
                // Unfavorable trade - always decline
                addLog(`🤖 ${toPlayer.name} declined unfavorable trade with ${fromPlayer.name} (losing ${Math.abs(valueDiff)} value).`);
                declineTrade(trade.id);
            }
        }
        
        // ❌ Check for Declined Partnerships
        let lastCheckedDeclinedTime = 0;
        function checkDeclinedPartnerships(oldGameData) {
            if (!gameData || !gameData.declinedPartnershipRequests) return;
            
            const oldDeclined = (oldGameData && oldGameData.declinedPartnershipRequests) || [];
            const newDeclined = gameData.declinedPartnershipRequests || [];
            
            // Find newly declined requests for current player
            const myNewDeclinedRequests = newDeclined.filter(declined => {
                const isNew = !oldDeclined.find(old => old.id === declined.id);
                const isMine = declined.requesterId === localPlayer.id;
                const isRecent = declined.declinedAt > lastCheckedDeclinedTime;
                return isNew && isMine && isRecent;
            });
            
            if (myNewDeclinedRequests.length > 0) {
                const declined = myNewDeclinedRequests[0];
                lastCheckedDeclinedTime = declined.declinedAt;
                
                // Check if I'm current player and property is still available
                const currentPlayer = gameData.players[gameData.currentPlayerIndex];
                if (currentPlayer && currentPlayer.id === localPlayer.id) {
                    const propertyState = gameData.properties[declined.propertyPosition];
                    if (propertyState && (propertyState.ownerId === null || (propertyState.owners && Object.keys(propertyState.owners).length === 0))) {
                        // Show notification and then buy panel
                        showModal('❌ Partnership Declined', 
                            `<p><span class="font-bold">${declined.partnerName}</span> declined your partnership offer for <span class="font-bold">${declined.propertyName}</span>.</p>
                             <p class="text-sm text-gray-600 mt-2">You must now buy it fully or start an auction.</p>`, 
                            [{text: 'OK', class: 'bg-blue-500', action: () => {
                                hideModal();
                                showPropertyBuyPanel(declined.propertyPosition);
                            }}]
                        );
                    }
                }
            }
        }
        
        // 📨 Show Partnership Request Modal
        function showPartnershipRequestModal(request) {
            const requester = gameData.players.find(p => p.id === request.requesterId);
            const me = gameData.players.find(p => p.id === localPlayer.id);
            
            if (!requester || !me) return;
            
            const canAfford = me.money >= request.partnerCost;
            
            let body = `
                <div class="text-left space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <h4 class="font-bold text-blue-800 mb-2">🤝 Partnership Offer</h4>
                        <p class="text-sm"><span class="font-semibold">${requester.name}</span> wants to partner with you on:</p>
                        <p class="text-lg font-bold text-gray-800 mt-2">${request.propertyName}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600">Their Share</p>
                            <p class="text-xl font-bold text-green-700">${request.requesterShare}%</p>
                            <p class="text-sm text-gray-700">$${request.requesterCost}</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600">Your Share</p>
                            <p class="text-xl font-bold text-purple-700">${request.partnerShare}%</p>
                            <p class="text-sm ${canAfford ? 'text-gray-700' : 'text-red-600'}">$${request.partnerCost}</p>
                        </div>
                    </div>
                    
                    ${!canAfford ? '<p class="text-red-600 text-sm text-center">⚠️ You don\'t have enough money!</p>' : ''}
                    
                    <p class="text-xs text-gray-500 text-center">
                        💡 You'll share rental income and building rights based on ownership percentage.
                    </p>
                </div>
            `;
            
            showModal(`🤝 Partnership Request`, body, [
                {text: '✅ Accept Partnership', class: 'bg-green-600 hover:bg-green-700', 
                 action: () => acceptPartnership(request.id), disabled: !canAfford},
                {text: '❌ Decline', class: 'bg-red-600 hover:bg-red-700', 
                 action: () => declinePartnership(request.id)}
            ]);
        }
        
        // ✅ Accept Partnership
        async function acceptPartnership(requestId) {
            const requests = [...(gameData.partnershipRequests || [])];
            const request = requests.find(r => r.id === requestId);
            
            if (!request) {
                hideModal();
                return;
            }
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            
            const requesterIndex = playersCopy.findIndex(p => p.id === request.requesterId);
            const partnerIndex = playersCopy.findIndex(p => p.id === request.partnerId);
            
            // Deduct money
            playersCopy[requesterIndex].money -= request.requesterCost;
            playersCopy[partnerIndex].money -= request.partnerCost;
            
            // Set up ownership
            if (!propertiesCopy[request.propertyPosition].owners) {
                propertiesCopy[request.propertyPosition].owners = {};
            }
            propertiesCopy[request.propertyPosition].owners[request.requesterId] = request.requesterShare;
            propertiesCopy[request.propertyPosition].owners[request.partnerId] = request.partnerShare;
            
            // Determine main owner (highest share)
            const mainOwner = request.requesterShare > request.partnerShare ? request.requesterId : request.partnerId;
            propertiesCopy[request.propertyPosition].ownerId = mainOwner;
            
            // Remove request
            const updatedRequests = requests.filter(r => r.id !== requestId);
            
            // 🎵 Play purchase sound
            playSound('purchase');
            
            await updateGame({
                players: playersCopy,
                properties: propertiesCopy,
                partnershipRequests: updatedRequests,
                turnState: 'action_complete',
                gameLog: [...gameData.gameLog, `🤝 ${request.requesterName} and ${request.partnerName} became partners on ${request.propertyName}!`]
            });
            
            hideModal();
            showModal('🎉 Partnership Accepted!', 
                `<p>You are now partners with <span class="font-bold">${request.requesterName}</span> on <span class="font-bold">${request.propertyName}</span>!</p>
                 <p class="text-sm text-gray-600 mt-2">You own ${request.partnerShare}% and they own ${request.requesterShare}%.</p>`, 
                [{text: 'Great!', class: 'bg-green-500', action: hideModal}]
            );
        }
        
        // ❌ Decline Partnership
        async function declinePartnership(requestId) {
            const requests = [...(gameData.partnershipRequests || [])];
            const request = requests.find(r => r.id === requestId);
            
            if (!request) {
                hideModal();
                return;
            }
            
            // Remove request
            const updatedRequests = requests.filter(r => r.id !== requestId);
            
            // Add to declined list so requester knows
            const declinedRequests = gameData.declinedPartnershipRequests || [];
            declinedRequests.push({
                ...request,
                declinedAt: Date.now()
            });
            
            await updateGame({
                partnershipRequests: updatedRequests,
                declinedPartnershipRequests: declinedRequests,
                gameLog: [...gameData.gameLog, `❌ ${request.partnerName} declined partnership with ${request.requesterName} for ${request.propertyName}`]
            });
            
            hideModal();
            showModal('Partnership Declined', 
                `<p>You declined the partnership offer for <span class="font-bold">${request.propertyName}</span>.</p>`, 
                [{text: 'OK', class: 'bg-gray-500', action: hideModal}]
            );
        }
        
        // Auction system with timer - everyone can bid but not twice in a row
        let auctionTimerInterval = null;
        
        function startAuction(position) {
            // Close both modal and property buy panel
            hideModal();
            hidePropertyBuyPanel();
            
            const space = gameData.settings.board[position];
            const auctionTimer = gameData.settings.auctionTimer || 10;
            
            // Get all non-bankrupt players
            const activePlayers = gameData.players.filter(p => !p.isBankrupt).map(p => p.id);
            
            const auction = {
                position: position,
                propertyName: space.name,
                currentBid: 10, // Start at $10
                currentBidder: null,
                lastBidder: null, // Track who bid last (can't bid twice in a row)
                playersInAuction: activePlayers,
                timeRemaining: auctionTimer,
                timerDuration: auctionTimer,
                active: true,
                roundsWithoutBid: 0 // Track if everyone passed
            };
            
            updateGame({
                auction: auction,
                gameLog: [...gameData.gameLog, `🔨 Auction started for ${space.name}! Starting bid: $10`]
            });
        }
        
        function showAuctionModal() {
            if (!gameData.auction || !gameData.auction.active) return;
            
            const space = gameData.settings.board[gameData.auction.position];
            const currentPlayer = gameData.players.find(p => p.id === localPlayer.id);
            const amIInAuction = gameData.auction.playersInAuction.includes(localPlayer.id);
            
            // Can bid if: in auction, not bankrupt, not the last bidder, and can afford
            const iAmLastBidder = gameData.auction.lastBidder === localPlayer.id;
            const canBidAtAll = currentPlayer && !currentPlayer.isBankrupt && 
                               amIInAuction && !iAmLastBidder;
            
            const bidderName = gameData.auction.currentBidder 
                ? gameData.players.find(p => p.id === gameData.auction.currentBidder)?.name 
                : 'None';
            
            // Calculate bid amounts that player can afford
            const canAfford10 = currentPlayer && currentPlayer.money >= (gameData.auction.currentBid + 10);
            const canAfford50 = currentPlayer && currentPlayer.money >= (gameData.auction.currentBid + 50);
            const canAfford100 = currentPlayer && currentPlayer.money >= (gameData.auction.currentBid + 100);
            
            let statusMessage = '';
            if (iAmLastBidder) {
                statusMessage = '⏳ Waiting for others to bid...';
            } else if (canBidAtAll) {
                statusMessage = '✅ You can bid now!';
            } else if (!amIInAuction) {
                statusMessage = '❌ You passed';
            } else {
                statusMessage = '⏳ Waiting...';
            }
            
            showModal(
                `🔨 Auction: ${gameData.auction.propertyName}`,
                `
                    <div class="text-center">
                        <p class="text-lg mb-2">Current Bid: <span class="font-bold text-green-600">$${gameData.auction.currentBid}</span></p>
                        <p class="text-sm mb-2">Highest Bidder: <span class="font-bold">${bidderName}</span></p>
                        <p class="text-sm text-gray-600">Your Money: $${currentPlayer?.money || 0}</p>
                        <div class="mt-3 p-2 ${iAmLastBidder ? 'bg-yellow-50' : 'bg-blue-50'} rounded">
                            <p class="text-sm font-bold ${iAmLastBidder ? 'text-yellow-600' : 'text-blue-600'}">
                                ${statusMessage}
                            </p>
                            <p class="text-xl font-bold ${gameData.auction.timeRemaining <= 3 ? 'text-red-600' : 'text-blue-600'} mt-1">
                                ⏱️ ${gameData.auction.timeRemaining}s
                            </p>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Players remaining: ${gameData.auction.playersInAuction.length}</p>
                        ${iAmLastBidder ? '<p class="text-xs text-yellow-600 mt-1">You must wait for someone else to bid before bidding again</p>' : ''}
                    </div>
                `,
                [
                    { 
                        text: `+$10 (Total: $${gameData.auction.currentBid + 10})`, 
                        class: 'bg-green-500', 
                        action: () => placeBid(gameData.auction.currentBid + 10),
                        disabled: !canBidAtAll || !canAfford10
                    },
                    { 
                        text: `+$50 (Total: $${gameData.auction.currentBid + 50})`, 
                        class: 'bg-green-600', 
                        action: () => placeBid(gameData.auction.currentBid + 50),
                        disabled: !canBidAtAll || !canAfford50
                    },
                    { 
                        text: `+$100 (Total: $${gameData.auction.currentBid + 100})`, 
                        class: 'bg-green-700', 
                        action: () => placeBid(gameData.auction.currentBid + 100),
                        disabled: !canBidAtAll || !canAfford100
                    },
                    { 
                        text: 'Pass', 
                        class: 'bg-red-500', 
                        action: () => passAuction(),
                        disabled: !amIInAuction
                    }
                ]
            );
        }
        
        function placeBid(amount) {
            const currentPlayer = gameData.players.find(p => p.id === localPlayer.id);
            
            if (amount > currentPlayer.money) {
                alert('You don\'t have enough money!');
                return;
            }
            
            if (gameData.auction.lastBidder === localPlayer.id) {
                alert('You must wait for someone else to bid!');
                return;
            }
            
            const auctionCopy = JSON.parse(JSON.stringify(gameData.auction));
            auctionCopy.currentBid = amount;
            auctionCopy.currentBidder = localPlayer.id;
            auctionCopy.lastBidder = localPlayer.id;
            auctionCopy.roundsWithoutBid = 0; // Reset because someone bid
            
            // Reset timer when someone bids
            auctionCopy.timeRemaining = auctionCopy.timerDuration;
            
            updateGame({
                auction: auctionCopy,
                gameLog: [...gameData.gameLog, `${currentPlayer.name} bids $${amount}!`]
            });
        }
        
        function passAuction() {
            if (!gameData.auction.playersInAuction.includes(localPlayer.id)) {
                alert('You already passed!');
                return;
            }
            
            hideModal();
            
            const currentPlayer = gameData.players.find(p => p.id === localPlayer.id);
            const auctionCopy = JSON.parse(JSON.stringify(gameData.auction));
            
            // Remove current player from auction
            auctionCopy.playersInAuction = auctionCopy.playersInAuction.filter(id => id !== localPlayer.id);
            
            // Check if this player was the only one left
            if (auctionCopy.playersInAuction.length === 0) {
                updateGame({
                    auction: auctionCopy,
                    gameLog: [...gameData.gameLog, `${currentPlayer.name} passed. Everyone passed!`]
                });
                setTimeout(() => endAuction(), 500);
                return;
            }
            
            // Check if only the current bidder is left
            if (auctionCopy.playersInAuction.length === 1 && auctionCopy.currentBidder && 
                auctionCopy.playersInAuction[0] === auctionCopy.currentBidder) {
                updateGame({
                    auction: auctionCopy,
                    gameLog: [...gameData.gameLog, `${currentPlayer.name} passed. Only bidder remains!`]
                });
                setTimeout(() => endAuction(), 500);
                return;
            }
            
            // Reset timer
            auctionCopy.timeRemaining = auctionCopy.timerDuration;
            
            updateGame({
                auction: auctionCopy,
                gameLog: [...gameData.gameLog, `${currentPlayer.name} passed.`]
            });
        }
        
        // Timer countdown function
        function updateAuctionTimer() {
            if (!gameData.auction || !gameData.auction.active) {
                if (auctionTimerInterval) {
                    clearInterval(auctionTimerInterval);
                    auctionTimerInterval = null;
                }
                return;
            }
            
            const auctionCopy = JSON.parse(JSON.stringify(gameData.auction));
            auctionCopy.timeRemaining--;
            
            if (auctionCopy.timeRemaining <= 0) {
                // Time's up! Check if there was a bidder
                if (auctionCopy.currentBidder) {
                    // Someone bid, they win!
                    updateGame({
                        auction: auctionCopy,
                        gameLog: [...gameData.gameLog, `⏰ Time's up! Auction ending...`]
                    });
                    setTimeout(() => endAuction(), 500);
                } else {
                    // No one bid, auction fails
                    auctionCopy.playersInAuction = [];
                    updateGame({
                        auction: auctionCopy,
                        gameLog: [...gameData.gameLog, `⏰ Time's up! No bids received.`]
                    });
                    setTimeout(() => endAuction(), 500);
                }
            } else {
                // Just update timer
                updateGame({
                    auction: auctionCopy
                });
            }
        }
        
        async function endAuction() {
            if (!gameData.auction) return;
            
            // Clear timer
            if (auctionTimerInterval) {
                clearInterval(auctionTimerInterval);
                auctionTimerInterval = null;
            }
            
            // Close auction modal for everyone
            hideModal();
            
            if (gameData.auction.currentBidder) {
                // Winner buys the property
                const winner = gameData.players.find(p => p.id === gameData.auction.currentBidder);
                const winnerIndex = gameData.players.findIndex(p => p.id === gameData.auction.currentBidder);
                
                const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
                
                playersCopy[winnerIndex].money -= gameData.auction.currentBid;
                propertiesCopy[gameData.auction.position].ownerId = gameData.auction.currentBidder;
                
                await updateGame({
                    players: playersCopy,
                    properties: propertiesCopy,
                    auction: { active: false },
                    gameLog: [...gameData.gameLog, `🔨 ${winner.name} won the auction for ${gameData.auction.propertyName} at $${gameData.auction.currentBid}!`]
                });
                
                // Show brief notification (auto-closes)
                showModal('🎉 Auction Won!', `${winner.name} won ${gameData.auction.propertyName} for $${gameData.auction.currentBid}!`, [
                    { text: 'Continue', class: 'bg-blue-500', action: hideModal }
                ]);
                
                // Auto-close after 2 seconds
                setTimeout(() => {
                    hideModal();
                }, 2000);
            } else {
                await updateGame({
                    auction: { active: false },
                    gameLog: [...gameData.gameLog, `🔨 Auction ended with no bids for ${gameData.auction.propertyName}.`]
                });
                hideModal();
            }
            
            endTurn();
        }

        
        async function payRent(position) {
            const space = gameData.settings.board[position];
            const propertyState = gameData.properties[position];
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];

            let rentAmount = 0;
            if (space.type === 'property') {
                rentAmount = space.rent[propertyState.houses];
            } else if (space.type === 'railroad') {
                const owner = gameData.players.find(p => p.id === propertyState.ownerId);
                const railCount = gameData.properties.filter(p => p.ownerId === owner.id && gameData.settings.board[p.spaceIndex].type === 'railroad').length;
                rentAmount = 25 * Math.pow(2, railCount - 1);
            }
            
            // Hisse sahiplerine göre kira dağıtımı
            const owners = propertyState.owners || { [propertyState.ownerId]: 100 };
            let rentDistribution = '';
            
            showModal(
                'Pay Rent',
                `<p>You landed on ${space.name}. You must pay $${rentAmount} in rent.</p>
                 <p class="text-xs text-gray-600 mt-2">Rent will be distributed among share holders.</p>`,
                [{ text: 'Pay Rent', class: 'bg-red-500', action: async () => {
                    const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                    
                    // Kiradan payını çıkar
                    playersCopy[currentPlayerIndex].money -= rentAmount;
                    
                    // Kira hisse sahiplerine dağıtılır
                    for (const [ownerId, sharePercentage] of Object.entries(owners)) {
                        const ownerShare = Math.floor(rentAmount * (sharePercentage / 100));
                        const ownerIndex = playersCopy.findIndex(p => p.id === ownerId);
                        if (ownerIndex !== -1) {
                            playersCopy[ownerIndex].money += ownerShare;
                            const ownerName = playersCopy[ownerIndex].name;
                            addLog(`${currentPlayer.name} paid $${ownerShare} (${sharePercentage}%) to ${ownerName}.`);
                        }
                    }
                    
                    await updateGame({ players: playersCopy });
                    hideModal();
                    endTurn();
                }}]
            );
        }

        async function goToJail() {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const jailPosition = gameData.settings.board.findIndex(s => s.type === 'jail');
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            playersCopy[currentPlayerIndex].position = jailPosition;
            playersCopy[currentPlayerIndex].inJail = true;
            playersCopy[currentPlayerIndex].jailTurns = 0;
            
            addLog(`${playersCopy[currentPlayerIndex].name} was sent to jail!`);
            await updateGame({ players: playersCopy });
            endTurn();
        }

        async function drawCard(type) {
            const cards = type === 'chance' ? gameData.settings.chanceCards : gameData.settings.communityChestCards;
            
            if (!cards || cards.length === 0) {
                addLog('No cards available in this game mode.');
                endTurn();
                return;
            }
            
            const card = cards[Math.floor(Math.random() * cards.length)];
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            addLog(`${playersCopy[currentPlayerIndex].name} drew: "${card.text}"`);
            
            let actionText = card.text;
            let autoClose = false;
            
            switch(card.action) {
                case 'add_money':
                    playersCopy[currentPlayerIndex].money += card.amount;
                    await updateGame({ players: playersCopy });
                    autoClose = true;
                    break;
                case 'remove_money':
                    playersCopy[currentPlayerIndex].money -= card.amount;
                    await updateGame({ players: playersCopy });
                    autoClose = true;
                    break;
                case 'move_to':
                    playersCopy[currentPlayerIndex].position = card.space;
                    if (card.collect) {
                        playersCopy[currentPlayerIndex].money += gameData.settings.passGoAmount;
                    }
                    await updateGame({ players: playersCopy });
                    setTimeout(() => { 
                        hideModal(); 
                        handleLanding(card.space);
                        // Eğer property ise ve alınabilir durumdaysa, paneli göster
                        const space = gameData.settings.board[card.space];
                        const propertyState = gameData.properties[card.space];
                        if (space.type === 'property' && (!propertyState.ownerId || (propertyState.owners && Object.keys(propertyState.owners).length === 0))) {
                            showPropertyBuyPanel(card.space);
                        } else {
                            updateGame({ turnState: 'action_complete' });
                        }
                    }, 1000);
                    break;
                case 'move_back':
                    // Go back N spaces
                    const oldPos = playersCopy[currentPlayerIndex].position;
                    const newPos = (oldPos - card.amount + gameData.settings.board.length) % gameData.settings.board.length;
                    playersCopy[currentPlayerIndex].position = newPos;
                    await updateGame({ players: playersCopy });
                    setTimeout(() => {
                        hideModal();
                        handleLanding(newPos);
                        // Eğer property ise ve alınabilir durumdaysa, paneli göster
                        const space = gameData.settings.board[newPos];
                        const propertyState = gameData.properties[newPos];
                        if (space.type === 'property' && (!propertyState.ownerId || (propertyState.owners && Object.keys(propertyState.owners).length === 0))) {
                            showPropertyBuyPanel(newPos);
                        } else {
                            updateGame({ turnState: 'action_complete' });
                        }
                    }, 1000);
                    break;
                case 'go_to_jail':
                    hideModal();
                    await goToJail();
                    return;
                case 'get_out_of_jail':
                    playersCopy[currentPlayerIndex].getOutOfJailCards++;
                    await updateGame({ players: playersCopy });
                    autoClose = true;
                    break;
                case 'repair':
                    const houseCount = gameData.properties.filter(p => p.ownerId === playersCopy[currentPlayerIndex].id && p.houses > 0 && p.houses < 5).reduce((sum, p) => sum + p.houses, 0);
                    const hotelCount = gameData.properties.filter(p => p.ownerId === playersCopy[currentPlayerIndex].id && p.houses === 5).length;
                    const repairCost = (houseCount * card.house) + (hotelCount * card.hotel);
                    playersCopy[currentPlayerIndex].money -= repairCost;
                    actionText += `\n\nTotal cost: $${repairCost}`;
                    await updateGame({ players: playersCopy });
                    autoClose = true;
                    break;
            }
            
            showModal(
                type === 'chance' ? '❓ Chance Card' : '🎁 Community Chest', 
                `<p class="text-lg">${actionText}</p>`, 
                [{ text: 'OK', class: 'bg-blue-500', action: () => { hideModal(); if (autoClose) endTurn(); }}]
            );
        }
        
         async function payTax(amount) {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            showModal(
                'Income Tax',
                `<p>You must pay $${amount} in taxes.</p>`,
                [{ text: `Pay $${amount}`, class: 'bg-red-500', action: async () => {
                    const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                    playersCopy[currentPlayerIndex].money -= amount;
                    addLog(`${playersCopy[currentPlayerIndex].name} paid $${amount} in taxes.`);
                    await updateGame({ players: playersCopy });
                    hideModal();
                    endTurn();
                }}]
            );
        }
        
        async function endTurn() {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            const isDouble = gameData.lastDiceRoll && gameData.lastDiceRoll[0] === gameData.lastDiceRoll[1];
            const doublesCount = currentPlayer.doublesCount || 0;
            
            // 3 doubles in a row = go to jail
            if (isDouble && doublesCount >= 3) {
                showModal('⚠️ Too Many Doubles!', 'You rolled doubles 3 times in a row! Go directly to jail!', [
                    {text: 'Go to Jail', class: 'bg-red-600', action: () => {
                        hideModal();
                        goToJail();
                    }}
                ]);
                return;
            }
            
            // 🎲 Check for doubles rule - allow another roll
            if (isDouble && doublesCount > 0 && doublesCount < 3 && gameData.settings.allowDoubles) {
                // Allow another roll!
                await updateGame({ 
                    turnState: 'start',
                    gameLog: [...gameData.gameLog, `🎲 ${currentPlayer.name} rolled DOUBLES! Rolling again...`]
                });
                
                setTimeout(() => {
                    showModal('🎲 DOUBLES!', `You rolled doubles (${gameData.lastDiceRoll[0]} + ${gameData.lastDiceRoll[1]})! You get to roll again!`, [
                        {text: '🎲 OK', class: 'bg-green-600 hover:bg-green-700', action: hideModal}
                    ]);
                }, 500);
                return;
            }
            
            await updateGame({ turnState: 'action_complete' });
        }
        
        async function addLog(message) {
            await updateGame({ gameLog: [...gameData.gameLog, message] });
        }

        function handleJailTurn() {
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            showModal('In Jail', `<p>You are in jail. What would you like to do?</p>`, [
                { text: 'Roll for Doubles', class: 'bg-blue-500', action: rollForJail },
                { text: 'Pay $50 Fine', class: 'bg-green-500', action: payJailFine, disabled: currentPlayer.money < 50 },
                // { text: 'Use Card', class: 'bg-yellow-500', action: useJailCard, disabled: currentPlayer.getOutOfJailCards < 1 }
            ]);
        }
        
        async function rollForJail() {
            hideModal();
            const die1 = Math.floor(Math.random() * 6) + 1;
            const die2 = Math.floor(Math.random() * 6) + 1;

            if (die1 === die2) {
                addLog(`${gameData.players[gameData.currentPlayerIndex].name} rolled doubles and got out of jail!`);
                const playersCopy = JSON.parse(JSON.stringify(gameData.players));
                playersCopy[gameData.currentPlayerIndex].inJail = false;
                await updateGame({ players: playersCopy });
                endTurn(); // Allows normal turn to proceed
            } else {
                addLog(`${gameData.players[gameData.currentPlayerIndex].name} failed to roll doubles.`);
                // In a full game, track jail turns and force payment after 3 turns.
                endTurn(); // Forfeit rest of turn
            }
        }
        
        async function payJailFine() {
            hideModal();
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            playersCopy[gameData.currentPlayerIndex].money -= 50;
            playersCopy[gameData.currentPlayerIndex].inJail = false;
            addLog(`${playersCopy[gameData.currentPlayerIndex].name} paid $50 to get out of jail.`);
            await updateGame({ players: playersCopy });
            endTurn();
        }

        managePropertiesBtn.addEventListener('click', () => {
             const currentPlayer = gameData.players[gameData.currentPlayerIndex];
             const ownedProperties = gameData.properties.filter(p => p.ownerId === currentPlayer.id);
             
             let modalHTML = '<div class="text-left max-h-96 overflow-y-auto">';
             if (ownedProperties.length === 0) {
                 modalHTML += '<p>You do not own any properties.</p>';
             } else {
                ownedProperties.forEach(prop => {
                    const space = gameData.settings.board[prop.spaceIndex];
                    if (space.type === 'property') {
                       const hasMonopoly = checkMonopoly(currentPlayer.id, space.color);
                       const canBuyHouse = hasMonopoly && currentPlayer.money >= space.houseCost && prop.houses < 5 && !prop.mortgaged;
                       const canSellHouse = prop.houses > 0;
                       const canMortgage = !prop.mortgaged && prop.houses === 0;
                       const canUnmortgage = prop.mortgaged && currentPlayer.money >= (space.price / 4);
                       
                       const mortgageValue = Math.floor(space.price / 4);
                       const houseSellPrice = Math.floor(space.houseCost * 0.75);
                       
                       modalHTML += `
                         <div class="p-3 border-b ${hasMonopoly ? 'bg-green-50' : 'bg-gray-50'} ${prop.mortgaged ? 'opacity-60 bg-red-50' : ''}">
                            <div class="mb-2">
                               <p class="font-bold" style="color:${space.color}">${space.name} ${prop.mortgaged ? '🔒 MORTGAGED' : ''}</p>
                               <p class="text-sm">Houses: ${prop.houses < 5 ? prop.houses : '🏨 Hotel'} | Value: $${space.price}</p>
                               ${!hasMonopoly ? '<p class="text-xs text-red-500">⚠️ Need all ' + space.color + ' properties</p>' : ''}
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <!-- Buy House/Hotel -->
                                <button onclick="event.stopPropagation(); window.buyHouse(${prop.spaceIndex})" 
                                    class="text-xs px-3 py-2 rounded ${canBuyHouse ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 cursor-not-allowed'} text-white" 
                                    ${!canBuyHouse ? 'disabled' : ''}>
                                    🏠 Buy ${prop.houses === 4 ? 'Hotel' : 'House'} ($${space.houseCost})
                                </button>
                                
                                <!-- Sell House -->
                                ${canSellHouse ? `
                                    <button onclick="event.stopPropagation(); window.sellHouse(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-orange-500 hover:bg-orange-600 text-white">
                                        🔨 Sell ${prop.houses === 5 ? 'Hotel' : 'House'} ($${houseSellPrice})
                                    </button>
                                ` : ''}
                                
                                <!-- Mortgage -->
                                ${canMortgage ? `
                                    <button onclick="event.stopPropagation(); window.mortgageProperty(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-red-500 hover:bg-red-600 text-white">
                                        🔒 Mortgage ($${mortgageValue})
                                    </button>
                                ` : ''}
                                
                                <!-- Unmortgage -->
                                ${canUnmortgage ? `
                                    <button onclick="event.stopPropagation(); window.unmortgageProperty(${prop.spaceIndex})" 
                                        class="text-xs px-3 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">
                                        🔓 Unmortgage ($${mortgageValue})
                                    </button>
                                ` : prop.mortgaged ? `
                                    <span class="text-xs text-gray-500">Need $${mortgageValue} to unmortgage</span>
                                ` : ''}
                            </div>
                         </div>`;
                    }
                });
             }
             modalHTML += '</div>';

             showModal('🏠 Manage Properties', modalHTML, [{text: 'Close', class: 'bg-gray-500', action: hideModal}]);
        });
        
        // 📊 View All Trades - Tüm tradeleri gör (kendi gizli tradelerini de)
        // 🃏 Joker Cards - Joker kartlarını göster ve kullan
        jokerCardsBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent click from bubbling to modal
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer || !myPlayer.jokerCards) {
                showModal('🃏 Joker Cards', '<p class="text-gray-600">You don\'t have any joker cards.</p>', [
                    {text: 'Close', class: 'bg-gray-500', action: hideModal}
                ]);
                return;
            }
            
            const jokers = myPlayer.jokerCards;
            let modalHTML = `
                <div class="text-left space-y-4">
                    <p class="text-sm text-gray-600 mb-4">Use your joker cards strategically to gain an advantage!</p>
                    
                    <!-- Kart Çalma Joker'i -->
                    <div class="border border-purple-300 rounded-lg p-4 bg-purple-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">💎 Steal Property</span>
                            <span class="bg-purple-600 text-white text-xs px-2 py-1 rounded">${jokers.steal || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Pay 3x the property's price to steal it from another player. The money goes to them.</p>
                        <button onclick="window.useJokerSteal()" ${jokers.steal > 0 ? '' : 'disabled'} 
                            class="w-full px-4 py-2 rounded ${jokers.steal > 0 ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-400'} text-white font-bold">
                            ${jokers.steal > 0 ? 'Use Steal Card' : 'No Cards Left'}
                        </button>
                    </div>
                    
                    <!-- Tur Atlama Joker'i -->
                    <div class="border border-red-300 rounded-lg p-4 bg-red-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">⏭️ Skip Player's Turn</span>
                            <span class="bg-red-600 text-white text-xs px-2 py-1 rounded">${jokers.skip || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Make another player skip their next turn.</p>
                        <button onclick="window.useJokerSkip()" ${jokers.skip > 0 ? '' : 'disabled'} 
                            class="w-full px-4 py-2 rounded ${jokers.skip > 0 ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400'} text-white font-bold">
                            ${jokers.skip > 0 ? 'Use Skip Card' : 'No Cards Left'}
                        </button>
                    </div>
                    
                    <!-- Zar Tekrar Atma Joker'i -->
                    <div class="border border-blue-300 rounded-lg p-4 bg-blue-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">🎲 Reroll Dice</span>
                            <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">${jokers.reroll || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Reroll your dice if you don't like the result. Use immediately after rolling.</p>
                        <button onclick="window.useJokerReroll()" ${jokers.reroll > 0 ? '' : 'disabled'} 
                            class="w-full px-4 py-2 rounded ${jokers.reroll > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400'} text-white font-bold">
                            ${jokers.reroll > 0 ? 'Use Reroll Card' : 'No Cards Left'}
                        </button>
                    </div>
                </div>
            `;
            
            showModal('🃏 Your Joker Cards', modalHTML, [
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ]);
        });
        
        // Check if player owns all properties of a color (monopoly)
        function checkMonopoly(playerId, color) {
            const colorProperties = gameData.settings.board
                .map((space, idx) => ({ ...space, idx }))
                .filter(space => space.type === 'property' && space.color === color);
            
            const ownedByPlayer = colorProperties.filter(space => {
                const prop = gameData.properties[space.idx];
                return prop && prop.ownerId === playerId;
            });
            
            return colorProperties.length === ownedByPlayer.length;
        }
        
        window.buyHouse = async (spaceIndex) => {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const space = gameData.settings.board[spaceIndex];
            
            // Double check monopoly
            if (!checkMonopoly(currentPlayer.id, space.color)) {
                alert('You must own all properties of this color to build!');
                return;
            }
            
            if (currentPlayer.money < space.houseCost) {
                alert('Not enough money!');
                return;
            }
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].houses++;
            playersCopy[currentPlayerIndex].money -= space.houseCost;
            
            const buildingType = propertiesCopy[spaceIndex].houses === 5 ? 'hotel' : 'house';
            await updateGame({ properties: propertiesCopy, players: playersCopy });
            addLog(`${playersCopy[currentPlayerIndex].name} built a ${buildingType} on ${space.name}.`);
            hideModal();
        }
        
        // 🔨 Sell House/Hotel
        window.sellHouse = async (spaceIndex) => {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const space = gameData.settings.board[spaceIndex];
            const property = gameData.properties[spaceIndex];
            
            if (property.houses === 0) {
                alert('No houses to sell!');
                return;
            }
            
            const sellPrice = Math.floor(space.houseCost * 0.75); // 3/4 of buy price
            const buildingType = property.houses === 5 ? 'hotel' : 'house';
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].houses--;
            playersCopy[currentPlayerIndex].money += sellPrice;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
            addLog(`${playersCopy[currentPlayerIndex].name} sold a ${buildingType} on ${space.name} for $${sellPrice}.`);
            hideModal();
        }
        
        // 🔒 Mortgage Property
        window.mortgageProperty = async (spaceIndex) => {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const space = gameData.settings.board[spaceIndex];
            const property = gameData.properties[spaceIndex];
            
            if (property.houses > 0) {
                alert('You must sell all houses before mortgaging!');
                return;
            }
            
            if (property.mortgaged) {
                alert('This property is already mortgaged!');
                return;
            }
            
            const mortgageValue = Math.floor(space.price / 4); // 1/4 of purchase price
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].mortgaged = true;
            playersCopy[currentPlayerIndex].money += mortgageValue;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
            addLog(`${playersCopy[currentPlayerIndex].name} mortgaged ${space.name} for $${mortgageValue}.`);
            hideModal();
        }
        
        // 🔓 Unmortgage Property
        window.unmortgageProperty = async (spaceIndex) => {
            const currentPlayerIndex = gameData.currentPlayerIndex;
            const currentPlayer = gameData.players[currentPlayerIndex];
            const space = gameData.settings.board[spaceIndex];
            const property = gameData.properties[spaceIndex];
            
            if (!property.mortgaged) {
                alert('This property is not mortgaged!');
                return;
            }
            
            const unmortgageValue = Math.floor(space.price / 4);
            
            if (currentPlayer.money < unmortgageValue) {
                alert(`Not enough money! You need $${unmortgageValue}.`);
                return;
            }
            
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            
            propertiesCopy[spaceIndex].mortgaged = false;
            playersCopy[currentPlayerIndex].money -= unmortgageValue;
            
            await updateGame({ properties: propertiesCopy, players: playersCopy });
            addLog(`${playersCopy[currentPlayerIndex].name} unmortgaged ${space.name} for $${unmortgageValue}.`);
            hideModal();
        }

        // --- JOKER CARD FUNCTIONS ---
        // 💎 Kart Çalma Joker'i
        window.useJokerSteal = () => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer.jokerCards || myPlayer.jokerCards.steal <= 0) {
                alert('You don\'t have any steal cards left!');
                return;
            }
            // Instead of closing the modal, re-render the joker modal after use
            // Diğer oyuncuların sahip olduğu kartları göster
            const otherPlayers = gameData.players.filter(p => p.id !== localPlayer.id && !p.bankrupt);
            let modalHTML = `
                <div class="text-left space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-sm text-gray-600 mb-3">Select a player and then select a property to steal. You'll pay 3x its price to that player.</p>
            `;
            otherPlayers.forEach(player => {
                const playerProperties = gameData.properties.filter(p => p.ownerId === player.id && !p.mortgaged);
                if (playerProperties.length > 0) {
                    modalHTML += `<div class="border rounded-lg p-3 bg-gray-50">
                        <h4 class="font-bold mb-2">${player.name}'s Properties:</h4>`;
                    playerProperties.forEach(prop => {
                        const space = gameData.settings.board[prop.spaceIndex];
                        const stealCost = space.price * 3;
                        const canAfford = myPlayer.money >= stealCost;
                        modalHTML += `
                            <button onclick=\"window.executeJokerSteal('${player.id}', ${prop.spaceIndex}, ${stealCost})\" 
                                ${canAfford ? '' : 'disabled'}
                                class=\"w-full text-left px-3 py-2 mb-2 rounded ${canAfford ? 'bg-purple-100 hover:bg-purple-200' : 'bg-gray-200'} border border-purple-300\">
                                <div class=\"font-semibold\">${space.name}</div>
                                <div class=\"text-xs text-gray-600\">Cost: $${stealCost} ${!canAfford ? '(Can\'t afford)' : ''}</div>
                            </button>
                        `;
                    });
                    modalHTML += `</div>`;
                }
            });
            modalHTML += `</div>`;
            showModal('💎 Steal Property', modalHTML, [
                {text: 'Back to Jokers', class: 'bg-gray-500', action: showJokerModal},
                {text: 'Cancel', class: 'bg-gray-400', action: hideModal}
            ], true);
        };
        
        window.executeJokerSteal = async (targetPlayerId, spaceIndex, cost) => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            const targetPlayer = gameData.players.find(p => p.id === targetPlayerId);
            const space = gameData.settings.board[spaceIndex];
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            const targetIndex = playersCopy.findIndex(p => p.id === targetPlayerId);
            
            // Para transferi
            playersCopy[myIndex].money -= cost;
            playersCopy[targetIndex].money += cost;
            
            // Kart çalma joker'ini azalt
            playersCopy[myIndex].jokerCards.steal -= 1;
            
            // Mülkiyet transferi
            propertiesCopy[spaceIndex].ownerId = localPlayer.id;
            
            await updateGame({ 
                players: playersCopy, 
                properties: propertiesCopy,
                gameLog: [...gameData.gameLog, `💎 ${myPlayer.name} used a Steal Card to take ${space.name} from ${targetPlayer.name} for $${cost}!`]
            });
            
            playSound('purchase');
            showModal('💎 Property Stolen!', `You successfully stole ${space.name} from ${targetPlayer.name} for $${cost}!`, [
                {text: 'OK', class: 'bg-purple-500', action: showJokerModal},
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ], true);
        };
        
        // ⏭️ Tur Atlama Joker'i
        window.useJokerSkip = () => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer.jokerCards || myPlayer.jokerCards.skip <= 0) {
                alert('You don\'t have any skip cards left!');
                return;
            }
            
            // Diğer oyuncuları göster
            const otherPlayers = gameData.players.filter(p => p.id !== localPlayer.id && !p.bankrupt);
            let modalHTML = `
                <div class="text-left space-y-2">
                    <p class="text-sm text-gray-600 mb-3">Select a player to skip their next turn:</p>
            `;
            otherPlayers.forEach(player => {
                modalHTML += `
                    <button onclick=\"window.executeJokerSkip('${player.id}')\" 
                        class=\"w-full text-left px-4 py-3 rounded bg-red-100 hover:bg-red-200 border border-red-300\">
                        <div class=\"font-semibold\">${player.name}</div>
                        <div class=\"text-xs text-gray-600\">They will miss their next turn</div>
                    </button>
                `;
            });
            modalHTML += `</div>`;
            showModal('⏭️ Skip Player Turn', modalHTML, [
                {text: 'Back to Jokers', class: 'bg-gray-500', action: showJokerModal},
                {text: 'Cancel', class: 'bg-gray-400', action: hideModal}
            ], true);
        };
        
        window.executeJokerSkip = async (targetPlayerId) => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            const targetPlayer = gameData.players.find(p => p.id === targetPlayerId);
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            const targetIndex = playersCopy.findIndex(p => p.id === targetPlayerId);
            
            // Skip joker'ini azalt
            playersCopy[myIndex].jokerCards.skip -= 1;
            
            // Hedef oyuncuya "skip" flag'i ekle
            playersCopy[targetIndex].skipNextTurn = true;
            
            await updateGame({ 
                players: playersCopy,
                gameLog: [...gameData.gameLog, `⏭️ ${myPlayer.name} used a Skip Card on ${targetPlayer.name}! They will miss their next turn!`]
            });
            
            showModal('⏭️ Turn Skipped!', `${targetPlayer.name} will miss their next turn!`, [
                {text: 'OK', class: 'bg-red-500', action: showJokerModal},
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ], true);
        };
        
        // 🎲 Zar Tekrar Atma Joker'i
        window.useJokerReroll = async () => {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer.jokerCards || myPlayer.jokerCards.reroll <= 0) {
                alert('You don\'t have any reroll cards left!');
                return;
            }
            
            // Zar henüz atılmadıysa uyar
            if (gameData.turnState !== 'action' && gameData.turnState !== 'action_complete') {
                alert('You can only use this card after rolling the dice!');
                return;
            }
            
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
            
            // Reroll joker'ini azalt
            playersCopy[myIndex].jokerCards.reroll -= 1;
            
            // Yeni zar değerleri
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            const total = dice1 + dice2;
            
            // Eski pozisyondan çık, yeni pozisyona git
            const oldPos = playersCopy[myIndex].position;
            let newPos = (oldPos + total) % gameData.settings.board.length;
            
            // Check if passed GO
            if (newPos < oldPos) {
                playersCopy[myIndex].money += gameData.settings.passGoBonus;
                await updateGame({ 
                    players: playersCopy,
                    gameLog: [...gameData.gameLog, `💰 ${myPlayer.name} passed GO! +$${gameData.settings.passGoBonus}`]
                });
            }
            
            playersCopy[myIndex].position = newPos;
            
            await updateGame({ 
                players: playersCopy,
                dice: { dice1, dice2 },
                turnState: 'action',
                gameLog: [...gameData.gameLog, `🎲 ${myPlayer.name} used a Reroll Card! New roll: ${dice1} + ${dice2} = ${total}`]
            });
            
            playSound('dice');
            hideModal();
            
            // Handle landing on new position
            handleLanding(newPos);
        };
        
        // Helper to re-show the joker modal with updated counts
        function showJokerModal() {
            const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
            if (!myPlayer || !myPlayer.jokerCards) {
                showModal('🃏 Joker Cards', '<p class="text-gray-600">You don\'t have any joker cards.</p>', [
                    {text: 'Close', class: 'bg-gray-500', action: hideModal}
                ]);
                return;
            }
            const jokers = myPlayer.jokerCards;
            let modalHTML = `
                <div class="text-left space-y-4">
                    <p class="text-sm text-gray-600 mb-4">Use your joker cards strategically to gain an advantage!</p>
                    <!-- Kart Çalma Joker'i -->
                    <div class="border border-purple-300 rounded-lg p-4 bg-purple-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">💎 Steal Property</span>
                            <span class="bg-purple-600 text-white text-xs px-2 py-1 rounded">${jokers.steal || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Pay 3x the property's price to steal it from another player. The money goes to them.</p>
                        <button onclick=\"window.useJokerSteal()\" ${jokers.steal > 0 ? '' : 'disabled'} 
                            class=\"w-full px-4 py-2 rounded ${jokers.steal > 0 ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-400'} text-white font-bold\">
                            ${jokers.steal > 0 ? 'Use Steal Card' : 'No Cards Left'}
                        </button>
                    </div>
                    <!-- Tur Atlama Joker'i -->
                    <div class="border border-red-300 rounded-lg p-4 bg-red-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">⏭️ Skip Player's Turn</span>
                            <span class="bg-red-600 text-white text-xs px-2 py-1 rounded">${jokers.skip || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Make another player skip their next turn.</p>
                        <button onclick=\"window.useJokerSkip()\" ${jokers.skip > 0 ? '' : 'disabled'} 
                            class=\"w-full px-4 py-2 rounded ${jokers.skip > 0 ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400'} text-white font-bold\">
                            ${jokers.skip > 0 ? 'Use Skip Card' : 'No Cards Left'}
                        </button>
                    </div>
                    <!-- Zar Tekrar Atma Joker'i -->
                    <div class="border border-blue-300 rounded-lg p-4 bg-blue-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-lg">🎲 Reroll Dice</span>
                            <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">${jokers.reroll || 0} left</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">Reroll your dice if you don't like the result. Use immediately after rolling.</p>
                        <button onclick=\"window.useJokerReroll()\" ${jokers.reroll > 0 ? '' : 'disabled'} 
                            class=\"w-full px-4 py-2 rounded ${jokers.reroll > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400'} text-white font-bold\">
                            ${jokers.reroll > 0 ? 'Use Reroll Card' : 'No Cards Left'}
                        </button>
                    </div>
                </div>
            `;
            showModal('🃏 Your Joker Cards', modalHTML, [
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ]);
        }

        // --- TRADE LOGIC ---
        // 🤝 Enhanced Trade System with Counter Offers and Pending Trades
        window.showTradeModal = (targetPlayerId) => {
            const me = gameData.players.find(p => p.id === localPlayer.id);
            const them = gameData.players.find(p => p.id === targetPlayerId);

            const myProperties = gameData.properties.filter(p => p.ownerId === me.id);
            const theirProperties = gameData.properties.filter(p => p.ownerId === them.id);

            let body = `
                <div id="trade-interface" class="grid grid-cols-2 gap-4 text-left">
                    <!-- My Offer -->
                    <div class="border-r pr-3">
                        <h4 class="font-bold text-center mb-3 text-blue-700">💼 Your Offer</h4>
                        <label class="block mb-2">
                            <span class="text-sm font-medium">Money:</span>
                            <input id="trade-my-money" type="number" min="0" max="${me.money}" value="0" class="w-full border-2 p-2 rounded-lg mt-1">
                            <span class="text-xs text-gray-500">Available: $${me.money}</span>
                        </label>
                        <div class="mt-2">
                            <p class="font-medium text-sm mb-2">Properties:</p>
                            <div class="space-y-1 max-h-48 overflow-y-auto">
                                ${myProperties.map(p => {
                                    const space = gameData.settings.board[p.spaceIndex];
                                    return `
                                        <label class="flex items-center gap-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                                            <input type="checkbox" class="my-prop-checkbox" value="${p.spaceIndex}">
                                            <span class="text-sm">${space.name}</span>
                                            <span class="text-xs text-gray-500 ml-auto">$${space.price}</span>
                                        </label>
                                    `;
                                }).join('') || '<p class="text-sm text-gray-500 italic">No properties owned</p>'}
                            </div>
                        </div>
                    </div>
                    <!-- Their Offer -->
                    <div class="pl-3">
                        <h4 class="font-bold text-center mb-3 text-green-700">🎁 Request From Them</h4>
                        <label class="block mb-2">
                            <span class="text-sm font-medium">Money:</span>
                            <input id="trade-their-money" type="number" min="0" max="${them.money}" value="0" class="w-full border-2 p-2 rounded-lg mt-1">
                            <span class="text-xs text-gray-500">They have: $${them.money}</span>
                        </label>
                        <div class="mt-2">
                            <p class="font-medium text-sm mb-2">Properties:</p>
                            <div class="space-y-1 max-h-48 overflow-y-auto">
                                ${theirProperties.map(p => {
                                    const space = gameData.settings.board[p.spaceIndex];
                                    return `
                                        <label class="flex items-center gap-2 p-2 hover:bg-green-50 rounded cursor-pointer">
                                            <input type="checkbox" class="their-prop-checkbox" value="${p.spaceIndex}">
                                            <span class="text-sm">${space.name}</span>
                                            <span class="text-xs text-gray-500 ml-auto">$${space.price}</span>
                                        </label>
                                    `;
                                }).join('') || '<p class="text-sm text-gray-500 italic">No properties owned</p>'}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Gizli Trade Seçeneği -->
                <div class="mt-4 p-3 bg-purple-50 border-2 border-purple-300 rounded-lg">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="trade-secret-checkbox" class="w-4 h-4">
                        <span class="font-semibold text-purple-800">🔒 Make this a secret trade</span>
                        <span class="text-xs text-purple-600">(${me.secretTradesAvailable || 0} secret trades available)</span>
                    </label>
                    <p class="text-xs text-gray-600 mt-2">Secret trades won't be visible to other players. You have ${me.secretTradesAvailable || 0} secret trade credits. Each one used (even if rejected) costs 1 credit.</p>
                </div>
            `;
            
            showModal(`🤝 Trade with ${them.name}`, body, [
                {text: '📤 Send Offer', class: 'bg-blue-600 hover:bg-blue-700', action: () => proposeTrade(targetPlayerId)},
                {text: 'Cancel', class: 'bg-gray-400 hover:bg-gray-500', action: hideModal}
            ]);
        }
        
        async function proposeTrade(targetPlayerId) {
             const offerMoney = parseInt(document.getElementById('trade-my-money').value) || 0;
             const requestMoney = parseInt(document.getElementById('trade-their-money').value) || 0;
             const isSecret = document.getElementById('trade-secret-checkbox')?.checked || false;
             
             const myPlayer = gameData.players.find(p => p.id === localPlayer.id);
             
             // Gizli trade kontrolü
             if (isSecret && (myPlayer.secretTradesAvailable || 0) <= 0) {
                 showModal('Not Enough Secret Trades', 'You don\'t have any secret trade credits left!', [
                     {text: 'OK', class:'bg-red-500', action: () => window.showTradeModal(targetPlayerId)}
                 ]);
                 return;
             }
             
             let offerProps = [];
             let requestProps = [];
             
             document.querySelectorAll('.my-prop-checkbox:checked').forEach(cb => {
                 offerProps.push(parseInt(cb.value));
             });
             
             document.querySelectorAll('.their-prop-checkbox:checked').forEach(cb => {
                 requestProps.push(parseInt(cb.value));
             });
             
             // Validation
             if (offerMoney === 0 && requestMoney === 0 && offerProps.length === 0 && requestProps.length === 0) {
                 showModal('Invalid Trade', 'You must offer or request something!', [{text: 'OK', class:'bg-red-500', action: () => window.showTradeModal(targetPlayerId)}]);
                 return;
             }
             
             // Gizli trade kullanıldıysa, hakkı azalt
             const playersCopy = JSON.parse(JSON.stringify(gameData.players));
             if (isSecret) {
                 const myIndex = playersCopy.findIndex(p => p.id === localPlayer.id);
                 playersCopy[myIndex].secretTradesAvailable = (playersCopy[myIndex].secretTradesAvailable || 0) - 1;
             }
             
             const tradeOffer = {
                 id: `trade_${Date.now()}`,
                 fromId: localPlayer.id,
                 toId: targetPlayerId,
                 offer: { money: offerMoney, properties: offerProps },
                 request: { money: requestMoney, properties: requestProps },
                 status: 'pending', // pending, accepted, rejected, countered, cancelled
                 timestamp: Date.now(),
                 isSecret: isSecret
             };
             
             // Add to trades array
             const trades = gameData.trades || [];
             trades.push(tradeOffer);
             
             await updateGame({ 
                 trades: trades,
                 players: playersCopy,
                 gameLog: [...(gameData.gameLog || []), `${isSecret ? '🔒' : '🤝'} ${myPlayer.name} sent a ${isSecret ? 'secret ' : ''}trade offer!`]
             });
             hideModal();
             
             const them = gameData.players.find(p => p.id === targetPlayerId);
             showModal("✅ Trade Sent!", `Your ${isSecret ? 'secret ' : ''}trade offer has been sent to ${them.name}. Waiting for response...`, [
                 {text: 'OK', class:'bg-green-500', action: hideModal}
             ]);
        }

        // � Declare Bankruptcy
        window.declareBankruptcy = () => {
            showModal('💥 İflas Et', 'İflas etmek istediğinizden emin misiniz? Bu işlem geri alınamaz ve oyun dışı kalacaksınız.', [
                {text: 'İptal', class: 'bg-gray-500', action: hideModal},
                {text: 'Evet, İflas Et', class: 'bg-red-600', action: () => {
                    sendMessage({
                        type: 'declare_bankruptcy',
                        playerId: localPlayer.id
                    });
                    hideModal();
                }}
            ]);
        }

        // �📬 Show Pending Trades Notification
        function checkPendingTrades() {
            if (!gameData || !gameData.trades) return;
            
            // Check for trades where I'm the receiver
            const incomingTrades = gameData.trades.filter(t => 
                t && t.id && t.toId === localPlayer.id && t.status === 'pending' && 
                !decidedLaterTrades.includes(t.id)
            );
            
            // Check for my outgoing trades
            const outgoingTrades = gameData.trades.filter(t => 
                t && t.id && t.fromId === localPlayer.id && t.status === 'pending'
            );
            
            if (incomingTrades.length > 0) {
                // Show notification badge or auto-show latest trade
                const latestTrade = incomingTrades[incomingTrades.length - 1];
                
                // Verify trade has all required fields before showing modal
                if (latestTrade && latestTrade.id && latestTrade.fromId && latestTrade.toId) {
                    showIncomingTradeModal(latestTrade);
                }
            }
        }

        // 📨 Show Incoming Trade Modal
        function showIncomingTradeModal(trade) {
            if (!trade || !trade.id || !trade.fromId || !trade.toId) {
                return;
            }
            
            const fromPlayer = gameData.players.find(p => p.id === trade.fromId);
            const me = gameData.players.find(p => p.id === localPlayer.id);
            
            if (!fromPlayer || !me) {
                return;
            }
            
            // If recipient is a bot, auto-decide on trade
            if (me.isBot) {
                botDecideTrade(trade);
                return;
            }
            
            const getPropertyNames = (indices) => {
                if (!indices || indices.length === 0) return '<span class="text-gray-500 italic">Nothing</span>';
                return indices.map(i => {
                    const space = gameData.settings.board[i];
                    return `<div class="text-sm">• ${space.name} ($${space.price})</div>`;
                }).join('');
            };

            let body = `
                <div class="text-left space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <h4 class="font-bold text-blue-800 mb-2">📤 ${fromPlayer.name} Offers You:</h4>
                        <div class="ml-2">
                            ${trade.offer.money > 0 ? `<div class="font-semibold text-green-700">💰 $${trade.offer.money}</div>` : ''}
                            ${getPropertyNames(trade.offer.properties)}
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <h4 class="font-bold text-green-800 mb-2">📥 In Exchange For:</h4>
                        <div class="ml-2">
                            ${trade.request.money > 0 ? `<div class="font-semibold text-red-700">💸 $${trade.request.money}</div>` : ''}
                            ${getPropertyNames(trade.request.properties)}
                        </div>
                    </div>
                </div>
            `;
            
            showModal(`🤝 Trade Offer from ${fromPlayer.name}`, body, [
                {text: '✅ Accept', class: 'bg-green-600 hover:bg-green-700', action: () => acceptTrade(trade.id)},
                {text: '🔄 Counter Offer', class: 'bg-yellow-600 hover:bg-yellow-700', action: () => counterTrade(trade)},
                {text: '❌ Reject', class: 'bg-red-600 hover:bg-red-700', action: () => rejectTrade(trade.id)},
                {text: '⏸️ Decide Later', class: 'bg-gray-400 hover:bg-gray-500', action: () => decideLaterTrade(trade.id)}
            ]);
        }

        // ✅ Accept Trade
        async function acceptTrade(tradeId) {
            // Get fresh copy of trades
            const trades = [...(gameData.trades || [])];
            const trade = trades.find(t => t && t.id === tradeId);
            
            if (!trade) {
                hideModal();
                showModal('Trade Not Found', 'This trade no longer exists. It may have been cancelled or already accepted.', [
                    {text: 'OK', class: 'bg-red-500', action: hideModal}
                ]);
                return;
            }
            
            if (!trade.fromId || !trade.toId) {
                console.error('Invalid trade data:', trade);
                hideModal();
                showModal('Invalid Trade', 'This trade has invalid data.', [
                    {text: 'OK', class: 'bg-red-500', action: hideModal}
                ]);
                return;
            }
            
            // Execute the trade
            const playersCopy = JSON.parse(JSON.stringify(gameData.players));
            const propertiesCopy = JSON.parse(JSON.stringify(gameData.properties));
            
            const fromPlayerIndex = playersCopy.findIndex(p => p && p.id === trade.fromId);
            const toPlayerIndex = playersCopy.findIndex(p => p && p.id === trade.toId);
            
            if (fromPlayerIndex === -1 || toPlayerIndex === -1) {
                hideModal();
                showModal('Player Not Found', 'One of the players in this trade no longer exists.', [
                    {text: 'OK', class: 'bg-red-500', action: hideModal}
                ]);
                return;
            }
            
            // Transfer money
            playersCopy[fromPlayerIndex].money -= trade.offer.money;
            playersCopy[toPlayerIndex].money += trade.offer.money;
            playersCopy[toPlayerIndex].money -= trade.request.money;
            playersCopy[fromPlayerIndex].money += trade.request.money;
            
            // Transfer properties
            (trade.offer.properties || []).forEach(propIndex => {
                if (propertiesCopy[propIndex]) {
                    propertiesCopy[propIndex].ownerId = trade.toId;
                    propertiesCopy[propIndex].houses = 0; // Reset houses
                }
            });
            
            (trade.request.properties || []).forEach(propIndex => {
                if (propertiesCopy[propIndex]) {
                    propertiesCopy[propIndex].ownerId = trade.fromId;
                    propertiesCopy[propIndex].houses = 0; // Reset houses
                }
            });
            
            // Remove trade from list
            const updatedTrades = trades.filter(t => t.id !== tradeId);
            
            const fromPlayer = gameData.players.find(p => p && p.id === trade.fromId);
            const toPlayer = gameData.players.find(p => p && p.id === trade.toId);
            
            await updateGame({
                players: playersCopy,
                properties: propertiesCopy,
                trades: updatedTrades,
                gameLog: [...gameData.gameLog, `🤝 ${toPlayer.name} accepted a trade from ${fromPlayer.name}!`]
            });
            
            hideModal();
            playSound('purchase');
            showModal('✅ Trade Completed!', 'The trade has been executed successfully!', [
                {text: 'OK', class: 'bg-green-500', action: hideModal}
            ]);
        }

        // ❌ Reject Trade
        async function rejectTrade(tradeId) {
            const trades = [...(gameData.trades || [])];
            const trade = trades.find(t => t && t.id === tradeId);
            
            if (!trade) {
                hideModal();
                showModal('Trade Not Found', 'This trade no longer exists.', [
                    {text: 'OK', class: 'bg-red-500', action: hideModal}
                ]);
                return;
            }
            
            const fromPlayer = gameData.players.find(p => p && p.id === trade.fromId);
            
            // Remove the trade
            const updatedTrades = trades.filter(t => t.id !== tradeId);
            
            await updateGame({
                trades: updatedTrades,
                gameLog: [...gameData.gameLog, `❌ Trade offer from ${fromPlayer ? fromPlayer.name : 'Unknown'} was rejected.`]
            });
            
            hideModal();
            showModal('Trade Rejected', 'You have rejected the trade offer.', [
                {text: 'OK', class: 'bg-red-500', action: hideModal}
            ]);
        }

        // ⏸️ Decide Later - Trade'i sakla ve modal'ı kapat
        function decideLaterTrade(tradeId) {
            if (!decidedLaterTrades.includes(tradeId)) {
                decidedLaterTrades.push(tradeId);
            }
            hideModal();
            addLog('You decided to review the trade offer later.');
        }

        // 🔄 Counter Trade
        function counterTrade(originalTrade) {
            hideModal();
            // Flip the trade and show modal for counter offer
            setTimeout(() => {
                window.showTradeModal(originalTrade.fromId);
                
                // Pre-fill with reverse of original trade (optional)
                setTimeout(() => {
                    const myMoneyInput = document.getElementById('trade-my-money');
                    const theirMoneyInput = document.getElementById('trade-their-money');
                    
                    if (myMoneyInput) myMoneyInput.value = originalTrade.request.money;
                    if (theirMoneyInput) theirMoneyInput.value = originalTrade.offer.money;
                    
                    originalTrade.request.properties.forEach(propIndex => {
                        const checkbox = document.querySelector(`.my-prop-checkbox[value="${propIndex}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    
                    originalTrade.offer.properties.forEach(propIndex => {
                        const checkbox = document.querySelector(`.their-prop-checkbox[value="${propIndex}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }, 200);
            }, 300);
        }

        // ⏸️ View My Pending Trades
        function viewPendingTrades() {
            if (!gameData || !gameData.trades) {
                showModal('No Trades', 'You have no pending trades.', [{text: 'OK', class: 'bg-gray-500', action: hideModal}]);
                return;
            }
            
            const sentTrades = gameData.trades.filter(t => t.fromId === localPlayer.id && t.status === 'pending');
            const receivedTrades = gameData.trades.filter(t => t.toId === localPlayer.id && t.status === 'pending');
            const completedTrades = gameData.trades.filter(t => t.status !== 'pending');
            
            // Tüm tradeleri göster
            const allVisibleTrades = [...sentTrades, ...receivedTrades, ...completedTrades.filter(t => {
                // Gizli trade ise ve ben dahil değilsem gösterme
                if (t.isSecret && t.fromId !== localPlayer.id && t.toId !== localPlayer.id) {
                    return false;
                }
                return true;
            })];
            
            if (allVisibleTrades.length === 0) {
                showModal('No Trades', 'No trades have been made yet.', [{text: 'OK', class: 'bg-gray-500', action: hideModal}]);
                return;
            }
            
            let tradesHTML = '';
            
            // 📤 Sent Trades
            if (sentTrades.length > 0) {
                tradesHTML += '<div class="mb-4"><h3 class="font-bold text-lg mb-2 text-blue-700">📤 Sent Trades</h3>';
                tradesHTML += sentTrades.map(trade => {
                    const toPlayer = gameData.players.find(p => p.id === trade.toId);
                    const getPropertyNames = (indices) => {
                        if (!indices || indices.length === 0) return 'Nothing';
                        return indices.map(i => gameData.settings.board[i].name).join(', ');
                    };
                    return `
                        <div class="border-2 border-blue-300 rounded-lg p-3 mb-2 bg-blue-50">
                            <div class="font-bold mb-1">To: ${toPlayer.name} ${trade.isSecret ? '🔒' : ''}</div>
                            <div class="text-xs text-gray-600 mt-1">
                                <div><b>You offer:</b> $${trade.offer.money}, ${getPropertyNames(trade.offer.properties)}</div>
                                <div><b>You want:</b> $${trade.request.money}, ${getPropertyNames(trade.request.properties)}</div>
                            </div>
                            <div class="text-sm text-gray-600">Sent: ${new Date(trade.timestamp).toLocaleTimeString()}</div>
                            <button onclick="event.stopPropagation(); window.cancelTrade('${trade.id}')" class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">
                                🗑️ Cancel
                            </button>
                        </div>
                    `;
                }).join('');
                tradesHTML += '</div>';
            }
            
            // 📥 Received Trades
            if (receivedTrades.length > 0) {
                tradesHTML += '<div class="mb-4"><h3 class="font-bold text-lg mb-2 text-green-700">📥 Received Trades</h3>';
                tradesHTML += receivedTrades.map(trade => {
                    const fromPlayer = gameData.players.find(p => p.id === trade.fromId);
                    const getPropertyNames = (indices) => {
                        if (!indices || indices.length === 0) return 'Nothing';
                        return indices.map(i => gameData.settings.board[i].name).join(', ');
                    };
                    return `
                        <div class="border-2 border-green-300 rounded-lg p-3 mb-2 bg-green-50">
                            <div class="font-bold mb-1">From: ${fromPlayer.name} ${trade.isSecret ? '🔒' : ''}</div>
                            <div class="text-xs text-gray-600 mt-1">
                                <div><b>They offer:</b> $${trade.offer.money}, ${getPropertyNames(trade.offer.properties)}</div>
                                <div><b>They want:</b> $${trade.request.money}, ${getPropertyNames(trade.request.properties)}</div>
                            </div>
                            <div class="text-sm text-gray-600">Received: ${new Date(trade.timestamp).toLocaleTimeString()}</div>
                            <button onclick="event.stopPropagation(); window.respondToTrade('${trade.id}')" class="mt-2 bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                👀 View & Respond
                            </button>
                        </div>
                    `;
                }).join('');
                tradesHTML += '</div>';
            }
            
            // 📊 Trade History
            if (completedTrades.length > 0) {
                const visibleCompletedTrades = completedTrades.filter(t => {
                    if (t.isSecret && t.fromId !== localPlayer.id && t.toId !== localPlayer.id) {
                        return false;
                    }
                    return true;
                });
                
                if (visibleCompletedTrades.length > 0) {
                    tradesHTML += '<div class="mb-4"><h3 class="font-bold text-lg mb-2 text-gray-700">📊 Trade History</h3>';
                    tradesHTML += visibleCompletedTrades.map(trade => {
                        const fromPlayer = gameData.players.find(p => p.id === trade.fromId);
                        const toPlayer = gameData.players.find(p => p.id === trade.toId);
                        
                        const statusBadge = trade.status === 'accepted' ? 
                            '<span class="bg-green-200 text-green-800 text-xs px-2 py-1 rounded">✅ Accepted</span>' :
                            '<span class="bg-red-200 text-red-800 text-xs px-2 py-1 rounded">❌ Rejected</span>';
                        
                        return `
                            <div class="border border-gray-300 rounded-lg p-2 mb-2 bg-gray-50">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">${fromPlayer?.name || 'Unknown'} → ${toPlayer?.name || 'Unknown'} ${trade.isSecret ? '🔒' : ''}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                        `;
                    }).join('');
                    tradesHTML += '</div>';
                }
            }
            
            showModal('🤝 All Trades', `<div class="max-h-96 overflow-y-auto">${tradesHTML}</div>`, [
                {text: 'Close', class: 'bg-gray-500', action: hideModal}
            ]);
        }
        
        // 👀 Respond to Trade from list
        window.respondToTrade = function(tradeId) {
            const trade = gameData.trades.find(t => t && t.id === tradeId);
            if (trade) {
                hideModal();
                setTimeout(() => showIncomingTradeModal(trade), 300);
            } else {
                hideModal();
                setTimeout(() => {
                    showModal('Trade Not Found', 'This trade no longer exists.', [
                        {text: 'OK', class: 'bg-red-500', action: hideModal}
                    ]);
                }, 100);
            }
        }

        // 🗑️ Cancel Trade
        window.cancelTrade = async function(tradeId) {
            const trades = [...(gameData.trades || [])];
            const tradeIndex = trades.findIndex(t => t.id === tradeId);
            if (tradeIndex === -1) return;
            
            trades.splice(tradeIndex, 1);
            
            await updateGame({
                trades: trades,
                gameLog: [...gameData.gameLog, `${localPlayer.name} cancelled a trade offer.`]
            });
            
            hideModal();
            showModal('Trade Cancelled', 'Your trade offer has been cancelled.', [
                {text: 'OK', class: 'bg-blue-500', action: hideModal}
            ]);
        }

        // --- MODAL ---
        function showModal(title, body, buttons = [], persistent = false) {
            // Clear any existing onclick handler first
            modal.onclick = null;
            
            modalTitle.textContent = title;
            modalBody.innerHTML = body;
            modalButtons.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `text-white font-bold py-2 px-4 rounded ${btnInfo.class} disabled:bg-gray-400`;
                button.onclick = (e) => {
                    e.stopPropagation(); // Prevent modal from closing
                    if (btnInfo.action) btnInfo.action();
                };
                if(btnInfo.disabled) button.disabled = true;
                modalButtons.appendChild(button);
            });
            
            // Show modal first
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            // Set onclick handler after modal is fully visible
            setTimeout(() => {
                // Eğer persistent değilse, modal dışına tıklanınca kapansın
                if (!persistent) {
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            hideModal();
                        }
                    };
                } else {
                    modal.onclick = null; // Persistent modal'da dışarıya tıklanınca kapanma
                }
            }, 300);
        }

        function hideModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250);
        }
        
        // --- PROPERTY BUY PANEL ---
        function showPropertyBuyPanel(position) {
            const space = gameData.settings.board[position];
            const currentPlayer = gameData.players[gameData.currentPlayerIndex];
            
            propertyBuyTitle.textContent = `🏡 Buy ${space.name}?`;
            propertyBuyName.textContent = space.name;
            propertyBuyDesc.innerHTML = `
                <p class="text-sm text-gray-600">This property is unowned. Choose your ownership share:</p>
                <p class="text-xs text-gray-500 mt-2">💡 Tip: Lower shares cost less but you'll share rental income and building rights.</p>
            `;
            
            // Clear previous options
            propertyBuyOptions.innerHTML = '';
            
            // Add share options
            const shareOptions = [
                { percentage: 100, label: '100% Full Ownership', class: 'bg-green-600 hover:bg-green-700' },
                { percentage: 75, label: '75% Majority', class: 'bg-green-500 hover:bg-green-600' },
                { percentage: 50, label: '50% Half', class: 'bg-green-400 hover:bg-green-500' },
                { percentage: 25, label: '25% Quarter', class: 'bg-green-300 hover:bg-green-400 text-gray-800' }
            ];
            
            shareOptions.forEach(option => {
                const cost = Math.floor(space.price * (option.percentage / 100));
                const canAfford = currentPlayer.money >= cost;
                
                const button = document.createElement('button');
                button.className = `w-full ${option.class} text-white font-bold py-3 px-4 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed`;
                button.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>${option.label}</span>
                        <span class="text-lg">$${cost}</span>
                    </div>
                `;
                button.disabled = !canAfford;
                button.onclick = () => {
                    buyPropertyWithShare(position, option.percentage);
                    hidePropertyBuyPanel();
                };
                
                propertyBuyOptions.appendChild(button);
            });
            
            // Add auction option
            const auctionButton = document.createElement('button');
            auctionButton.className = 'w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200';
            auctionButton.innerHTML = '🔨 Decline & Start Auction';
            auctionButton.onclick = () => {
                startAuction(position);
                hidePropertyBuyPanel();
            };
            propertyBuyOptions.appendChild(auctionButton);
            
            // Show panel with animation
            propertyBuyPanel.classList.remove('hidden');
            setTimeout(() => {
                propertyBuyPanel.style.opacity = '0';
                propertyBuyPanel.style.transform = 'translate(-50%, -50%) scale(0.8)';
                propertyBuyPanel.style.transition = 'all 0.3s ease-out';
                setTimeout(() => {
                    propertyBuyPanel.style.opacity = '1';
                    propertyBuyPanel.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 10);
            }, 10);
        }
        
        function hidePropertyBuyPanel() {
            propertyBuyPanel.style.opacity = '0';
            propertyBuyPanel.style.transform = 'translate(-50%, -50%) scale(0.8)';
            setTimeout(() => {
                propertyBuyPanel.classList.add('hidden');
            }, 300);
        }
        
        // Close button handler
        propertyBuyClose.addEventListener('click', () => {
            hidePropertyBuyPanel();
            // Optionally start auction if player doesn't buy
            // startAuction(currentPosition);
        });
        
        // --- UTILITIES ---
        async function updateGame(data) {
            sendMessage({
                type: 'update_game',
                gameId: currentGameId,
                updates: data
            });
        }

        function validatePlayerName() {
            addDebugLog('🔍 Validating name...');
            const name = playerNameInput.value.trim();
            addDebugLog('📝 Name value: "' + name + '" (length: ' + name.length + ')');
            
            if (name.length < 2 || name.length > 15) {
                lobbyError.textContent = 'Name must be between 2 and 15 characters.';
                addDebugLog('❌ Name length invalid: ' + name.length);
                return false;
            }
            
            let playerId = localStorage.getItem('monopolyPlayerId');
            if (!playerId) {
                try {
                    // Try crypto.randomUUID() first (modern browsers)
                    if (crypto && crypto.randomUUID) {
                        playerId = crypto.randomUUID();
                        addDebugLog('✅ UUID created (crypto)');
                    } else {
                        // Fallback for older browsers
                        playerId = 'player-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        addDebugLog('✅ UUID created (fallback)');
                    }
                    localStorage.setItem('monopolyPlayerId', playerId);
                    addDebugLog('✅ Player ID saved to localStorage');
                } catch (error) {
                    addDebugLog('❌ UUID ERROR: ' + error.message);
                    // Emergency fallback
                    playerId = 'player-' + Date.now();
                    addDebugLog('⚠️ Using emergency ID');
                }
            } else {
                addDebugLog('✅ Existing player ID found');
            }
            
            localPlayer = { id: playerId, name: name };
            lobbyError.textContent = '';
            addDebugLog('✅ Name validated: ' + name);
            return true;
        }

        function generateGameId() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }
        
        // Helper function to adjust color brightness
        function adjustColor(color, amount) {
            const clamp = (num) => Math.min(Math.max(num, 0), 255);
            const num = parseInt(color.replace("#", ""), 16);
            const r = clamp((num >> 16) + amount);
            const g = clamp(((num >> 8) & 0x00FF) + amount);
            const b = clamp((num & 0x0000FF) + amount);
            return "#" + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }
        
        copyGameIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(currentGameId).then(() => {
                const originalText = copyGameIdBtn.innerHTML;
                copyGameIdBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"></path></svg>`;
                setTimeout(() => { copyGameIdBtn.innerHTML = originalText; }, 2000);
            });
        });

        // Copy game link button event listener
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        if (copyLinkBtn) {
            copyLinkBtn.addEventListener('click', () => {
                const gameLinkInput = document.getElementById('gameLinkInput');
                if (gameLinkInput && gameLinkInput.value) {
                    navigator.clipboard.writeText(gameLinkInput.value).then(() => {
                        const originalText = copyLinkBtn.textContent;
                        copyLinkBtn.textContent = 'Copied!';
                        setTimeout(() => { copyLinkBtn.textContent = originalText; }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy link:', err);
                        copyLinkBtn.textContent = 'Error!';
                        setTimeout(() => { copyLinkBtn.textContent = originalText; }, 2000);
                    });
                }
            });
        }
        
        // Chat functions
        function addChatMessage(playerName, text, isOwn = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-2 rounded-lg max-w-xs break-words ${isOwn ? 'bg-blue-100 self-end ml-auto' : 'bg-white'}`;
            messageDiv.innerHTML = `<strong>${playerName}:</strong> ${text}`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const text = chatInput.value.trim();
            
            console.log('Chat attempt - text:', text, 'currentGameId:', currentGameId, 'localPlayer:', localPlayer, 'ws state:', ws ? ws.readyState : 'no ws');
            
            if (!text) {
                console.log('Chat: Empty message');
                return;
            }
            
            if (!currentGameId) {
                console.log('Chat: No currentGameId');
                addChatMessage('System', 'Please join a game first', false);
                return;
            }
            
            if (!localPlayer) {
                console.log('Chat: No localPlayer');
                addChatMessage('System', 'Please enter your name first', false);
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('Chat: WebSocket not connected');
                addChatMessage('System', 'Connection lost. Reconnecting...', false);
                connectWebSocket();
                return;
            }
            
            const message = {
                type: 'chat_message',
                gameId: currentGameId,
                playerName: localPlayer.name,
                text: text
            };
            console.log('Sending chat message:', message);
            
            try {
                sendMessage(message);
                addChatMessage(localPlayer.name, text, true);
                chatInput.value = '';
            } catch (error) {
                console.error('Chat send error:', error);
                addChatMessage('System', 'Failed to send message: ' + error.message, false);
            }
        }
        
        // Public games functions
        function loadPublicGames() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('WebSocket not connected, cannot load games');
                return;
            }
            
            sendMessage({ type: 'list_games' });
        }
        
        function displayPublicGames(games) {
            const gamesList = document.getElementById('public-games-list');
            if (!gamesList) return;
            
            if (games.length === 0) {
                gamesList.innerHTML = '<p class="text="text-gray-500 text-sm">No public games available</p>';
                return;
            }
            
            gamesList.innerHTML = '';
            
            games.forEach(game => {
                const gameDiv = document.createElement('div');
                gameDiv.className = 'bg-white p-3 rounded-lg border border-gray-200 hover:border-blue-300 cursor-pointer transition-colors';
                gameDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-gray-800">${game.gameId}</div>
                            <div class="text-sm text-gray-600">Host: ${game.hostName}</div>
                            <div class="text-xs text-gray-500">Map: ${game.map} • Players: ${game.playerCount}/${game.maxPlayers}</div>
                        </div>
                        <button class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors join-game-btn" data-game-id="${game.gameId}">
                            Join
                        </button>
                    </div>
                `;
                
                // Add click handler for join button
                const joinBtn = gameDiv.querySelector('.join-game-btn');
                joinBtn.addEventListener('click', () => {
                    document.getElementById('gameIdInput').value = game.gameId;
                    document.getElementById('joinGameBtn').click();
                });
                
                gamesList.appendChild(gameDiv);
            });
        }
        
        function init() {
            const storedName = localStorage.getItem('monopolyPlayerName');
            if (storedName) playerNameInput.value = storedName;
            
            playerNameInput.addEventListener('change', () => {
                localStorage.setItem('monopolyPlayerName', playerNameInput.value);
            });
            
            // 🔄 Check for stored game session (F5 protection)
            const storedGameId = localStorage.getItem('monopolyCurrentGameId');
            const storedPlayerId = localStorage.getItem('monopolyPlayerId');
            
            if (storedGameId && storedPlayerId) {
                console.log('🔄 Reconnecting to previous game:', storedGameId);
                currentGameId = storedGameId;
                localPlayer.id = storedPlayerId;
                // Auto-reconnect will happen after WebSocket connects
            }
            
            // Check URL parameters for auto-join
            const urlParams = new URLSearchParams(window.location.search);
            const autoJoinGameId = urlParams.get('gameId');
            if (autoJoinGameId) {
                gameIdInput.value = autoJoinGameId;
                // Auto-join will happen after WebSocket connects
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        // Check if we need to prompt for name/character
                        if (!playerNameInput.value.trim()) {
                            const name = prompt('Enter your name to join the game:');
                            if (name && name.trim()) {
                                playerNameInput.value = name.trim();
                                localStorage.setItem('monopolyPlayerName', name.trim());
                            } else {
                                return; // Cancel auto-join if no name provided
                            }
                        }
                        
                        if (!selectedCharacter) {
                            // Auto-select first available character
                            const availableCharacters = ['dog', 'car', 'ship', 'hat', 'thimble', 'boot', 'wheelbarrow', 'iron'];
                            selectedCharacter = availableCharacters[Math.floor(Math.random() * availableCharacters.length)];
                            // Update UI to show selected character
                            document.querySelectorAll('.character-option').forEach(option => {
                                if (option.dataset.character === selectedCharacter) {
                                    option.classList.add('ring-2', 'ring-blue-500');
                                } else {
                                    option.classList.remove('ring-2', 'ring-blue-500');
                                }
                            });
                        }
                        
                        joinGame();
                    }
                }, 1000);
            }
            
            // Load public games list
            loadPublicGames();
            
            // Refresh games button
            const refreshGamesBtn = document.getElementById('refreshGamesBtn');
            if (refreshGamesBtn) {
                refreshGamesBtn.addEventListener('click', loadPublicGames);
            }
            
            // Hide game-settings-only elements on initial load (lobby screen)
            const customizeTitle = document.getElementById('customize-board-title');
            const propertiesEditor = document.getElementById('properties-editor');
            const lobbyControls = document.getElementById('lobby-controls');
            const allowTradingContainer = document.getElementById('allow-trading-container');
            
            if (customizeTitle) customizeTitle.style.display = 'none';
            if (propertiesEditor) propertiesEditor.style.display = 'none';
            if (lobbyControls) lobbyControls.style.display = 'none';
            if (allowTradingContainer) allowTradingContainer.style.display = 'none';
            
            // Chat event listeners
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            
            if (chatInput && chatSendBtn) {
                chatSendBtn.addEventListener('click', sendChatMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            // Game link copy button event listener (desktop)
            const copyGameLinkBtn = document.getElementById('copy-game-link-btn');
            if (copyGameLinkBtn) {
                copyGameLinkBtn.addEventListener('click', () => {
                    const gameLinkInput = document.getElementById('game-link-input');
                    if (gameLinkInput && gameLinkInput.value) {
                        navigator.clipboard.writeText(gameLinkInput.value).then(() => {
                            const originalText = copyGameLinkBtn.innerHTML;
                            copyGameLinkBtn.innerHTML = '✅';
                            setTimeout(() => { copyGameLinkBtn.innerHTML = originalText; }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy game link:', err);
                            copyGameLinkBtn.innerHTML = '❌';
                            setTimeout(() => { copyGameLinkBtn.innerHTML = originalText; }, 2000);
                        });
                    }
                });
            }
            
            // Game link copy button event listener (mobile)
            const copyGameLinkBtnMobile = document.getElementById('copy-game-link-btn-mobile');
            if (copyGameLinkBtnMobile) {
                copyGameLinkBtnMobile.addEventListener('click', () => {
                    const gameLinkInputMobile = document.getElementById('game-link-input-mobile');
                    if (gameLinkInputMobile && gameLinkInputMobile.value) {
                        navigator.clipboard.writeText(gameLinkInputMobile.value).then(() => {
                            const originalText = copyGameLinkBtnMobile.innerHTML;
                            copyGameLinkBtnMobile.innerHTML = '✅';
                            setTimeout(() => { copyGameLinkBtnMobile.innerHTML = originalText; }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy game link:', err);
                            copyGameLinkBtnMobile.innerHTML = '❌';
                            setTimeout(() => { copyGameLinkBtnMobile.innerHTML = originalText; }, 2000);
                        });
                    }
                });
            }
            
            // Initialize WebSocket connection
            connectWebSocket();
        }
        
        init();

    </script>

    <!-- Game Management Modal -->
    <div id="gameManagementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Game Management</h3>
            <p id="managementPlayerName" class="mb-4"></p>
            <button id="kickPlayerBtn" class="w-full bg-red-500 text-white p-2 rounded mb-2">Kick Player</button>
            <button id="forceEndTurnBtn" class="w-full bg-yellow-500 text-white p-2 rounded mb-2">Force End Turn</button>
            <button id="forceRollDiceBtn" class="w-full bg-blue-500 text-white p-2 rounded mb-4">Force Roll Dice</button>
            <button id="closeManagementModal" class="w-full bg-gray-500 text-white p-2 rounded">Close</button>
        </div>
    </div>

</body>
</html>

